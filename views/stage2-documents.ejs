<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 2: Document Upload - Proposal #<%= proposal.id %></title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/proposal.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Stage 2: Document Upload & Proposal Perfection</h1>
            <p class="subtitle">Proposal ID: #<%= proposal.id %> | Applicant: <%= proposal.applicantName || proposal.customerName %></p>
        </header>

        <div class="progress-tracker">
            <div class="progress-step completed">
                <div class="step-number">1</div>
                <div class="step-label">Proposal</div>
            </div>
            <div class="progress-step active">
                <div class="step-number">2</div>
                <div class="step-label">Documents</div>
            </div>
            <div class="progress-step">
                <div class="step-number">3</div>
                <div class="step-label">Profiling</div>
            </div>
            <div class="progress-step">
                <div class="step-number">4</div>
                <div class="step-label">Banker Match</div>
            </div>
        </div>

        <div class="stage2-container">
            <!-- Customer Summary -->
            <div class="customer-summary card">
                <h2>Customer Summary</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Applicant Name:</span>
                        <span class="value"><%= proposal.applicantName || proposal.customerName %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Applicant Type:</span>
                        <span class="value"><%= proposal.applicantType || proposal.customerType %></span>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                        <div class="summary-item">
                            <span class="label">Co-Applicants:</span>
                            <span class="value">
                                <%= proposal.coApplicants.map(ca => ca.name).join(', ') %>
                            </span>
                        </div>
                    <% } %>
                    <div class="summary-item">
                        <span class="label">Loan Amount:</span>
                        <span class="value">‚Çπ<%= proposal.loanAmount ? parseInt(proposal.loanAmount).toLocaleString('en-IN') : 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Loan Type:</span>
                        <span class="value"><%= proposal.typeOfLoan || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Nature:</span>
                        <span class="value"><%= proposal.natureOfLoan || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Collateral:</span>
                        <span class="value"><%= proposal.natureOfCollateral || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Industry:</span>
                        <span class="value"><%= proposal.industry || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Annual Revenue:</span>
                        <span class="value"><%= proposal.annualRevenue || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Contact:</span>
                        <span class="value"><%= proposal.email %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Submitted:</span>
                        <span class="value"><%= new Date(proposal.createdAt).toLocaleDateString() %></span>
                    </div>
                </div>
            </div>

            <!-- Document Statistics Section -->
            <div class="document-statistics card">
                <h2>üìä Document Summary</h2>
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-label">Total Documents Uploaded</div>
                        <div class="stat-value"><%= uploadedFiles.length %></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Categorised</div>
                        <div class="stat-value categorised"><%= uploadedFiles.filter(f => f.category).length %></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Not Categorised</div>
                        <div class="stat-value not-categorised"><%= uploadedFiles.filter(f => !f.category).length %></div>
                    </div>
                </div>
            </div>

            <!-- Bulk Upload Section -->
            <div class="bulk-upload-section card">
                <h2>üì§ Bulk Upload</h2>
                <p class="upload-instructions">Upload zip, PDF, JPG, XLS, doc</p>
                <form id="bulkUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <div class="file-input-wrapper">
                            <input type="file" id="bulkDocuments" name="bulkDocuments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip">
                            <div class="file-input-display">
                                <span class="file-icon">üìé</span>
                                <span class="file-text">Choose files or drag here</span>
                            </div>
                        </div>
                    </div>
                    <div id="bulkFilePreview" class="file-preview"></div>
                    <button type="submit" class="btn btn-primary">
                        <span class="upload-icon">‚¨ÜÔ∏è</span> Upload Files
                    </button>
                </form>
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="progress-text">Uploading and processing documents...</p>
                </div>
            </div>

            <!-- Required Documents Section -->
            <div class="required-documents card">
                <h2>üìã Required Documents</h2>
                
                <!-- Personal ID -->
                <div class="doc-category">
                    <h3 class="category-title">Personal ID - only for individual applicant or coapplicants</h3>
                    <ul class="doc-list">
                        <% if (proposal.applicantType === 'Individual') { %>
                            <li>PAN Card of <%= proposal.applicantName || proposal.customerName %></li>
                            <li>Aadhar Card of <%= proposal.applicantName || proposal.customerName %></li>
                        <% } %>
                        <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <% if (co.type === 'Individual') { %>
                                    <li>PAN Card of <%= co.name %></li>
                                    <li>Aadhar Card of <%= co.name %></li>
                                <% } %>
                            <% }); %>
                        <% } %>
                    </ul>
                </div>

                <!-- Business ID (only for non-individual) -->
                <% if (proposal.applicantType !== 'Individual') { %>
                <div class="doc-category">
                    <h3 class="category-title">Business ID - only for non individual</h3>
                    <ul class="doc-list">
                        <li>PAN Card of <%= proposal.applicantName || 'Applicant Name' %> (Non Individual)</li>
                        <li>GST Certificate of <%= proposal.applicantName || 'Applicant Name' %></li>
                        <li>Labour License of <%= proposal.applicantName || 'Applicant Name' %></li>
                        <li>UDYAM Certificate of <%= proposal.applicantName || 'Applicant Name' %></li>
                    </ul>
                </div>
                <% } %>

                <!-- Incorporation -->
                <div class="doc-category">
                    <h3 class="category-title">Incorporation</h3>
                    <% if (proposal.applicantType === 'Partnership') { %>
                    <div class="doc-subcategory">
                        <h4>For Partnership</h4>
                        <ul class="doc-list">
                            <li>Partnership deed
                                <ul style="margin-left: 20px; margin-top: 5px; font-size: 0.9em; color: #7f8c8d;">
                                    <li>Date of the deed</li>
                                    <li>Profit & Loss share of each partner</li>
                                </ul>
                            </li>
                            <li>Reconstituted partnership deed
                                <ul style="margin-left: 20px; margin-top: 5px; font-size: 0.9em; color: #7f8c8d;">
                                    <li>Date of the deed</li>
                                    <li>Profit & Loss share of each partner</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <% } %>
                    <% if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') { %>
                    <div class="doc-subcategory">
                        <h4>For Private Limited or Public Limited</h4>
                        <ul class="doc-list">
                            <li>Certificate of Incorporation</li>
                            <li>Memorandum of Association</li>
                            <li>Articles of Association</li>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Credit Reports -->
                <div class="doc-category">
                    <h3 class="category-title">Credit Reports</h3>
                    <ul class="doc-list">
                        <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>Personal Credit Report of <%= co.name %> (only for individuals)</li>
                            <% }); %>
                        <% } %>
                        <li>Business Credit Report of <%= proposal.applicantName %> (Non Individual)</li>
                    </ul>
                </div>

                <!-- Financials -->
                <div class="doc-category">
                    <h3 class="category-title">Financials</h3>
                    <div class="doc-subcategory">
                        <h4>Business</h4>
                        <ul class="doc-list">
                            <li>ITR of Current Year of (<%= proposal.applicantName %>)</li>
                            <li>ITR of Previous Year of (<%= proposal.applicantName %>)</li>
                            <li>ITR of Preceding previous year of (<%= proposal.applicantName %>)</li>
                        </ul>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                    <div class="doc-subcategory">
                        <h4>Personal</h4>
                        <ul class="doc-list">
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>ITR of Current Year (<%= co.name || 'CoApplicant ' + (idx + 1) %>)</li>
                                <li>ITR of Previous Year of (<%= co.name || 'coApplicant' + (idx + 1) + ' name' %>)</li>
                                <li>ITR of Preceding previous year of (<%= co.name || 'coApplicant' + (idx + 1) + ' name' %>)</li>
                            <% }); %>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Banking -->
                <div class="doc-category">
                    <h3 class="category-title">Banking</h3>
                    <div class="doc-subcategory">
                        <h4>Business</h4>
                        <ul class="doc-list">
                            <li>Bank Statement of <%= proposal.applicantName %></li>
                            <li>Overdraft Bank Statement of <%= proposal.applicantName %></li>
                        </ul>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                    <div class="doc-subcategory">
                        <h4>Personal</h4>
                        <ul class="doc-list">
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>Bank Statement of <%= co.name || 'Coapplicant Name' + (idx + 1) %></li>
                            <% }); %>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Turnover -->
                <div class="doc-category">
                    <h3 class="category-title">Turnover</h3>
                    <ul class="doc-list">
                        <li>GST 3B returns for last 12 months</li>
                        <li>GST 1 returns for last 12 months</li>
                    </ul>
                </div>

                <!-- Debt Profile -->
                <div class="doc-category">
                    <h3 class="category-title">Debt Profile</h3>
                    <ul class="doc-list">
                        <li>All Existing Loan Details</li>
                    </ul>
                </div>

                <!-- Collateral -->
                <div class="doc-category">
                    <h3 class="category-title">Collateral</h3>
                    <ul class="doc-list">
                        <li>Title Documents</li>
                        <li>Tax paid Receipts</li>
                        <li>Approved Sanction Plan</li>
                        <li>Encumberance Certificate</li>
                        <li>Title Documents - Unregistered</li>
                    </ul>
                </div>

                <p class="categorization-note">All uploaded documents needs to be categorised into below tabs</p>
            </div>

            <!-- Document Management Section with Main Tabs -->
            <div class="documents-management card">
                <h2>üìÅ Document Management</h2>
                
                <!-- Main Tab Navigation (Uploaded vs Pending) -->
                <div class="main-tab-navigation">
                    <button class="main-tab-btn active" onclick="showMainTab('uploaded')">
                        üì§ Uploaded Documents (<span id="fileCount"><%= uploadedFiles.length %></span>)
                    </button>
                    <button class="main-tab-btn" onclick="showMainTab('pending')">
                        ‚ö†Ô∏è Pending Documents
                    </button>
                </div>

                <!-- Uploaded Documents Section -->
                <div id="uploadedSection" class="main-tab-content">
                    <!-- Sub-Tab Navigation for Uploaded -->
                    <div class="tab-navigation">
                        <button class="tab-btn active" onclick="showTab('all')">ALL</button>
                        <button class="tab-btn" onclick="showTab('personalId')">Personal ID</button>
                        <button class="tab-btn" onclick="showTab('businessId')">Business ID</button>
                        <button class="tab-btn" onclick="showTab('incorporation')">Incorporation</button>
                        <button class="tab-btn" onclick="showTab('creditReports')">Credit Reports</button>
                        <button class="tab-btn" onclick="showTab('financials')">Financials</button>
                        <button class="tab-btn" onclick="showTab('banking')">Banking</button>
                        <button class="tab-btn" onclick="showTab('turnover')">Turnover</button>
                        <button class="tab-btn" onclick="showTab('debtProfile')">Debt Profile</button>
                        <button class="tab-btn" onclick="showTab('collateral')">Collateral</button>
                    </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <% if (uploadedFiles.length === 0) { %>
                        <div class="empty-state-small">
                            <p>No documents uploaded yet</p>
                        </div>
                    <% } else { %>
                        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
                            <span id="selectedCount">0</span> document(s) selected
                            <button class="btn btn-danger" onclick="deleteSelectedDocuments()">üóëÔ∏è Delete Selected</button>
                        </div>
                        <div class="files-table-wrapper">
                            <table class="files-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll(this)"></th>
                                        <th>Category</th>
                                        <th>File Name</th>
                                        <th>Size</th>
                                        <th>Pages</th>
                                        <th>Uploaded</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="filesTableBody">
                                    <% uploadedFiles.forEach(file => { %>
                                        <tr data-category="<%= file.category || 'all' %>">
                                            <td><input type="checkbox" class="doc-checkbox" value="<%= file.id %>" onchange="updateBulkActions()"></td>
                                            <td>
                                                <span class="badge"><%= file.category || 'Uncategorized' %></span>
                                            </td>
                                            <td>
                                                <span class="file-icon-small">
                                                    <%= file.originalName.endsWith('.pdf') ? 'üìÑ' : file.originalName.match(/\.(jpg|jpeg|png)$/i) ? 'üñºÔ∏è' : 'üìù' %>
                                                </span>
                                                <%= file.originalName %>
                                            </td>
                                            <td><%= file.size %></td>
                                            <td><%= file.pages ? file.pages : 'N/A' %></td>
                                            <td><%= new Date(file.uploadedAt).toLocaleString() %></td>
                                            <td><span class="badge badge-success">‚úì Uploaded</span></td>
                                            <td class="actions-cell">
                                                <button class="btn-view" 
                                                    onmouseenter="showPreview('<%= file.filename %>', '<%= file.originalName %>', '<%= proposalId %>', event)" 
                                                    onmouseleave="scheduleHidePreview()"
                                                    title="View document">
                                                    üëÅÔ∏è
                                                </button>
                                                <select class="category-select" onchange="updateCategory('<%= file.id %>', this.value)">
                                                    <option value="">Categorize...</option>
                                                    <option value="personalId" <%= file.category === 'personalId' ? 'selected' : '' %>>Personal ID</option>
                                                    <option value="businessId" <%= file.category === 'businessId' ? 'selected' : '' %>>Business ID</option>
                                                    <option value="incorporation" <%= file.category === 'incorporation' ? 'selected' : '' %>>Incorporation</option>
                                                    <option value="creditReports" <%= file.category === 'creditReports' ? 'selected' : '' %>>Credit Reports</option>
                                                    <option value="financials" <%= file.category === 'financials' ? 'selected' : '' %>>Financials</option>
                                                    <option value="banking" <%= file.category === 'banking' ? 'selected' : '' %>>Banking</option>
                                                    <option value="turnover" <%= file.category === 'turnover' ? 'selected' : '' %>>Turnover</option>
                                                    <option value="debtProfile" <%= file.category === 'debtProfile' ? 'selected' : '' %>>Debt Profile</option>
                                                    <option value="collateral" <%= file.category === 'collateral' ? 'selected' : '' %>>Collateral</option>
                                                </select>
                                                <button class="btn-delete" 
                                                    onclick="deleteDocument('<%= file.id %>', '<%= file.originalName %>')"
                                                    title="Delete document">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Document Preview Popup -->
                        <div id="documentPreview" class="document-preview-popup" style="display: none;" 
                             onmouseenter="cancelHidePreview()" 
                             onmouseleave="hidePreview()">
                            <div class="preview-content">
                                <button class="preview-close" onclick="hidePreview()">‚úï</button>
                                <div id="previewLoader" class="preview-loader">Loading preview...</div>
                                <iframe id="previewFrame" style="display: none;"></iframe>
                                <img id="previewImage" style="display: none;" alt="Document preview">
                                <div id="previewText" style="display: none;"></div>
                            </div>
                        </div>
                    <% } %>
                    </div>
                </div>

                <!-- Pending Documents Section -->
                <div id="pendingSection" class="main-tab-content" style="display: none;">
                    <!-- Sub-Tab Navigation for Pending -->
                    <div class="tab-navigation">
                        <% 
                        // Helper function to check if a document type is uploaded in a category
                        function isDocumentUploaded(category) {
                            return uploadedFiles.some(file => file.category === category);
                        }

                        // Get count of documents in a specific category
                        function getUploadedCountInCategory(category) {
                            return uploadedFiles.filter(file => file.category === category).length;
                        }

                        // Categorize pending documents based on what's NOT uploaded
                        const pendingByCategory = {
                            personalId: [],
                            businessId: [],
                            incorporation: [],
                            creditReports: [],
                            financials: [],
                            banking: [],
                            turnover: [],
                            debtProfile: [],
                            collateral: []
                        };

                        // Count uploaded documents by category
                        const uploadedPersonalIdCount = getUploadedCountInCategory('personalId');
                        
                        // Personal ID documents - check for each individual
                        let requiredPersonalIdCount = 0;
                        if (proposal.applicantType === 'Individual') {
                            requiredPersonalIdCount += 2; // PAN + Aadhar for applicant
                        }
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach(co => {
                                if (co.type === 'Individual') {
                                    requiredPersonalIdCount += 2; // PAN + Aadhar for each individual co-applicant
                                }
                            });
                        }

                        // Add pending personal ID docs
                        if (uploadedPersonalIdCount < requiredPersonalIdCount) {
                            if (proposal.applicantType === 'Individual') {
                                pendingByCategory.personalId.push('PAN Card of ' + (proposal.applicantName || proposal.customerName));
                                pendingByCategory.personalId.push('Aadhar Card of ' + (proposal.applicantName || proposal.customerName));
                            }
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Individual') {
                                        pendingByCategory.personalId.push('PAN Card of ' + co.name);
                                        pendingByCategory.personalId.push('Aadhar Card of ' + co.name);
                                    }
                                });
                            }
                        }

                        // Business ID (only for non-individual)
                        if (proposal.applicantType !== 'Individual' && getUploadedCountInCategory('businessId') === 0) {
                            pendingByCategory.businessId.push('PAN Card of ' + (proposal.applicantName || 'Applicant Name') + ' (Non Individual)');
                            pendingByCategory.businessId.push('GST Certificate of ' + (proposal.applicantName || 'Applicant Name'));
                            pendingByCategory.businessId.push('Labour License of ' + (proposal.applicantName || 'Applicant Name'));
                            pendingByCategory.businessId.push('UDYAM Certificate of ' + (proposal.applicantName || 'Applicant Name'));
                        }

                        // Incorporation - Always show for Partnership to display required details
                        if (proposal.applicantType === 'Partnership') {
                            // Always show partnership deed requirements with details to extract
                            pendingByCategory.incorporation.push('Partnership deed - Date of deed, Profit & Loss share of partners');
                            pendingByCategory.incorporation.push('Reconstituted partnership deed - Date of deed, Profit & Loss share of partners');
                        } else if (!isDocumentUploaded('incorporation')) {
                            // For other types, only show if not uploaded
                            if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') {
                                pendingByCategory.incorporation.push('Certificate of Incorporation');
                                pendingByCategory.incorporation.push('Memorandum of Association');
                                pendingByCategory.incorporation.push('Articles of Association');
                            }
                        }

                        // Credit Reports
                        if (!isDocumentUploaded('creditReports')) {
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Individual') {
                                        pendingByCategory.creditReports.push('Personal Credit Report of ' + co.name);
                                    }
                                });
                            }
                            if (proposal.applicantType !== 'Individual') {
                                pendingByCategory.creditReports.push('Business Credit Report of ' + proposal.applicantName);
                            }
                        }

                        // Financials
                        if (!isDocumentUploaded('financials')) {
                            pendingByCategory.financials.push('ITR of Current Year of ' + proposal.applicantName);
                            pendingByCategory.financials.push('ITR of Previous Year of ' + proposal.applicantName);
                            pendingByCategory.financials.push('ITR of Preceding previous year of ' + proposal.applicantName);
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Individual') {
                                        pendingByCategory.financials.push('ITR of Current Year of ' + (co.name || 'CoApplicant ' + (idx + 1)));
                                        pendingByCategory.financials.push('ITR of Previous Year of ' + (co.name || 'coApplicant' + (idx + 1) + ' name'));
                                        pendingByCategory.financials.push('ITR of Preceding previous year of ' + (co.name || 'coApplicant' + (idx + 1) + ' name'));
                                    }
                                });
                            }
                        }

                        // Banking
                        if (!isDocumentUploaded('banking')) {
                            pendingByCategory.banking.push('Bank Statement of ' + proposal.applicantName);
                            pendingByCategory.banking.push('Overdraft Bank Statement of ' + proposal.applicantName);
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Individual') {
                                        pendingByCategory.banking.push('Bank Statement of ' + (co.name || 'Coapplicant Name' + (idx + 1)));
                                    }
                                });
                            }
                        }

                        // Turnover
                        if (!isDocumentUploaded('turnover')) {
                            pendingByCategory.turnover.push('GST 3B returns for last 12 months');
                            pendingByCategory.turnover.push('GST 1 returns for last 12 months');
                        }

                        // Debt Profile
                        if (!isDocumentUploaded('debtProfile')) {
                            pendingByCategory.debtProfile.push('All Existing Loan Details');
                        }

                        // Collateral
                        if (!isDocumentUploaded('collateral')) {
                            pendingByCategory.collateral.push('Title Documents');
                            pendingByCategory.collateral.push('Tax paid Receipts');
                            pendingByCategory.collateral.push('Approved Sanction Plan');
                            pendingByCategory.collateral.push('Encumberance Certificate');
                            pendingByCategory.collateral.push('Title Documents - Unregistered');
                        }

                        // Calculate all pending documents
                        let allPending = [];
                        Object.keys(pendingByCategory).forEach(cat => {
                            allPending = allPending.concat(pendingByCategory[cat]);
                        });
                        %>
                        <button class="tab-btn-pending active" onclick="showPendingTab('all')">ALL (<%= allPending.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('personalId')">Personal ID (<%= pendingByCategory.personalId.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('businessId')">Business ID (<%= pendingByCategory.businessId.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('incorporation')">Incorporation (<%= pendingByCategory.incorporation.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('creditReports')">Credit Reports (<%= pendingByCategory.creditReports.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('financials')">Financials (<%= pendingByCategory.financials.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('banking')">Banking (<%= pendingByCategory.banking.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('turnover')">Turnover (<%= pendingByCategory.turnover.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('debtProfile')">Debt Profile (<%= pendingByCategory.debtProfile.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('collateral')">Collateral (<%= pendingByCategory.collateral.length %>)</button>
                    </div>
                
                    <!-- Pending Documents Content -->
                    <div id="pendingTabContent" class="pending-tab-content">

                    <% if (allPending.length === 0) { %>
                        <div class="success-message">
                            ‚úì All required documents have been uploaded!
                        </div>
                    <% } else { %>
                        <!-- All Pending -->
                        <div class="pending-category-content" data-pending-category="all">
                            <ul class="pending-list">
                                <% allPending.forEach(doc => { %>
                                    <li class="pending-item">
                                        <span class="warning-icon">‚ö†Ô∏è</span>
                                        <%= doc %>
                                    </li>
                                <% }); %>
                            </ul>
                        </div>

                        <!-- Personal ID Pending -->
                        <div class="pending-category-content" data-pending-category="personalId" style="display: none;">
                            <% if (pendingByCategory.personalId.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.personalId.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Personal ID documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Business ID Pending -->
                        <div class="pending-category-content" data-pending-category="businessId" style="display: none;">
                            <% if (pendingByCategory.businessId.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.businessId.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Business ID documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Incorporation Pending -->
                        <div class="pending-category-content" data-pending-category="incorporation" style="display: none;">
                            <% if (pendingByCategory.incorporation.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.incorporation.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Incorporation documents uploaded!</p>
                            <% } %>
                            
                            <!-- Show extracted details from uploaded partnership deeds -->
                            <% 
                            const incorporationDocs = uploadedFiles.filter(f => f.category === 'incorporation');
                            if (incorporationDocs.length > 0 && proposal.applicantType === 'Partnership') { %>
                                <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h4 style="margin: 0; color: #2e7d32;">üìÑ Extracted Information from Partnership Deeds</h4>
                                        <button onclick="reprocessIncorporationDocs()" class="btn btn-primary" style="font-size: 0.85em; padding: 6px 12px;">
                                            üîÑ Re-extract Information
                                        </button>
                                    </div>
                                    <% incorporationDocs.forEach(doc => { %>
                                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                                            <strong style="color: #1976d2;">üìã <%= doc.originalName %></strong>
                                            <% if (doc.extractedDetails) { %>
                                                <div style="margin-top: 8px;">
                                                    <% if (doc.extractedDetails.deedDate) { %>
                                                        <div style="margin: 5px 0;">
                                                            <strong>üìÖ Deed Date:</strong> 
                                                            <span style="color: #2e7d32;"><%= doc.extractedDetails.deedDate %></span>
                                                        </div>
                                                    <% } else { %>
                                                        <div style="margin: 5px 0; color: #d32f2f;">
                                                            <strong>üìÖ Deed Date:</strong> Not found in document
                                                        </div>
                                                    <% } %>
                                                    
                                                    <% if (doc.extractedDetails.partnerShares && doc.extractedDetails.partnerShares.length > 0) { %>
                                                        <div style="margin: 5px 0;">
                                                            <strong>üí∞ Profit & Loss Sharing:</strong>
                                                            <ul style="margin: 5px 0 0 20px; list-style: disc;">
                                                                <% doc.extractedDetails.partnerShares.forEach(share => { %>
                                                                    <li style="color: #2e7d32;"><%= share %></li>
                                                                <% }); %>
                                                            </ul>
                                                        </div>
                                                    <% } else { %>
                                                        <div style="margin: 5px 0; color: #d32f2f;">
                                                            <strong>üí∞ Profit & Loss Sharing:</strong> Not found in document
                                                        </div>
                                                    <% } %>
                                                </div>
                                            <% } else { %>
                                                <div style="margin-top: 8px; color: #f57c00;">
                                                    <em>‚ö†Ô∏è No extraction data. Click "Re-extract Information" button above.</em>
                                                </div>
                                            <% } %>
                                        </div>
                                    <% }); %>
                                </div>
                            <% } %>
                        </div>

                        <!-- Credit Reports Pending -->
                        <div class="pending-category-content" data-pending-category="creditReports" style="display: none;">
                            <% if (pendingByCategory.creditReports.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.creditReports.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Credit Reports uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Financials Pending -->
                        <div class="pending-category-content" data-pending-category="financials" style="display: none;">
                            <% if (pendingByCategory.financials.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.financials.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Financial documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Banking Pending -->
                        <div class="pending-category-content" data-pending-category="banking" style="display: none;">
                            <% if (pendingByCategory.banking.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.banking.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Banking documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Turnover Pending -->
                        <div class="pending-category-content" data-pending-category="turnover" style="display: none;">
                            <% if (pendingByCategory.turnover.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.turnover.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Turnover documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Debt Profile Pending -->
                        <div class="pending-category-content" data-pending-category="debtProfile" style="display: none;">
                            <% if (pendingByCategory.debtProfile.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.debtProfile.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Debt Profile documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Collateral Pending -->
                        <div class="pending-category-content" data-pending-category="collateral" style="display: none;">
                            <% if (pendingByCategory.collateral.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.collateral.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Collateral documents uploaded!</p>
                            <% } %>
                        </div>

                        <p class="pending-note">Please upload all pending documents before proceeding to Stage 3.</p>
                    <% } %>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <a href="/proposals" class="btn btn-secondary">‚Üê Back to Proposals</a>
                <button type="button" class="btn btn-primary" onclick="proceedToStage3()" id="proceedBtn">
                    Complete Stage 2 & Proceed to Profiling ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        const proposalId = '<%= proposal.id %>';
        const bulkFileInput = document.getElementById('bulkDocuments');
        const bulkFilePreview = document.getElementById('bulkFilePreview');
        const bulkUploadForm = document.getElementById('bulkUploadForm');
        const uploadProgress = document.getElementById('uploadProgress');

        // File input preview
        bulkFileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            bulkFilePreview.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.innerHTML = `
                    <span class="file-icon">${file.type.includes('pdf') ? 'üìÑ' : file.type.includes('image') ? 'üñºÔ∏è' : file.name.endsWith('.zip') ? 'üì¶' : 'üìù'}</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${(file.size / 1024).toFixed(2)} KB</span>
                `;
                bulkFilePreview.appendChild(fileItem);
            });
        });

        // Drag and drop
        const fileInputWrapper = document.querySelector('.file-input-wrapper');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, () => {
                fileInputWrapper.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, () => {
                fileInputWrapper.classList.remove('drag-over');
            });
        });

        fileInputWrapper.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            bulkFileInput.files = files;
            bulkFileInput.dispatchEvent(new Event('change'));
        });

        // Form submission
        bulkUploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const files = bulkFileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one file');
                return;
            }
            
            for (let file of files) {
                formData.append('documents', file);
            }
            formData.append('proposalId', proposalId);
            
            uploadProgress.style.display = 'block';
            
            try {
                const response = await fetch(`/stage2/${proposalId}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadProgress.style.display = 'none';
                    alert('Documents uploaded successfully!');
                    window.location.reload();
                } else {
                    uploadProgress.style.display = 'none';
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                uploadProgress.style.display = 'none';
                alert('Upload error: ' + error.message);
            }
        });

        // Tab functionality
        function showTab(category) {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            // Update active tab button
            tabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter rows by category and uncheck hidden rows
            if (category === 'all') {
                allRows.forEach(row => row.style.display = '');
            } else {
                allRows.forEach(row => {
                    const rowCategory = row.getAttribute('data-category');
                    if (rowCategory === category) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                        // Uncheck checkboxes in hidden rows
                        const checkbox = row.querySelector('.doc-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }
                });
            }
            
            // Reset select all checkbox and update bulk actions when tab changes
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            updateBulkActions();
        }

        // Update document category
        async function updateCategory(fileId, category) {
            if (!category) return;
            
            try {
                const response = await fetch(`/stage2/${proposalId}/categorize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileId, category })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Category updated successfully!');
                    window.location.reload();
                } else {
                    alert('Update failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Helper function to check if a row is actually visible
        function isRowVisible(row) {
            return row.style.display !== 'none' && row.offsetParent !== null;
        }

        // Toggle select all checkboxes - only for visible rows
        function toggleSelectAll(selectAllCheckbox) {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            allRows.forEach(row => {
                // Only select checkboxes in visible rows
                if (isRowVisible(row)) {
                    const checkbox = row.querySelector('.doc-checkbox');
                    if (checkbox) {
                        checkbox.checked = selectAllCheckbox.checked;
                    }
                }
            });
            updateBulkActions();
        }

        // Update bulk actions bar visibility and count - only count visible checked boxes
        function updateBulkActions() {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            let visibleCheckedCount = 0;
            let visibleTotalCount = 0;
            
            allRows.forEach(row => {
                if (isRowVisible(row)) {
                    visibleTotalCount++;
                    const checkbox = row.querySelector('.doc-checkbox');
                    if (checkbox && checkbox.checked) {
                        visibleCheckedCount++;
                    }
                }
            });
            
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (visibleCheckedCount > 0) {
                bulkActionsBar.style.display = 'flex';
                selectedCount.textContent = visibleCheckedCount;
            } else {
                bulkActionsBar.style.display = 'none';
            }
            
            // Update select all checkbox state - only based on visible rows
            selectAllCheckbox.checked = visibleTotalCount > 0 && visibleCheckedCount === visibleTotalCount;
            selectAllCheckbox.indeterminate = visibleCheckedCount > 0 && visibleCheckedCount < visibleTotalCount;
        }

        // Delete selected documents - only delete visible checked documents
        async function deleteSelectedDocuments() {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            const fileIds = [];
            
            // Only get file IDs from visible checked rows
            allRows.forEach(row => {
                if (isRowVisible(row)) {
                    const checkbox = row.querySelector('.doc-checkbox');
                    if (checkbox && checkbox.checked) {
                        fileIds.push(checkbox.value);
                    }
                }
            });
            
            if (fileIds.length === 0) {
                alert('No documents selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${fileIds.length} document(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/stage2/${proposalId}/delete-multiple-documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully deleted ${result.deletedCount} document(s)!`);
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Toggle select all checkboxes
        function toggleSelectAll(selectAllCheckbox) {
            const checkboxes = document.querySelectorAll('.doc-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateBulkActions();
        }

        // Update bulk actions bar visibility and count
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (checkboxes.length > 0) {
                bulkActionsBar.style.display = 'flex';
                selectedCount.textContent = checkboxes.length;
            } else {
                bulkActionsBar.style.display = 'none';
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.doc-checkbox');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }

        // Delete selected documents
        async function deleteSelectedDocuments() {
            const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            const fileIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (fileIds.length === 0) {
                alert('No documents selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${fileIds.length} document(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/stage2/${proposalId}/delete-multiple-documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully deleted ${result.deletedCount} document(s)!`);
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Delete document function
        async function deleteDocument(fileId, fileName) {
            if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/stage2/${proposalId}/delete-document`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Document deleted successfully!');
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Pending documents tab functionality
        function showPendingTab(category) {
            const allPendingContent = document.querySelectorAll('.pending-category-content');
            const pendingTabBtns = document.querySelectorAll('.tab-btn-pending');
            
            // Update active tab button
            pendingTabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content by category
            allPendingContent.forEach(content => {
                const contentCategory = content.getAttribute('data-pending-category');
                content.style.display = contentCategory === category ? 'block' : 'none';
            });
        }

        // Main tab functionality (Uploaded vs Pending)
        function showMainTab(tabName) {
            const mainTabBtns = document.querySelectorAll('.main-tab-btn');
            const uploadedSection = document.getElementById('uploadedSection');
            const pendingSection = document.getElementById('pendingSection');
            
            // Update active button
            mainTabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide sections
            if (tabName === 'uploaded') {
                uploadedSection.style.display = 'block';
                pendingSection.style.display = 'none';
            } else {
                uploadedSection.style.display = 'none';
                pendingSection.style.display = 'block';
            }
        }

        // Reprocess incorporation documents to extract partnership deed details
        async function reprocessIncorporationDocs() {
            if (!confirm('This will re-extract information from all partnership deed PDFs. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`/stage2/${proposalId}/reprocess-incorporation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully reprocessed ${result.processedCount} document(s)!`);
                    window.location.reload();
                } else {
                    alert('Reprocess failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function proceedToStage3() {
            if (confirm('Complete Stage 2 and proceed to Customer Profiling?')) {
                try {
                    const response = await fetch(`/stage2/${proposalId}/complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = `/stage3/${proposalId}`;
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // Document preview functions
        let hideTimeout = null;
        
        function showPreview(filename, originalName, proposalId, event) {
            // Cancel any pending hide
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
            
            const preview = document.getElementById('documentPreview');
            const loader = document.getElementById('previewLoader');
            const iframe = document.getElementById('previewFrame');
            const image = document.getElementById('previewImage');
            const text = document.getElementById('previewText');
            
            // Reset all preview elements
            loader.style.display = 'block';
            iframe.style.display = 'none';
            image.style.display = 'none';
            text.style.display = 'none';
            
            // Show preview popup first
            preview.style.display = 'block';
            
            // Position preview near the button
            const button = event ? event.target : null;
            if (button) {
                const rect = button.getBoundingClientRect();
                const previewWidth = 600;
                const previewHeight = 500;
                
                preview.style.position = 'fixed';
                
                // Try to place on the right side of button
                let leftPos = rect.right + 5;
                let topPos = rect.top - 10;
                
                // Check if preview goes off screen to the right
                if (leftPos + previewWidth > window.innerWidth - 10) {
                    // Place on left side instead
                    leftPos = rect.left - previewWidth - 5;
                }
                
                // Make sure left position is not negative
                if (leftPos < 10) {
                    leftPos = 10;
                }
                
                // Check if preview goes off screen at bottom
                if (topPos + previewHeight > window.innerHeight - 10) {
                    topPos = window.innerHeight - previewHeight - 10;
                }
                
                // Make sure top position is not negative
                if (topPos < 10) {
                    topPos = 10;
                }
                
                preview.style.left = leftPos + 'px';
                preview.style.top = topPos + 'px';
            }
            
            // Determine file type from original name
            const ext = originalName.toLowerCase().split('.').pop();
            const fileUrl = `/uploads/${proposalId}/${filename}`;
            
            // Load appropriate preview based on file type
            if (ext === 'pdf') {
                iframe.src = fileUrl;
                iframe.onload = function() {
                    loader.style.display = 'none';
                    iframe.style.display = 'block';
                };
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                image.src = fileUrl;
                image.onload = function() {
                    loader.style.display = 'none';
                    image.style.display = 'block';
                };
            } else {
                // For other file types, show file info
                text.innerHTML = `<strong>File:</strong> ${originalName}<br><strong>Type:</strong> ${ext.toUpperCase()}<br><br>Preview not available for this file type.<br><a href="${fileUrl}" target="_blank">Download to view</a>`;
                loader.style.display = 'none';
                text.style.display = 'block';
            }
        }

        function scheduleHidePreview() {
            hideTimeout = setTimeout(function() {
                hidePreview();
            }, 200);
        }
        
        function cancelHidePreview() {
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
        }
        
        function hidePreview() {
            const preview = document.getElementById('documentPreview');
            const iframe = document.getElementById('previewFrame');
            const image = document.getElementById('previewImage');
            
            preview.style.display = 'none';
            iframe.src = '';
            image.src = '';
        }
    </script>
</body>
</html>
