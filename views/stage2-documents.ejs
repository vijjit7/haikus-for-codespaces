<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 2: Document Upload - Proposal #<%= proposal.id %></title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/proposal.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Stage 2: Document Upload & Proposal Perfection</h1>
            <p class="subtitle">Proposal ID: #<%= proposal.id %> | Applicant: <%= proposal.applicantName || proposal.customerName %></p>
        </header>

        <div class="progress-tracker">
            <div class="progress-step completed">
                <div class="step-number">1</div>
                <div class="step-label">Proposal</div>
            </div>
            <div class="progress-step active">
                <div class="step-number">2</div>
                <div class="step-label">Documents</div>
            </div>
            <div class="progress-step">
                <div class="step-number">3</div>
                <div class="step-label">Profiling</div>
            </div>
            <div class="progress-step">
                <div class="step-number">4</div>
                <div class="step-label">Banker Match</div>
            </div>
        </div>

        <div class="stage2-container">
            <!-- Customer Summary -->
            <div class="customer-summary card">
                <h2>Customer Summary</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Applicant Name:</span>
                        <span class="value"><%= proposal.applicantName || proposal.customerName %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Applicant Type:</span>
                        <span class="value"><%= proposal.applicantType || proposal.customerType %></span>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                        <div class="summary-item">
                            <span class="label">Co-Applicants:</span>
                            <span class="value">
                                <%= proposal.coApplicants.map(ca => ca.name).join(', ') %>
                            </span>
                        </div>
                    <% } %>
                    <div class="summary-item">
                        <span class="label">Loan Amount:</span>
                        <span class="value">‚Çπ<%= proposal.loanAmount ? parseInt(proposal.loanAmount).toLocaleString('en-IN') : 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Loan Type:</span>
                        <span class="value"><%= proposal.typeOfLoan || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Nature:</span>
                        <span class="value"><%= proposal.natureOfLoan || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Collateral:</span>
                        <span class="value"><%= proposal.natureOfCollateral || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Industry:</span>
                        <span class="value"><%= proposal.industry || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Annual Revenue:</span>
                        <span class="value"><%= proposal.annualRevenue || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Contact:</span>
                        <span class="value"><%= proposal.email %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Submitted:</span>
                        <span class="value"><%= new Date(proposal.createdAt).toLocaleDateString() %></span>
                    </div>
                </div>
            </div>

            <!-- Bulk Upload Section -->
            <div class="bulk-upload-section card">
                <h2>üì§ Bulk Upload</h2>
                <p class="upload-instructions">Upload zip, PDF, JPG, XLS, doc</p>
                <form id="bulkUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <div class="file-input-wrapper">
                            <input type="file" id="bulkDocuments" name="bulkDocuments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip">
                            <div class="file-input-display">
                                <span class="file-icon">üìé</span>
                                <span class="file-text">Choose files or drag here</span>
                            </div>
                        </div>
                    </div>
                    <div id="bulkFilePreview" class="file-preview"></div>
                    <button type="submit" class="btn btn-primary">
                        <span class="upload-icon">‚¨ÜÔ∏è</span> Upload Files
                    </button>
                </form>
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="progress-text">Uploading and processing documents...</p>
                </div>
            </div>

            <!-- Required Documents Section -->
            <div class="required-documents card">
                <h2>üìã Required Documents</h2>
                
                <!-- Personal ID -->
                <div class="doc-category">
                    <h3 class="category-title">Personal ID - only for individual applicant or coapplicants</h3>
                    <ul class="doc-list">
                        <li>PAN Card (Applicant or Coapplicant)</li>
                        <li>Aadhar Card (Applicant or Coapplicant)</li>
                    </ul>
                </div>

                <!-- Business ID (only for non-individual) -->
                <% if (proposal.applicantType !== 'Individual') { %>
                <div class="doc-category">
                    <h3 class="category-title">Business ID - only for non individual</h3>
                    <ul class="doc-list">
                        <li>PAN Card (<%= proposal.applicantName || 'Applicant Name' %> - Non Individual)</li>
                        <li>GST Certificate of (<%= proposal.applicantName || 'Applicant Name' %>)</li>
                        <li>Labour License of (Applicant/ Coapplicant name)</li>
                        <li>UDYAM Certificate of (Applicant/ Coapplicant name)</li>
                    </ul>
                </div>
                <% } %>

                <!-- Incorporation -->
                <div class="doc-category">
                    <h3 class="category-title">Incorporation</h3>
                    <% if (proposal.applicantType === 'Partnership') { %>
                    <div class="doc-subcategory">
                        <h4>For Partnership</h4>
                        <ul class="doc-list">
                            <li>Partnership deed</li>
                            <li>Reconstituted partnership deed</li>
                        </ul>
                    </div>
                    <% } %>
                    <% if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') { %>
                    <div class="doc-subcategory">
                        <h4>For Private Limited or Public Limited</h4>
                        <ul class="doc-list">
                            <li>Certificate of Incorporation</li>
                            <li>Memorandum of Association</li>
                            <li>Articles of Association</li>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Credit Reports -->
                <div class="doc-category">
                    <h3 class="category-title">Credit Reports</h3>
                    <ul class="doc-list">
                        <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>Personal Credit Report of <%= co.name %> (only for individuals)</li>
                            <% }); %>
                        <% } %>
                        <li>Business Credit Report of <%= proposal.applicantName %> (Non Individual)</li>
                    </ul>
                </div>

                <!-- Financials -->
                <div class="doc-category">
                    <h3 class="category-title">Financials</h3>
                    <div class="doc-subcategory">
                        <h4>Business</h4>
                        <ul class="doc-list">
                            <li>ITR of Current Year of (<%= proposal.applicantName %>)</li>
                            <li>ITR of Previous Year of (<%= proposal.applicantName %>)</li>
                            <li>ITR of Preceding previous year of (<%= proposal.applicantName %>)</li>
                        </ul>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                    <div class="doc-subcategory">
                        <h4>Personal</h4>
                        <ul class="doc-list">
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>ITR of Current Year (<%= co.name || 'CoApplicant ' + (idx + 1) %>)</li>
                                <li>ITR of Previous Year of (<%= co.name || 'coApplicant' + (idx + 1) + ' name' %>)</li>
                                <li>ITR of Preceding previous year of (<%= co.name || 'coApplicant' + (idx + 1) + ' name' %>)</li>
                            <% }); %>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Banking -->
                <div class="doc-category">
                    <h3 class="category-title">Banking</h3>
                    <div class="doc-subcategory">
                        <h4>Business</h4>
                        <ul class="doc-list">
                            <li>Bank Statement of <%= proposal.applicantName %></li>
                            <li>Overdraft Bank Statement of <%= proposal.applicantName %></li>
                        </ul>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                    <div class="doc-subcategory">
                        <h4>Personal</h4>
                        <ul class="doc-list">
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>Bank Statement of <%= co.name || 'Coapplicant Name' + (idx + 1) %></li>
                            <% }); %>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Turnover -->
                <div class="doc-category">
                    <h3 class="category-title">Turnover</h3>
                    <ul class="doc-list">
                        <li>GST 3B returns for last 12 months</li>
                        <li>GST 1 returns for last 12 months</li>
                    </ul>
                </div>

                <!-- Debt Profile -->
                <div class="doc-category">
                    <h3 class="category-title">Debt Profile</h3>
                    <ul class="doc-list">
                        <li>All Existing Loan Details</li>
                    </ul>
                </div>

                <!-- Collateral -->
                <div class="doc-category">
                    <h3 class="category-title">Collateral</h3>
                    <ul class="doc-list">
                        <li>Title Documents</li>
                        <li>Tax paid Receipts</li>
                        <li>Approved Sanction Plan</li>
                        <li>Encumberance Certificate</li>
                        <li>Title Documents - Unregistered</li>
                    </ul>
                </div>

                <p class="categorization-note">All uploaded documents needs to be categorised into below tabs</p>
            </div>

            <!-- Document Management Section with Main Tabs -->
            <div class="documents-management card">
                <h2>üìÅ Document Management</h2>
                
                <!-- Main Tab Navigation (Uploaded vs Pending) -->
                <div class="main-tab-navigation">
                    <button class="main-tab-btn active" onclick="showMainTab('uploaded')">
                        üì§ Uploaded Documents (<span id="fileCount"><%= uploadedFiles.length %></span>)
                    </button>
                    <button class="main-tab-btn" onclick="showMainTab('pending')">
                        ‚ö†Ô∏è Pending Documents
                    </button>
                </div>

                <!-- Uploaded Documents Section -->
                <div id="uploadedSection" class="main-tab-content">
                    <!-- Sub-Tab Navigation for Uploaded -->
                    <div class="tab-navigation">
                        <button class="tab-btn active" onclick="showTab('all')">ALL</button>
                        <button class="tab-btn" onclick="showTab('personalId')">Personal ID</button>
                        <button class="tab-btn" onclick="showTab('businessId')">Business ID</button>
                        <button class="tab-btn" onclick="showTab('incorporation')">Incorporation</button>
                        <button class="tab-btn" onclick="showTab('creditReports')">Credit Reports</button>
                        <button class="tab-btn" onclick="showTab('financials')">Financials</button>
                        <button class="tab-btn" onclick="showTab('banking')">Banking</button>
                        <button class="tab-btn" onclick="showTab('turnover')">Turnover</button>
                        <button class="tab-btn" onclick="showTab('debtProfile')">Debt Profile</button>
                        <button class="tab-btn" onclick="showTab('collateral')">Collateral</button>
                    </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <% if (uploadedFiles.length === 0) { %>
                        <div class="empty-state-small">
                            <p>No documents uploaded yet</p>
                        </div>
                    <% } else { %>
                        <div class="files-table-wrapper">
                            <table class="files-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>File Name</th>
                                        <th>Size</th>
                                        <th>Uploaded</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="filesTableBody">
                                    <% uploadedFiles.forEach(file => { %>
                                        <tr data-category="<%= file.category || 'all' %>">
                                            <td>
                                                <span class="badge"><%= file.category || 'Uncategorized' %></span>
                                            </td>
                                            <td>
                                                <span class="file-icon-small">
                                                    <%= file.originalName.endsWith('.pdf') ? 'üìÑ' : file.originalName.match(/\.(jpg|jpeg|png)$/i) ? 'üñºÔ∏è' : 'üìù' %>
                                                </span>
                                                <%= file.originalName %>
                                            </td>
                                            <td><%= file.size %></td>
                                            <td><%= new Date(file.uploadedAt).toLocaleString() %></td>
                                            <td><span class="badge badge-success">‚úì Uploaded</span></td>
                                            <td class="actions-cell">
                                                <button class="btn-view" 
                                                    onmouseover="showPreview('<%= file.filename %>', '<%= file.originalName %>', '<%= proposalId %>')" 
                                                    onmouseout="hidePreview()"
                                                    title="View document">
                                                    üëÅÔ∏è
                                                </button>
                                                <select class="category-select" onchange="updateCategory('<%= file.id %>', this.value)">
                                                    <option value="">Categorize...</option>
                                                    <option value="personalId" <%= file.category === 'personalId' ? 'selected' : '' %>>Personal ID</option>
                                                    <option value="businessId" <%= file.category === 'businessId' ? 'selected' : '' %>>Business ID</option>
                                                    <option value="incorporation" <%= file.category === 'incorporation' ? 'selected' : '' %>>Incorporation</option>
                                                    <option value="creditReports" <%= file.category === 'creditReports' ? 'selected' : '' %>>Credit Reports</option>
                                                    <option value="financials" <%= file.category === 'financials' ? 'selected' : '' %>>Financials</option>
                                                    <option value="banking" <%= file.category === 'banking' ? 'selected' : '' %>>Banking</option>
                                                    <option value="turnover" <%= file.category === 'turnover' ? 'selected' : '' %>>Turnover</option>
                                                    <option value="debtProfile" <%= file.category === 'debtProfile' ? 'selected' : '' %>>Debt Profile</option>
                                                    <option value="collateral" <%= file.category === 'collateral' ? 'selected' : '' %>>Collateral</option>
                                                </select>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Document Preview Popup -->
                        <div id="documentPreview" class="document-preview-popup" style="display: none;">
                            <div class="preview-content">
                                <div id="previewLoader" class="preview-loader">Loading preview...</div>
                                <iframe id="previewFrame" style="display: none;"></iframe>
                                <img id="previewImage" style="display: none;" alt="Document preview">
                                <div id="previewText" style="display: none;"></div>
                            </div>
                        </div>
                    <% } %>
                    </div>
                </div>

                <!-- Pending Documents Section -->
                <div id="pendingSection" class="main-tab-content" style="display: none;">
                    <!-- Sub-Tab Navigation for Pending -->
                    <div class="tab-navigation">
                        <% 
                        // Categorize pending documents first to calculate counts
                        const pendingByCategory = {
                            personalId: [],
                            businessId: [],
                            incorporation: [],
                            creditReports: [],
                            financials: [],
                            banking: [],
                            turnover: [],
                            debtProfile: [],
                            collateral: []
                        };

                        // Personal ID documents
                        pendingByCategory.personalId.push('PAN Card (Applicant or Coapplicant)');
                        pendingByCategory.personalId.push('Aadhar Card (Applicant or Coapplicant)');

                        // Business ID (only for non-individual)
                        if (proposal.applicantType !== 'Individual') {
                            pendingByCategory.businessId.push('PAN Card (' + (proposal.applicantName || 'Applicant Name') + ' - Non Individual)');
                            pendingByCategory.businessId.push('GST Certificate of (' + (proposal.applicantName || 'Applicant Name') + ')');
                            pendingByCategory.businessId.push('Labour License of (Applicant/ Coapplicant name)');
                            pendingByCategory.businessId.push('UDYAM Certificate of (Applicant/ Coapplicant name)');
                        }

                        // Incorporation
                        if (proposal.applicantType === 'Partnership') {
                            pendingByCategory.incorporation.push('Partnership deed');
                            pendingByCategory.incorporation.push('Reconstituted partnership deed');
                        }
                        if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') {
                            pendingByCategory.incorporation.push('Certificate of Incorporation');
                            pendingByCategory.incorporation.push('Memorandum of Association');
                            pendingByCategory.incorporation.push('Articles of Association');
                        }

                        // Credit Reports
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                pendingByCategory.creditReports.push('Personal Credit Report of ' + co.name + ' (only for individuals)');
                            });
                        }
                        pendingByCategory.creditReports.push('Business Credit Report of ' + proposal.applicantName + ' (Non Individual)');

                        // Financials
                        pendingByCategory.financials.push('ITR of Current Year of (' + proposal.applicantName + ')');
                        pendingByCategory.financials.push('ITR of Previous Year of (' + proposal.applicantName + ')');
                        pendingByCategory.financials.push('ITR of Preceding previous year of (' + proposal.applicantName + ')');
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                pendingByCategory.financials.push('ITR of Current Year (' + (co.name || 'CoApplicant ' + (idx + 1)) + ')');
                                pendingByCategory.financials.push('ITR of Previous Year of (' + (co.name || 'coApplicant' + (idx + 1) + ' name') + ')');
                                pendingByCategory.financials.push('ITR of Preceding previous year of (' + (co.name || 'coApplicant' + (idx + 1) + ' name') + ')');
                            });
                        }

                        // Banking
                        pendingByCategory.banking.push('Bank Statement of ' + proposal.applicantName);
                        pendingByCategory.banking.push('Overdraft Bank Statement of ' + proposal.applicantName);
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                pendingByCategory.banking.push('Bank Statement of ' + (co.name || 'Coapplicant Name' + (idx + 1)));
                            });
                        }

                        // Turnover
                        pendingByCategory.turnover.push('GST 3B returns for last 12 months');
                        pendingByCategory.turnover.push('GST 1 returns for last 12 months');

                        // Debt Profile
                        pendingByCategory.debtProfile.push('All Existing Loan Details');

                        // Collateral
                        pendingByCategory.collateral.push('Title Documents');
                        pendingByCategory.collateral.push('Tax paid Receipts');
                        pendingByCategory.collateral.push('Approved Sanction Plan');
                        pendingByCategory.collateral.push('Encumberance Certificate');
                        pendingByCategory.collateral.push('Title Documents - Unregistered');

                        // Calculate all pending documents
                        let allPending = [];
                        Object.keys(pendingByCategory).forEach(cat => {
                            allPending = allPending.concat(pendingByCategory[cat]);
                        });
                        %>
                        <button class="tab-btn-pending active" onclick="showPendingTab('all')">ALL (<%= allPending.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('personalId')">Personal ID (<%= pendingByCategory.personalId.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('businessId')">Business ID (<%= pendingByCategory.businessId.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('incorporation')">Incorporation (<%= pendingByCategory.incorporation.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('creditReports')">Credit Reports (<%= pendingByCategory.creditReports.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('financials')">Financials (<%= pendingByCategory.financials.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('banking')">Banking (<%= pendingByCategory.banking.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('turnover')">Turnover (<%= pendingByCategory.turnover.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('debtProfile')">Debt Profile (<%= pendingByCategory.debtProfile.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('collateral')">Collateral (<%= pendingByCategory.collateral.length %>)</button>
                    </div>
                
                    <!-- Pending Documents Content -->
                    <div id="pendingTabContent" class="pending-tab-content">
                    <% 
                    pendingByCategory.personalId.push('PAN Card (Applicant or Coapplicant)');
                    pendingByCategory.personalId.push('Aadhar Card (Applicant or Coapplicant)');

                    // Business ID (only for non-individual)
                    if (proposal.applicantType !== 'Individual') {
                        pendingByCategory.businessId.push('PAN Card (' + (proposal.applicantName || 'Applicant Name') + ' - Non Individual)');
                        pendingByCategory.businessId.push('GST Certificate of (' + (proposal.applicantName || 'Applicant Name') + ')');
                        pendingByCategory.businessId.push('Labour License of (Applicant/ Coapplicant name)');
                        pendingByCategory.businessId.push('UDYAM Certificate of (Applicant/ Coapplicant name)');
                    }

                    // Incorporation
                    if (proposal.applicantType === 'Partnership') {
                        pendingByCategory.incorporation.push('Partnership deed');
                        pendingByCategory.incorporation.push('Reconstituted partnership deed');
                    }
                    if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') {
                        pendingByCategory.incorporation.push('Certificate of Incorporation');
                        pendingByCategory.incorporation.push('Memorandum of Association');
                        pendingByCategory.incorporation.push('Articles of Association');
                    }

                    // Credit Reports
                    if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                        proposal.coApplicants.forEach((co, idx) => {
                            pendingByCategory.creditReports.push('Personal Credit Report of ' + co.name + ' (only for individuals)');
                        });
                    }
                    pendingByCategory.creditReports.push('Business Credit Report of ' + proposal.applicantName + ' (Non Individual)');

                    // Financials
                    pendingByCategory.financials.push('ITR of Current Year of (' + proposal.applicantName + ')');
                    pendingByCategory.financials.push('ITR of Previous Year of (' + proposal.applicantName + ')');
                    pendingByCategory.financials.push('ITR of Preceding previous year of (' + proposal.applicantName + ')');
                    if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                        proposal.coApplicants.forEach((co, idx) => {
                            pendingByCategory.financials.push('ITR of Current Year (' + (co.name || 'CoApplicant ' + (idx + 1)) + ')');
                            pendingByCategory.financials.push('ITR of Previous Year of (' + (co.name || 'coApplicant' + (idx + 1) + ' name') + ')');
                            pendingByCategory.financials.push('ITR of Preceding previous year of (' + (co.name || 'coApplicant' + (idx + 1) + ' name') + ')');
                        });
                    }

                    // Banking
                    pendingByCategory.banking.push('Bank Statement of ' + proposal.applicantName);
                    pendingByCategory.banking.push('Overdraft Bank Statement of ' + proposal.applicantName);
                    if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                        proposal.coApplicants.forEach((co, idx) => {
                            pendingByCategory.banking.push('Bank Statement of ' + (co.name || 'Coapplicant Name' + (idx + 1)));
                        });
                    }

                    // Turnover
                    pendingByCategory.turnover.push('GST 3B returns for last 12 months');
                    pendingByCategory.turnover.push('GST 1 returns for last 12 months');

                    // Debt Profile
                    pendingByCategory.debtProfile.push('All Existing Loan Details');

                    // Collateral
                    pendingByCategory.collateral.push('Title Documents');
                    pendingByCategory.collateral.push('Tax paid Receipts');
                    pendingByCategory.collateral.push('Approved Sanction Plan');
                    pendingByCategory.collateral.push('Encumberance Certificate');
                    pendingByCategory.collateral.push('Title Documents - Unregistered');
                    %>

                    <% if (allPending.length === 0) { %>
                        <div class="success-message">
                            ‚úì All required documents have been uploaded!
                        </div>
                    <% } else { %>
                        <!-- All Pending -->
                        <div class="pending-category-content" data-pending-category="all">
                            <ul class="pending-list">
                                <% allPending.forEach(doc => { %>
                                    <li class="pending-item">
                                        <span class="warning-icon">‚ö†Ô∏è</span>
                                        <%= doc %>
                                    </li>
                                <% }); %>
                            </ul>
                        </div>

                        <!-- Personal ID Pending -->
                        <div class="pending-category-content" data-pending-category="personalId" style="display: none;">
                            <% if (pendingByCategory.personalId.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.personalId.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Personal ID documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Business ID Pending -->
                        <div class="pending-category-content" data-pending-category="businessId" style="display: none;">
                            <% if (pendingByCategory.businessId.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.businessId.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Business ID documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Incorporation Pending -->
                        <div class="pending-category-content" data-pending-category="incorporation" style="display: none;">
                            <% if (pendingByCategory.incorporation.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.incorporation.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Incorporation documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Credit Reports Pending -->
                        <div class="pending-category-content" data-pending-category="creditReports" style="display: none;">
                            <% if (pendingByCategory.creditReports.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.creditReports.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Credit Reports uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Financials Pending -->
                        <div class="pending-category-content" data-pending-category="financials" style="display: none;">
                            <% if (pendingByCategory.financials.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.financials.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Financial documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Banking Pending -->
                        <div class="pending-category-content" data-pending-category="banking" style="display: none;">
                            <% if (pendingByCategory.banking.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.banking.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Banking documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Turnover Pending -->
                        <div class="pending-category-content" data-pending-category="turnover" style="display: none;">
                            <% if (pendingByCategory.turnover.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.turnover.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Turnover documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Debt Profile Pending -->
                        <div class="pending-category-content" data-pending-category="debtProfile" style="display: none;">
                            <% if (pendingByCategory.debtProfile.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.debtProfile.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Debt Profile documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Collateral Pending -->
                        <div class="pending-category-content" data-pending-category="collateral" style="display: none;">
                            <% if (pendingByCategory.collateral.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.collateral.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Collateral documents uploaded!</p>
                            <% } %>
                        </div>

                        <p class="pending-note">Please upload all pending documents before proceeding to Stage 3.</p>
                    <% } %>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <a href="/proposals" class="btn btn-secondary">‚Üê Back to Proposals</a>
                <button type="button" class="btn btn-primary" onclick="proceedToStage3()" id="proceedBtn">
                    Complete Stage 2 & Proceed to Profiling ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        const proposalId = '<%= proposal.id %>';
        const bulkFileInput = document.getElementById('bulkDocuments');
        const bulkFilePreview = document.getElementById('bulkFilePreview');
        const bulkUploadForm = document.getElementById('bulkUploadForm');
        const uploadProgress = document.getElementById('uploadProgress');

        // File input preview
        bulkFileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            bulkFilePreview.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.innerHTML = `
                    <span class="file-icon">${file.type.includes('pdf') ? 'üìÑ' : file.type.includes('image') ? 'üñºÔ∏è' : file.name.endsWith('.zip') ? 'üì¶' : 'üìù'}</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${(file.size / 1024).toFixed(2)} KB</span>
                `;
                bulkFilePreview.appendChild(fileItem);
            });
        });

        // Drag and drop
        const fileInputWrapper = document.querySelector('.file-input-wrapper');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, () => {
                fileInputWrapper.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, () => {
                fileInputWrapper.classList.remove('drag-over');
            });
        });

        fileInputWrapper.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            bulkFileInput.files = files;
            bulkFileInput.dispatchEvent(new Event('change'));
        });

        // Form submission
        bulkUploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const files = bulkFileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one file');
                return;
            }
            
            for (let file of files) {
                formData.append('documents', file);
            }
            formData.append('proposalId', proposalId);
            
            uploadProgress.style.display = 'block';
            
            try {
                const response = await fetch(`/stage2/${proposalId}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadProgress.style.display = 'none';
                    alert('Documents uploaded successfully!');
                    window.location.reload();
                } else {
                    uploadProgress.style.display = 'none';
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                uploadProgress.style.display = 'none';
                alert('Upload error: ' + error.message);
            }
        });

        // Tab functionality
        function showTab(category) {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            // Update active tab button
            tabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter rows by category
            if (category === 'all') {
                allRows.forEach(row => row.style.display = '');
            } else {
                allRows.forEach(row => {
                    const rowCategory = row.getAttribute('data-category');
                    row.style.display = rowCategory === category ? '' : 'none';
                });
            }
        }

        // Update document category
        async function updateCategory(fileId, category) {
            if (!category) return;
            
            try {
                const response = await fetch(`/stage2/${proposalId}/categorize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileId, category })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Category updated successfully!');
                    window.location.reload();
                } else {
                    alert('Update failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Pending documents tab functionality
        function showPendingTab(category) {
            const allPendingContent = document.querySelectorAll('.pending-category-content');
            const pendingTabBtns = document.querySelectorAll('.tab-btn-pending');
            
            // Update active tab button
            pendingTabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content by category
            allPendingContent.forEach(content => {
                const contentCategory = content.getAttribute('data-pending-category');
                content.style.display = contentCategory === category ? 'block' : 'none';
            });
        }

        // Main tab functionality (Uploaded vs Pending)
        function showMainTab(tabName) {
            const mainTabBtns = document.querySelectorAll('.main-tab-btn');
            const uploadedSection = document.getElementById('uploadedSection');
            const pendingSection = document.getElementById('pendingSection');
            
            // Update active button
            mainTabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide sections
            if (tabName === 'uploaded') {
                uploadedSection.style.display = 'block';
                pendingSection.style.display = 'none';
            } else {
                uploadedSection.style.display = 'none';
                pendingSection.style.display = 'block';
            }
        }

        async function proceedToStage3() {
            if (confirm('Complete Stage 2 and proceed to Customer Profiling?')) {
                try {
                    const response = await fetch(`/stage2/${proposalId}/complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = `/stage3/${proposalId}`;
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // Document preview functions
        function showPreview(filename, originalName, proposalId) {
            const preview = document.getElementById('documentPreview');
            const loader = document.getElementById('previewLoader');
            const iframe = document.getElementById('previewFrame');
            const image = document.getElementById('previewImage');
            const text = document.getElementById('previewText');
            
            // Reset all preview elements
            loader.style.display = 'block';
            iframe.style.display = 'none';
            image.style.display = 'none';
            text.style.display = 'none';
            
            // Show preview popup
            preview.style.display = 'block';
            
            // Determine file type from original name
            const ext = originalName.toLowerCase().split('.').pop();
            const fileUrl = `/uploads/${proposalId}/${filename}`;
            
            // Load appropriate preview based on file type
            if (ext === 'pdf') {
                iframe.src = fileUrl;
                iframe.onload = function() {
                    loader.style.display = 'none';
                    iframe.style.display = 'block';
                };
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                image.src = fileUrl;
                image.onload = function() {
                    loader.style.display = 'none';
                    image.style.display = 'block';
                };
            } else {
                // For other file types, show file info
                text.innerHTML = `<strong>File:</strong> ${originalName}<br><strong>Type:</strong> ${ext.toUpperCase()}<br><br>Preview not available for this file type.<br><a href="${fileUrl}" target="_blank">Download to view</a>`;
                loader.style.display = 'none';
                text.style.display = 'block';
            }
        }

        function hidePreview() {
            const preview = document.getElementById('documentPreview');
            const iframe = document.getElementById('previewFrame');
            const image = document.getElementById('previewImage');
            
            preview.style.display = 'none';
            iframe.src = '';
            image.src = '';
        }
    </script>
</body>
</html>
