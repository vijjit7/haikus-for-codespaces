<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage 2: Document Upload - Proposal #<%= proposal.id %></title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/proposal.css">
</head>
<body>
    <%
    // Global variable for EMI verification results - defined at top level
    let emiFoundInAccounts = {};
    %>
    <div class="container">
        <header>
            <h1>Stage 2: Document Upload & Proposal Perfection</h1>
            <p class="subtitle">Proposal ID: #<%= proposal.id %> | Applicant: <%= proposal.applicantName || proposal.customerName %></p>
        </header>

        <div class="progress-tracker">
            <div class="progress-step completed">
                <div class="step-number">1</div>
                <div class="step-label">Proposal</div>
            </div>
            <div class="progress-step active">
                <div class="step-number">2</div>
                <div class="step-label">Documents</div>
            </div>
            <div class="progress-step">
                <div class="step-number">3</div>
                <div class="step-label">Profiling</div>
            </div>
            <div class="progress-step">
                <div class="step-number">4</div>
                <div class="step-label">Banker Match</div>
            </div>
        </div>

        <div class="stage2-container">
            <!-- Customer Summary -->
            <div class="customer-summary card">
                <h2>Customer Summary</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="label">Applicant Name:</span>
                        <span class="value"><%= proposal.applicantName || proposal.customerName %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Applicant Type:</span>
                        <span class="value"><%= proposal.applicantType || proposal.customerType %></span>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                        <div class="summary-item">
                            <span class="label">Co-Applicants:</span>
                            <span class="value">
                                <%= proposal.coApplicants.map(ca => ca.name).join(', ') %>
                            </span>
                        </div>
                    <% } %>
                    <div class="summary-item">
                        <span class="label">Loan Amount:</span>
                        <span class="value">‚Çπ<%= proposal.loanAmount ? parseInt(proposal.loanAmount).toLocaleString('en-IN') : 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Loan Type:</span>
                        <span class="value"><%= proposal.typeOfLoan || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Nature:</span>
                        <span class="value"><%= proposal.natureOfLoan || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Collateral:</span>
                        <span class="value"><%= proposal.natureOfCollateral || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Industry:</span>
                        <span class="value"><%= proposal.industry || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Annual Revenue:</span>
                        <span class="value"><%= proposal.annualRevenue || 'N/A' %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Contact:</span>
                        <span class="value"><%= proposal.email %></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Submitted:</span>
                        <span class="value"><%= new Date(proposal.createdAt).toLocaleDateString() %></span>
                    </div>
                </div>
            </div>


            <!-- Document Statistics Section -->
            <div class="document-statistics card">
                <h2>üìä Document Summary</h2>
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-label">Total Documents Uploaded</div>
                        <div class="stat-value"><%= uploadedFiles.length %></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Categorised</div>
                        <div class="stat-value categorised"><%= uploadedFiles.filter(f => f.category).length %></div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Not Categorised</div>
                        <div class="stat-value not-categorised"><%= uploadedFiles.filter(f => !f.category).length %></div>
                    </div>
                </div>
            </div>

            <!-- Bulk Upload Section -->
            <div class="bulk-upload-section card">
                <h2>üì§ Bulk Upload</h2>
                <p class="upload-instructions">Upload zip, PDF, JPG, XLS, doc</p>
                <form id="bulkUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <div class="file-input-wrapper">
                            <input type="file" id="bulkDocuments" name="bulkDocuments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip">
                            <div class="file-input-display">
                                <span class="file-icon">üìé</span>
                                <span class="file-text">Choose files or drag here</span>
                            </div>
                        </div>
                    </div>
                    <div id="bulkFilePreview" class="file-preview"></div>
                    <div class="upload-buttons">
                        <button type="submit" class="btn btn-primary">
                            <span class="upload-icon">‚¨ÜÔ∏è</span> Upload Files
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearAllFilesBtn" onclick="clearAllFiles()" style="display: none;">
                            üóëÔ∏è Clear All
                        </button>
                    </div>
                </form>
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="progress-text">Uploading and processing documents...</p>
                </div>
            </div>

            <!-- Required Documents Section -->
            <%
                // Calculate Financial Years - rolls over every November
                const now = new Date();
                const currentMonth = now.getMonth(); // 0-11 (0=Jan, 10=Nov)
                const currentYear = now.getFullYear();

                // Before November: use (year-2) as base, From November onwards: use (year-1) as base
                const baseYear = currentMonth >= 10 ? currentYear - 1 : currentYear - 2;

                const currentFY = 'FY' + baseYear + '-' + String(baseYear + 1).slice(-2);
                const previousFY = 'FY' + (baseYear - 1) + '-' + String(baseYear).slice(-2);
                const precedingFY = 'FY' + (baseYear - 2) + '-' + String(baseYear - 1).slice(-2);
            %>
            <div class="required-documents card">
                <h2>üìã Required Documents</h2>
                
                <!-- Personal ID -->
                <div class="doc-category">
                    <h3 class="category-title">Personal ID - only for individual applicant or coapplicants</h3>
                    <ul class="doc-list">
                        <% if (proposal.applicantType === 'Individual') { %>
                            <li>PAN Card of <%= proposal.applicantName || proposal.customerName %></li>
                            <li>Aadhar Card of <%= proposal.applicantName || proposal.customerName %></li>
                        <% } %>
                        <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <% if (co.type === 'Individual') { %>
                                    <li>PAN Card of <%= co.name %></li>
                                    <li>Aadhar Card of <%= co.name %></li>
                                <% } %>
                            <% }); %>
                        <% } %>
                    </ul>
                </div>

                <!-- Business ID (only for non-individual) -->
                <% if (proposal.applicantType !== 'Individual') { %>
                <div class="doc-category">
                    <h3 class="category-title">Business ID - only for non individual</h3>
                    <ul class="doc-list">
                        <li>PAN Card of <%= proposal.applicantName || 'Applicant Name' %> (Non Individual)</li>
                        <li>GST Certificate of <%= proposal.applicantName || 'Applicant Name' %></li>
                        <li>Labour License of <%= proposal.applicantName || 'Applicant Name' %></li>
                        <li>UDYAM Certificate of <%= proposal.applicantName || 'Applicant Name' %></li>
                        <% if (proposal.applicantType === 'Partnership' || proposal.applicantType === 'LLP') { %>
                        <li>Firm Registration Certificate of <%= proposal.applicantName || 'Applicant Name' %></li>
                        <% } %>
                        <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <% if (co.type === 'Partnership' || co.type === 'LLP') { %>
                                <li>Firm Registration Certificate of <%= co.name %></li>
                                <% } %>
                            <% }); %>
                        <% } %>
                    </ul>
                </div>
                <% } %>

                <!-- Incorporation -->
                <div class="doc-category">
                    <h3 class="category-title">Incorporation</h3>
                    <% if (proposal.applicantType === 'Partnership') { %>
                    <div class="doc-subcategory">
                        <h4>For Partnership</h4>
                        <ul class="doc-list">
                            <li>Partnership deed</li>
                            <li>Reconstituted partnership deed</li>
                        </ul>
                    </div>
                    <% } %>
                    <% if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') { %>
                    <div class="doc-subcategory">
                        <h4>For Private Limited or Public Limited</h4>
                        <ul class="doc-list">
                            <li>Certificate of Incorporation</li>
                            <li>Memorandum of Association</li>
                            <li>Articles of Association</li>
                            <li>List of Shareholders of <%= proposal.applicantName %></li>
                            <li>List of Directors of <%= proposal.applicantName %></li>
                            <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                                <% proposal.coApplicants.forEach((co, idx) => { %>
                                    <% if (co.type !== 'Individual') { %>
                                        <li>List of Shareholders of <%= co.name || 'CoApplicant ' + (idx + 1) %></li>
                                        <li>List of Directors of <%= co.name || 'CoApplicant ' + (idx + 1) %></li>
                                    <% } %>
                                <% }); %>
                            <% } %>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Credit Reports -->
                <div class="doc-category">
                    <h3 class="category-title">Credit Reports</h3>
                    <ul class="doc-list">
                        <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>Personal Credit Report of <%= co.name %> (only for individuals)</li>
                            <% }); %>
                        <% } %>
                        <li>Business Credit Report of <%= proposal.applicantName %> (Non Individual)</li>
                    </ul>
                </div>

                <!-- Financials -->
                <div class="doc-category">
                    <h3 class="category-title">Financials</h3>
                    <div class="doc-subcategory">
                        <h4>Business</h4>
                        <ul class="doc-list">
                            <li>ITR of <%= currentFY %> of (<%= proposal.applicantName %>)</li>
                            <li>ITR of <%= previousFY %> of (<%= proposal.applicantName %>)</li>
                            <li>ITR of <%= precedingFY %> of (<%= proposal.applicantName %>)</li>
                            <li>Form 26AS of <%= currentFY %> of (<%= proposal.applicantName %>)</li>
                            <li>Form 26AS of <%= previousFY %> of (<%= proposal.applicantName %>)</li>
                            <li>Form 26AS of <%= precedingFY %> of (<%= proposal.applicantName %>)</li>
                        </ul>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                    <div class="doc-subcategory">
                        <h4>Personal</h4>
                        <ul class="doc-list">
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>ITR of <%= currentFY %> of (<%= co.name || 'CoApplicant ' + (idx + 1) %>)</li>
                                <li>ITR of <%= previousFY %> of (<%= co.name || 'coApplicant' + (idx + 1) + ' name' %>)</li>
                                <li>ITR of <%= precedingFY %> of (<%= co.name || 'coApplicant' + (idx + 1) + ' name' %>)</li>
                                <li>Form 26AS of <%= currentFY %> of (<%= co.name || 'CoApplicant ' + (idx + 1) %>)</li>
                                <li>Form 26AS of <%= previousFY %> of (<%= co.name || 'CoApplicant ' + (idx + 1) %>)</li>
                                <li>Form 26AS of <%= precedingFY %> of (<%= co.name || 'CoApplicant ' + (idx + 1) %>)</li>
                            <% }); %>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Banking -->
                <div class="doc-category">
                    <h3 class="category-title">Banking</h3>
                    <div class="doc-subcategory">
                        <h4>Business</h4>
                        <ul class="doc-list">
                            <li>Bank Statement of <%= proposal.applicantName %></li>
                            <li>Overdraft Bank Statement of <%= proposal.applicantName %></li>
                        </ul>
                    </div>
                    <% if (proposal.coApplicants && proposal.coApplicants.length > 0) { %>
                    <div class="doc-subcategory">
                        <h4>Personal</h4>
                        <ul class="doc-list">
                            <% proposal.coApplicants.forEach((co, idx) => { %>
                                <li>Bank Statement of <%= co.name || 'Coapplicant Name' + (idx + 1) %></li>
                            <% }); %>
                        </ul>
                    </div>
                    <% } %>
                </div>

                <!-- Turnover -->
                <div class="doc-category">
                    <h3 class="category-title">Turnover</h3>
                    <ul class="doc-list">
                        <li>GST 3B returns for last 12 months</li>
                        <li>GST 1 returns for last 12 months</li>
                    </ul>
                </div>

                <!-- Debt Profile -->
                <div class="doc-category">
                    <h3 class="category-title">Debt Profile</h3>
                    <ul class="doc-list">
                        <li>All Existing Loan Details</li>
                    </ul>
                </div>

                <!-- Collateral -->
                <div class="doc-category">
                    <h3 class="category-title">Collateral</h3>
                    <ul class="doc-list">
                        <li>Title Documents</li>
                        <li>Tax paid Receipts</li>
                        <li>Approved Sanction Plan</li>
                        <li>Encumberance Certificate</li>
                        <li>Title Documents - Unregistered</li>
                    </ul>
                </div>

                <p class="categorization-note">All uploaded documents needs to be categorised into below tabs</p>
            </div>

            <!-- Document Management Section with Main Tabs -->
            <div class="documents-management card">
                <h2>üìÅ Document Management</h2>
                
                <!-- Main Tab Navigation (Uploaded vs Pending) -->
                <div class="main-tab-navigation">
                    <button class="main-tab-btn active" onclick="showMainTab('uploaded')">
                        üì§ Uploaded Documents (<span id="fileCount"><%= uploadedFiles.length %></span>)
                    </button>
                    <button class="main-tab-btn" onclick="showMainTab('pending')">
                        ‚ö†Ô∏è Pending Documents
                    </button>
                </div>

                <!-- Uploaded Documents Section -->
                <div id="uploadedSection" class="main-tab-content">
                    <!-- Actions Bar -->
                    <% if (uploadedFiles.length > 0) { %>
                    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #555; font-weight: 500;">
                            üìä <%= uploadedFiles.length %> document(s) uploaded
                        </span>
                        <button onclick="reprocessAllDocuments()" class="btn btn-primary" style="font-size: 0.9em; padding: 8px 16px;">
                            üîÑ Reprocess All Documents
                        </button>
                    </div>
                    <% } %>
                    
                    <!-- Sub-Tab Navigation for Uploaded -->
                    <div class="tab-navigation">
                        <button class="tab-btn active" onclick="showTab('all')">ALL</button>
                        <button class="tab-btn" onclick="showTab('unclassified')">Unclassified</button>
                        <button class="tab-btn" onclick="showTab('personalId')">Personal ID</button>
                        <button class="tab-btn" onclick="showTab('businessId')">Business ID</button>
                        <button class="tab-btn" onclick="showTab('incorporation')">Incorporation</button>
                        <button class="tab-btn" onclick="showTab('creditReports')">Credit Reports</button>
                        <button class="tab-btn" onclick="showTab('financials')">Financials</button>
                        <button class="tab-btn" onclick="showTab('banking')">Banking</button>
                        <button class="tab-btn" onclick="showTab('turnover')">Turnover</button>
                        <button class="tab-btn" onclick="showTab('debtProfile')">Debt Profile</button>
                        <button class="tab-btn" onclick="showTab('collateral')">Collateral</button>
                    </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <% if (uploadedFiles.length === 0) { %>
                        <div class="empty-state-small">
                            <p>No documents uploaded yet</p>
                        </div>
                    <% } else { %>
                        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
                            <span id="selectedCount">0</span> document(s) selected
                            <button class="btn btn-danger" onclick="deleteSelectedDocuments()">üóëÔ∏è Delete Selected</button>
                        </div>
                        <div class="files-table-wrapper" id="filesTableWrapper">
                            <table class="files-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll(this)"></th>
                                        <th>Category</th>
                                        <th>File Name</th>
                                        <th>Size</th>
                                        <th>Pages</th>
                                        <th>Uploaded</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                        <th>Classification</th>
                                    </tr>
                                </thead>
                                <tbody id="filesTableBody">
                                    <% uploadedFiles.forEach(file => { %>
                                        <tr data-category="<%= file.category || 'all' %>" data-file-id="<%= file.id %>" data-classification="<%= file.classification || '' %>">
                                            <td><input type="checkbox" class="doc-checkbox" value="<%= file.id %>" onchange="updateBulkActions()"></td>
                                            <td>
                                                <span class="badge"><%= file.category || 'Uncategorized' %></span>
                                            </td>
                                            <td>
                                                <span class="file-icon-small">
                                                    <%= file.originalName.endsWith('.pdf') ? 'üìÑ' : file.originalName.match(/\.(jpg|jpeg|png)$/i) ? 'üñºÔ∏è' : 'üìù' %>
                                                </span>
                                                <%= file.originalName %>
                                            </td>
                                            <td><%= file.size %></td>
                                            <td><%= file.pages ? file.pages : 'N/A' %></td>
                                            <td><%= new Date(file.uploadedAt).toLocaleString() %></td>
                                            <td title="Uploaded"><span class="badge badge-success">‚úì</span></td>
                                            <td class="actions-cell">
                                                <button class="btn-view" 
                                                    onmouseenter="showPreview('<%= file.filename %>', '<%= file.originalName %>', '<%= proposalId %>', this)" 
                                                    onmouseleave="scheduleHidePreview()"
                                                    title="View document">
                                                    üëÅÔ∏è
                                                </button>
                                                <select class="category-select" onchange="updateCategory('<%= file.id %>', this.value)">
                                                    <option value="">Categorize...</option>
                                                    <option value="personalId" <%= file.category === 'personalId' ? 'selected' : '' %>>Personal ID</option>
                                                    <option value="businessId" <%= file.category === 'businessId' ? 'selected' : '' %>>Business ID</option>
                                                    <option value="incorporation" <%= file.category === 'incorporation' ? 'selected' : '' %>>Incorporation</option>
                                                    <option value="creditReports" <%= file.category === 'creditReports' ? 'selected' : '' %>>Credit Reports</option>
                                                    <option value="financials" <%= file.category === 'financials' ? 'selected' : '' %>>Financials</option>
                                                    <option value="banking" <%= file.category === 'banking' ? 'selected' : '' %>>Banking</option>
                                                    <option value="turnover" <%= file.category === 'turnover' ? 'selected' : '' %>>Turnover</option>
                                                    <option value="debtProfile" <%= file.category === 'debtProfile' ? 'selected' : '' %>>Debt Profile</option>
                                                    <option value="collateral" <%= file.category === 'collateral' ? 'selected' : '' %>>Collateral</option>
                                                </select>
                                                <button class="btn-delete" 
                                                    onclick="deleteDocument('<%= file.id %>', '<%= file.originalName %>')"
                                                    title="Delete document">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                            <td>
                                                <select class="classification-select" data-file-id="<%= file.id %>" data-category="<%= file.category %>" onchange="updateClassification('<%= file.id %>', this.value)">
                                                    <option value="">Select document type...</option>
                                                    <!-- Options will be populated by JavaScript based on category -->
                                                </select>
                                                <% if (file.classification) { %>
                                                    <input type="hidden" class="current-classification" value="<%= file.classification %>">
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                    </div>
                </div>

                <!-- Pending Documents Section -->
                <div id="pendingSection" class="main-tab-content" style="display: none;">
                    <!-- Sub-Tab Navigation for Pending -->
                    <div class="tab-navigation">
                        <% 
                        // Helper function to check if a document type is uploaded in a category
                        function isDocumentUploaded(category) {
                            return uploadedFiles.some(file => file.category === category);
                        }

                        // Get count of documents in a specific category
                        function getUploadedCountInCategory(category) {
                            return uploadedFiles.filter(file => file.category === category).length;
                        }
                        
                        // Get all classifications that have been assigned (normalized to lowercase for comparison)
                        function getClassifiedDocuments() {
                            return uploadedFiles
                                .filter(file => file.classification && file.classification.trim() !== '')
                                .map(file => file.classification.toLowerCase());
                        }

                        const classifiedDocs = getClassifiedDocuments();

                        // Helper function to check if a document is classified (flexible matching)
                        // Handles case differences and minor spelling variations (e.g., "enterprize" vs "enterprise")
                        function isDocClassified(docName) {
                            const docNameLower = docName.toLowerCase();

                            // First try exact match
                            if (classifiedDocs.includes(docNameLower)) {
                                return true;
                            }

                            // Extract document type prefix (e.g., "PAN Card of", "GST Certificate of")
                            const docTypePrefixes = [
                                'pan card of', 'aadhar card of', 'gst certificate of',
                                'labour license of', 'udyam certificate of', 'firm registration certificate of',
                                'itr of', 'bank statement of', 'overdraft bank statement of',
                                'personal credit report of', 'business credit report of',
                                'partnership deed', 'reconstituted partnership deed',
                                'certificate of incorporation', 'memorandum of association', 'articles of association',
                                'gst 3b returns', 'gst 1 returns', 'all existing loan details',
                                'title documents', 'tax paid receipts', 'approved sanction plan',
                                'encumberance certificate'
                            ];

                            // Find which prefix this document type uses
                            let matchedPrefix = null;
                            for (const prefix of docTypePrefixes) {
                                if (docNameLower.startsWith(prefix)) {
                                    matchedPrefix = prefix;
                                    break;
                                }
                            }

                            if (matchedPrefix) {
                                // Check if any classified doc starts with the same prefix
                                // and contains similar content (fuzzy match on name)
                                return classifiedDocs.some(classifiedDoc => {
                                    if (!classifiedDoc.startsWith(matchedPrefix)) return false;

                                    // Extract the name part after the prefix
                                    const expectedNamePart = docNameLower.substring(matchedPrefix.length).trim();
                                    const classifiedNamePart = classifiedDoc.substring(matchedPrefix.length).trim();

                                    // Check for fuzzy match - at least first word matches
                                    const expectedFirstWord = expectedNamePart.split(' ')[0];
                                    const classifiedFirstWord = classifiedNamePart.split(' ')[0];

                                    // If first word matches (handles "pragathi" matching)
                                    // and lengths are similar (handles "enterprize" vs "enterprise")
                                    if (expectedFirstWord === classifiedFirstWord) {
                                        return true;
                                    }

                                    // Also check if one contains the other (handles suffix differences)
                                    if (classifiedNamePart.includes(expectedFirstWord) ||
                                        expectedNamePart.includes(classifiedFirstWord)) {
                                        return true;
                                    }

                                    return false;
                                });
                            }

                            // For documents without "of" pattern, check if any classified doc contains key words
                            const keyWords = docNameLower.split(' ').filter(w => w.length > 3);
                            return classifiedDocs.some(cd =>
                                keyWords.every(kw => cd.includes(kw))
                            );
                        }
                        
                        // All document types by category (for dropdown options)
                        const allDocTypesByCategory = {
                            personalId: [],
                            businessId: [],
                            incorporation: [],
                            creditReports: [],
                            financials: [],
                            banking: [],
                            turnover: [],
                            debtProfile: [],
                            collateral: []
                        };
                        
                        // Populate ALL document types for each category (regardless of classification status)
                        // Personal ID
                        if (proposal.applicantType === 'Individual') {
                            allDocTypesByCategory.personalId.push('PAN Card of ' + (proposal.applicantName || proposal.customerName));
                            allDocTypesByCategory.personalId.push('Aadhar Card of ' + (proposal.applicantName || proposal.customerName));
                        }
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type === 'Individual') {
                                    allDocTypesByCategory.personalId.push('PAN Card of ' + co.name);
                                    allDocTypesByCategory.personalId.push('Aadhar Card of ' + co.name);
                                }
                            });
                        }
                        
                        // Business ID
                        if (proposal.applicantType !== 'Individual') {
                            allDocTypesByCategory.businessId.push('PAN Card of ' + (proposal.applicantName || 'Applicant Name') + ' (Non Individual)');
                            allDocTypesByCategory.businessId.push('GST Certificate of ' + (proposal.applicantName || 'Applicant Name'));
                            allDocTypesByCategory.businessId.push('Labour License of ' + (proposal.applicantName || 'Applicant Name'));
                            allDocTypesByCategory.businessId.push('UDYAM Certificate of ' + (proposal.applicantName || 'Applicant Name'));

                            // Firm Registration Certificate for Partnership or LLP applicant
                            if (proposal.applicantType === 'Partnership' || proposal.applicantType === 'LLP') {
                                allDocTypesByCategory.businessId.push('Firm Registration Certificate of ' + (proposal.applicantName || 'Applicant Name'));
                            }

                            // Firm Registration Certificate for Partnership or LLP co-applicants
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Partnership' || co.type === 'LLP') {
                                        allDocTypesByCategory.businessId.push('Firm Registration Certificate of ' + co.name);
                                    }
                                });
                            }
                        }
                        
                        // Incorporation
                        if (proposal.applicantType === 'Partnership') {
                            allDocTypesByCategory.incorporation.push('Partnership deed - Date of deed, Profit & Loss share of partners');
                            allDocTypesByCategory.incorporation.push('Reconstituted partnership deed - Date of deed, Profit & Loss share of partners');
                        } else if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') {
                            allDocTypesByCategory.incorporation.push('Certificate of Incorporation');
                            allDocTypesByCategory.incorporation.push('Memorandum of Association');
                            allDocTypesByCategory.incorporation.push('Articles of Association');
                            allDocTypesByCategory.incorporation.push('List of Shareholders of ' + proposal.applicantName);
                            allDocTypesByCategory.incorporation.push('List of Directors of ' + proposal.applicantName);
                        }
                        // Add shareholder and director list for non-individual co-applicants (Private Limited only)
                        if ((proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') &&
                            proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type !== 'Individual') {
                                    allDocTypesByCategory.incorporation.push('List of Shareholders of ' + (co.name || 'CoApplicant ' + (idx + 1)));
                                    allDocTypesByCategory.incorporation.push('List of Directors of ' + (co.name || 'CoApplicant ' + (idx + 1)));
                                }
                            });
                        }
                        
                        // Credit Reports
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type === 'Individual') {
                                    allDocTypesByCategory.creditReports.push('Personal Credit Report of ' + co.name);
                                }
                            });
                        }
                        if (proposal.applicantType !== 'Individual') {
                            allDocTypesByCategory.creditReports.push('Business Credit Report of ' + proposal.applicantName);
                        }
                        
                        // Financials
                        allDocTypesByCategory.financials.push('ITR of ' + currentFY + ' of ' + proposal.applicantName);
                        allDocTypesByCategory.financials.push('ITR of ' + previousFY + ' of ' + proposal.applicantName);
                        allDocTypesByCategory.financials.push('ITR of ' + precedingFY + ' of ' + proposal.applicantName);
                        allDocTypesByCategory.financials.push('Form 26AS of ' + currentFY + ' of ' + proposal.applicantName);
                        allDocTypesByCategory.financials.push('Form 26AS of ' + previousFY + ' of ' + proposal.applicantName);
                        allDocTypesByCategory.financials.push('Form 26AS of ' + precedingFY + ' of ' + proposal.applicantName);
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type === 'Individual') {
                                    allDocTypesByCategory.financials.push('ITR of ' + currentFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1)));
                                    allDocTypesByCategory.financials.push('ITR of ' + previousFY + ' of ' + (co.name || 'coApplicant' + (idx + 1) + ' name'));
                                    allDocTypesByCategory.financials.push('ITR of ' + precedingFY + ' of ' + (co.name || 'coApplicant' + (idx + 1) + ' name'));
                                    allDocTypesByCategory.financials.push('Form 26AS of ' + currentFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1)));
                                    allDocTypesByCategory.financials.push('Form 26AS of ' + previousFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1)));
                                    allDocTypesByCategory.financials.push('Form 26AS of ' + precedingFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1)));
                                }
                            });
                        }
                        
                        // Banking
                        allDocTypesByCategory.banking.push('Bank Statement of ' + proposal.applicantName);
                        allDocTypesByCategory.banking.push('Overdraft Bank Statement of ' + proposal.applicantName);
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type === 'Individual') {
                                    allDocTypesByCategory.banking.push('Bank Statement of ' + (co.name || 'Coapplicant Name' + (idx + 1)));
                                }
                            });
                        }
                        
                        // Turnover
                        allDocTypesByCategory.turnover.push('GST 3B returns for last 12 months');
                        allDocTypesByCategory.turnover.push('GST 1 returns for last 12 months');
                        
                        // Debt Profile
                        allDocTypesByCategory.debtProfile.push('All Existing Loan Details');
                        
                        // Collateral
                        allDocTypesByCategory.collateral.push('Title Documents');
                        allDocTypesByCategory.collateral.push('Tax paid Receipts');
                        allDocTypesByCategory.collateral.push('Approved Sanction Plan');
                        allDocTypesByCategory.collateral.push('Encumberance Certificate');
                        allDocTypesByCategory.collateral.push('Title Documents - Unregistered');

                        // Categorize pending documents based on what's NOT uploaded OR not classified
                        const pendingByCategory = {
                            personalId: [],
                            businessId: [],
                            incorporation: [],
                            creditReports: [],
                            financials: [],
                            banking: [],
                            turnover: [],
                            debtProfile: [],
                            collateral: []
                        };

                        // Count uploaded documents by category
                        const uploadedPersonalIdCount = getUploadedCountInCategory('personalId');
                        
                        // Personal ID documents - check for each individual
                        let requiredPersonalIdCount = 0;
                        if (proposal.applicantType === 'Individual') {
                            requiredPersonalIdCount += 2; // PAN + Aadhar for applicant
                        }
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach(co => {
                                if (co.type === 'Individual') {
                                    requiredPersonalIdCount += 2; // PAN + Aadhar for each individual co-applicant
                                }
                            });
                        }

                        // Add pending personal ID docs
                        if (uploadedPersonalIdCount < requiredPersonalIdCount) {
                            if (proposal.applicantType === 'Individual') {
                                const pan1 = 'PAN Card of ' + (proposal.applicantName || proposal.customerName);
                                const aadhar1 = 'Aadhar Card of ' + (proposal.applicantName || proposal.customerName);
                                if (!isDocClassified(pan1)) pendingByCategory.personalId.push(pan1);
                                if (!isDocClassified(aadhar1)) pendingByCategory.personalId.push(aadhar1);
                            }
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Individual') {
                                        const pan = 'PAN Card of ' + co.name;
                                        const aadhar = 'Aadhar Card of ' + co.name;
                                        if (!isDocClassified(pan)) pendingByCategory.personalId.push(pan);
                                        if (!isDocClassified(aadhar)) pendingByCategory.personalId.push(aadhar);
                                    }
                                });
                            }
                        }

                        // Business ID (only for non-individual)
                        if (proposal.applicantType !== 'Individual') {
                            const bizPan = 'PAN Card of ' + (proposal.applicantName || 'Applicant Name') + ' (Non Individual)';
                            const gst = 'GST Certificate of ' + (proposal.applicantName || 'Applicant Name');
                            const labour = 'Labour License of ' + (proposal.applicantName || 'Applicant Name');
                            const udyam = 'UDYAM Certificate of ' + (proposal.applicantName || 'Applicant Name');
                            if (!isDocClassified(bizPan)) pendingByCategory.businessId.push(bizPan);
                            if (!isDocClassified(gst)) pendingByCategory.businessId.push(gst);
                            if (!isDocClassified(labour)) pendingByCategory.businessId.push(labour);
                            if (!isDocClassified(udyam)) pendingByCategory.businessId.push(udyam);

                            // Firm Registration Certificate for Partnership or LLP applicant
                            if (proposal.applicantType === 'Partnership' || proposal.applicantType === 'LLP') {
                                const firmRegCert = 'Firm Registration Certificate of ' + (proposal.applicantName || 'Applicant Name');
                                if (!isDocClassified(firmRegCert)) pendingByCategory.businessId.push(firmRegCert);
                            }

                            // Firm Registration Certificate for Partnership or LLP co-applicants
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Partnership' || co.type === 'LLP') {
                                        const coFirmRegCert = 'Firm Registration Certificate of ' + co.name;
                                        if (!isDocClassified(coFirmRegCert)) pendingByCategory.businessId.push(coFirmRegCert);
                                    }
                                });
                            }
                        }

                        // Incorporation - Always show for Partnership to display required details
                        if (proposal.applicantType === 'Partnership') {
                            // Always show partnership deed requirements with details to extract
                            const partnerDeed = 'Partnership deed - Date of deed, Profit & Loss share of partners';
                            const reconstitutedDeed = 'Reconstituted partnership deed - Date of deed, Profit & Loss share of partners';
                            if (!isDocClassified(partnerDeed)) pendingByCategory.incorporation.push(partnerDeed);
                            if (!isDocClassified(reconstitutedDeed)) pendingByCategory.incorporation.push(reconstitutedDeed);
                        } else if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') {
                            const cert = 'Certificate of Incorporation';
                            const moa = 'Memorandum of Association';
                            const aoa = 'Articles of Association';
                            const shareholderList = 'List of Shareholders of ' + proposal.applicantName;
                            const directorList = 'List of Directors of ' + proposal.applicantName;
                            if (!isDocClassified(cert)) pendingByCategory.incorporation.push(cert);
                            if (!isDocClassified(moa)) pendingByCategory.incorporation.push(moa);
                            if (!isDocClassified(aoa)) pendingByCategory.incorporation.push(aoa);
                            if (!isDocClassified(shareholderList)) pendingByCategory.incorporation.push(shareholderList);
                            if (!isDocClassified(directorList)) pendingByCategory.incorporation.push(directorList);
                        }
                        // Add shareholder and director list for non-individual co-applicants (Private Limited only)
                        if ((proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') &&
                            proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type !== 'Individual') {
                                    const coShareholderList = 'List of Shareholders of ' + (co.name || 'CoApplicant ' + (idx + 1));
                                    const coDirectorList = 'List of Directors of ' + (co.name || 'CoApplicant ' + (idx + 1));
                                    if (!isDocClassified(coShareholderList)) pendingByCategory.incorporation.push(coShareholderList);
                                    if (!isDocClassified(coDirectorList)) pendingByCategory.incorporation.push(coDirectorList);
                                }
                            });
                        }

                        // Credit Reports
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type === 'Individual') {
                                    const creditReport = 'Personal Credit Report of ' + co.name;
                                    if (!isDocClassified(creditReport)) pendingByCategory.creditReports.push(creditReport);
                                }
                            });
                        }
                        if (proposal.applicantType !== 'Individual') {
                            const bizCreditReport = 'Business Credit Report of ' + proposal.applicantName;
                            if (!isDocClassified(bizCreditReport)) pendingByCategory.creditReports.push(bizCreditReport);
                        }

                        // Financials
                        const itrCurrent = 'ITR of ' + currentFY + ' of ' + proposal.applicantName;
                        const itrPrevious = 'ITR of ' + previousFY + ' of ' + proposal.applicantName;
                        const itrPreceding = 'ITR of ' + precedingFY + ' of ' + proposal.applicantName;
                        const form26asCurrent = 'Form 26AS of ' + currentFY + ' of ' + proposal.applicantName;
                        const form26asPrevious = 'Form 26AS of ' + previousFY + ' of ' + proposal.applicantName;
                        const form26asPreceding = 'Form 26AS of ' + precedingFY + ' of ' + proposal.applicantName;
                        if (!isDocClassified(itrCurrent)) pendingByCategory.financials.push(itrCurrent);
                        if (!isDocClassified(itrPrevious)) pendingByCategory.financials.push(itrPrevious);
                        if (!isDocClassified(itrPreceding)) pendingByCategory.financials.push(itrPreceding);
                        if (!isDocClassified(form26asCurrent)) pendingByCategory.financials.push(form26asCurrent);
                        if (!isDocClassified(form26asPrevious)) pendingByCategory.financials.push(form26asPrevious);
                        if (!isDocClassified(form26asPreceding)) pendingByCategory.financials.push(form26asPreceding);

                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type === 'Individual') {
                                    const coItrCurrent = 'ITR of ' + currentFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1));
                                    const coItrPrevious = 'ITR of ' + previousFY + ' of ' + (co.name || 'coApplicant' + (idx + 1) + ' name');
                                    const coItrPreceding = 'ITR of ' + precedingFY + ' of ' + (co.name || 'coApplicant' + (idx + 1) + ' name');
                                    const coForm26asCurrent = 'Form 26AS of ' + currentFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1));
                                    const coForm26asPrevious = 'Form 26AS of ' + previousFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1));
                                    const coForm26asPreceding = 'Form 26AS of ' + precedingFY + ' of ' + (co.name || 'CoApplicant ' + (idx + 1));
                                    if (!isDocClassified(coItrCurrent)) pendingByCategory.financials.push(coItrCurrent);
                                    if (!isDocClassified(coItrPrevious)) pendingByCategory.financials.push(coItrPrevious);
                                    if (!isDocClassified(coItrPreceding)) pendingByCategory.financials.push(coItrPreceding);
                                    if (!isDocClassified(coForm26asCurrent)) pendingByCategory.financials.push(coForm26asCurrent);
                                    if (!isDocClassified(coForm26asPrevious)) pendingByCategory.financials.push(coForm26asPrevious);
                                    if (!isDocClassified(coForm26asPreceding)) pendingByCategory.financials.push(coForm26asPreceding);
                                }
                            });
                        }

                        // Banking - Calculate 12 month period requirement
                        const today = new Date();
                        const oneYearAgo = new Date(today);
                        oneYearAgo.setFullYear(today.getFullYear() - 1);
                        const formatDate = (d) => String(d.getDate()).padStart(2, '0') + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + d.getFullYear();
                        const requiredFromDate = oneYearAgo;
                        const requiredToDate = today;
                        const periodFrom = formatDate(oneYearAgo);
                        const periodTo = formatDate(today);

                        // Helper to parse date from dd/mm/yyyy or dd-mm-yyyy format
                        const parseDate = (dateStr) => {
                            if (!dateStr || dateStr === 'N/A') return null;
                            const parts = dateStr.split(/[\/\-]/);
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1;
                                const year = parseInt(parts[2].length === 2 ? '20' + parts[2] : parts[2]);
                                return new Date(year, month, day);
                            }
                            return null;
                        };

                        // Get all banking docs for this proposal
                        const bankingDocsForPending = uploadedFiles.filter(f => f.category === 'banking');

                        // Get banking docs with extracted details (bank name, account number, period)
                        const bankingDocsWithDetails = bankingDocsForPending.filter(f =>
                            f.extractedDetails &&
                            f.extractedDetails.bankName &&
                            f.extractedDetails.bankName !== 'N/A'
                        );

                        const bankStmt = 'Bank Statement of ' + proposal.applicantName;
                        const odStmt = 'Overdraft Bank Statement of ' + proposal.applicantName;

                        // Group bank statements by account (bankName + accountNumber)
                        const accountGroups = {};
                        bankingDocsWithDetails.forEach(doc => {
                            const details = doc.extractedDetails || {};
                            const bankName = details.bankName || 'Unknown Bank';
                            const acNo = details.accountNumber && details.accountNumber !== 'N/A' ? details.accountNumber : 'XXXX';
                            const holderName = details.accountHolder && details.accountHolder !== 'N/A' ? details.accountHolder : proposal.applicantName;
                            const key = bankName + '_' + acNo;

                            if (!accountGroups[key]) {
                                accountGroups[key] = {
                                    bankName: bankName,
                                    accountNumber: acNo,
                                    holderName: holderName,
                                    periods: []
                                };
                            }

                            const docFrom = parseDate(details.periodFrom);
                            const docTo = parseDate(details.periodTo);
                            if (docFrom && docTo) {
                                accountGroups[key].periods.push({ from: docFrom, to: docTo });
                            }
                        });

                        // Check if there are any bank statements uploaded with details
                        const accountKeys = Object.keys(accountGroups);
                        if (accountKeys.length > 0) {
                            // Process each account group
                            accountKeys.forEach(key => {
                                const account = accountGroups[key];

                                if (account.periods.length === 0) {
                                    // No valid periods extracted
                                    pendingByCategory.banking.push(`Bank Statement(${account.bankName}) of ${account.holderName} of AC no ${account.accountNumber} for period missing`);
                                    return;
                                }

                                // Sort periods by start date
                                account.periods.sort((a, b) => a.from - b.from);

                                // Merge overlapping/adjacent periods
                                const mergedPeriods = [];
                                account.periods.forEach(period => {
                                    if (mergedPeriods.length === 0) {
                                        mergedPeriods.push({ from: period.from, to: period.to });
                                    } else {
                                        const last = mergedPeriods[mergedPeriods.length - 1];
                                        // Check if periods overlap or are adjacent (within 1 day)
                                        if (period.from <= new Date(last.to.getTime() + 86400000)) {
                                            // Extend the last period if this one goes further
                                            if (period.to > last.to) {
                                                last.to = period.to;
                                            }
                                        } else {
                                            mergedPeriods.push({ from: period.from, to: period.to });
                                        }
                                    }
                                });

                                // Find gaps in coverage
                                const gaps = [];

                                // Gap at start?
                                if (mergedPeriods[0].from > requiredFromDate) {
                                    gaps.push({
                                        from: requiredFromDate,
                                        to: new Date(mergedPeriods[0].from.getTime() - 86400000)
                                    });
                                }

                                // Gaps between periods?
                                for (let i = 0; i < mergedPeriods.length - 1; i++) {
                                    const gapStart = new Date(mergedPeriods[i].to.getTime() + 86400000);
                                    const gapEnd = new Date(mergedPeriods[i + 1].from.getTime() - 86400000);
                                    if (gapStart <= gapEnd) {
                                        gaps.push({ from: gapStart, to: gapEnd });
                                    }
                                }

                                // Gap at end?
                                const lastPeriod = mergedPeriods[mergedPeriods.length - 1];
                                if (lastPeriod.to < requiredToDate) {
                                    gaps.push({
                                        from: new Date(lastPeriod.to.getTime() + 86400000),
                                        to: requiredToDate
                                    });
                                }

                                // Add pending items for each gap
                                gaps.forEach(gap => {
                                    const missingDays = Math.ceil((gap.to - gap.from) / (1000 * 60 * 60 * 24)) + 1;
                                    pendingByCategory.banking.push(`Bank Statement(${account.bankName}) of ${account.holderName} of AC no ${account.accountNumber} for period ${formatDate(gap.from)} to ${formatDate(gap.to)} (${missingDays} days)`);
                                });
                            });
                        } else if (bankingDocsForPending.length > 0) {
                            // Banking docs exist but no extracted details - prompt for extraction
                            pendingByCategory.banking.push(`Bank Statement details not extracted - click "Re-extract Bank Statement Details" to extract period information`);
                        } else if (!isDocClassified(bankStmt)) {
                            // No bank statement uploaded at all
                            pendingByCategory.banking.push(`Bank Statement of ${proposal.applicantName} from ${periodFrom} to ${periodTo} (12 months bank statement)`);
                        }

                        if (!isDocClassified(odStmt)) pendingByCategory.banking.push(odStmt);

                        // Check coapplicants - only if they don't have bank statements in the uploaded docs
                        if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                            proposal.coApplicants.forEach((co, idx) => {
                                if (co.type === 'Individual') {
                                    const coName = co.name || 'Coapplicant ' + (idx + 1);
                                    const coStmt = 'Bank Statement of ' + coName;

                                    // Check if this coapplicant already has statements in accountGroups
                                    const coFirstName = coName.toLowerCase().split(' ')[0];
                                    const hasStatements = accountKeys.some(key => {
                                        const acc = accountGroups[key];
                                        return acc.holderName.toLowerCase().includes(coFirstName);
                                    });

                                    if (!hasStatements && !isDocClassified(coStmt)) {
                                        // No bank statement for this coapplicant
                                        pendingByCategory.banking.push(`Bank Statement of ${coName} from ${periodFrom} to ${periodTo} (12 months bank statement)`);
                                    }
                                }
                            });
                        }

                        // Turnover
                        const gst3b = 'GST 3B returns for last 12 months';
                        const gst1 = 'GST 1 returns for last 12 months';
                        if (!isDocClassified(gst3b)) pendingByCategory.turnover.push(gst3b);
                        if (!isDocClassified(gst1)) pendingByCategory.turnover.push(gst1);

                        // Debt Profile
                        const debtDoc = 'All Existing Loan Details';
                        if (!isDocClassified(debtDoc)) pendingByCategory.debtProfile.push(debtDoc);

                        // EMI Verification for Debt Profile
                        if (debtProfiles && debtProfiles.length > 0) {
                            // EMI Calculation function
                            const calcEMI = (principal, annualRate, tenureMonths) => {
                                if (!principal || !annualRate || !tenureMonths || principal <= 0 || tenureMonths <= 0) return null;
                                const monthlyRate = annualRate / 12 / 100;
                                if (monthlyRate === 0) return Math.round(principal / tenureMonths);
                                return Math.round(principal * monthlyRate * Math.pow(1 + monthlyRate, tenureMonths) / (Math.pow(1 + monthlyRate, tenureMonths) - 1));
                            };

                            debtProfiles.forEach(profile => {
                                const calculatedEMI = calcEMI(profile.loanAmount, profile.roi, profile.tenure);
                                if (calculatedEMI && profile.emi) {
                                    const tolerance = calculatedEMI * 0.02; // 2% tolerance
                                    if (Math.abs(profile.emi - calculatedEMI) > tolerance) {
                                        const diff = Math.abs(profile.emi - calculatedEMI);
                                        pendingByCategory.debtProfile.push(
                                            `EMI Mismatch: ${profile.bank} ${profile.loanType} - Entered EMI ‚Çπ${profile.emi.toLocaleString('en-IN')} vs Calculated EMI ‚Çπ${calculatedEMI.toLocaleString('en-IN')} (Diff: ‚Çπ${diff.toLocaleString('en-IN')})`
                                        );
                                    }
                                }
                            });
                        }

                        // Collateral
                        const titleDocs = 'Title Documents';
                        const taxReceipts = 'Tax paid Receipts';
                        const sanctionPlan = 'Approved Sanction Plan';
                        const encumbCert = 'Encumberance Certificate';
                        const titleUnreg = 'Title Documents - Unregistered';
                        if (!isDocClassified(titleDocs)) pendingByCategory.collateral.push(titleDocs);
                        if (!isDocClassified(taxReceipts)) pendingByCategory.collateral.push(taxReceipts);
                        if (!isDocClassified(sanctionPlan)) pendingByCategory.collateral.push(sanctionPlan);
                        if (!isDocClassified(encumbCert)) pendingByCategory.collateral.push(encumbCert);
                        if (!isDocClassified(titleUnreg)) pendingByCategory.collateral.push(titleUnreg);

                        // Calculate all pending documents
                        let allPending = [];
                        Object.keys(pendingByCategory).forEach(cat => {
                            allPending = allPending.concat(pendingByCategory[cat]);
                        });
                        %>
                        <button class="tab-btn-pending active" onclick="showPendingTab('all')">ALL (<%= allPending.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('personalId')">Personal ID (<%= pendingByCategory.personalId.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('businessId')">Business ID (<%= pendingByCategory.businessId.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('incorporation')">Incorporation (<%= pendingByCategory.incorporation.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('creditReports')">Credit Reports (<%= pendingByCategory.creditReports.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('financials')">Financials (<%= pendingByCategory.financials.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('banking')">Banking (<%= pendingByCategory.banking.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('turnover')">Turnover (<%= pendingByCategory.turnover.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('debtProfile')">Debt Profile (<%= pendingByCategory.debtProfile.length %>)</button>
                        <button class="tab-btn-pending" onclick="showPendingTab('collateral')">Collateral (<%= pendingByCategory.collateral.length %>)</button>
                    </div>
                
                    <!-- Pending Documents Content -->
                    <div id="pendingTabContent" class="pending-tab-content">

                    <% if (allPending.length === 0) { %>
                        <div class="success-message">
                            ‚úì All required documents have been uploaded!
                        </div>
                    <% } else { %>
                        <!-- All Pending -->
                        <div class="pending-category-content" data-pending-category="all">
                            <ul class="pending-list">
                                <% allPending.forEach(doc => { %>
                                    <li class="pending-item">
                                        <span class="warning-icon">‚ö†Ô∏è</span>
                                        <%= doc %>
                                    </li>
                                <% }); %>
                            </ul>
                        </div>

                        <!-- Personal ID Pending -->
                        <div class="pending-category-content" data-pending-category="personalId" style="display: none;">
                            <% if (pendingByCategory.personalId.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.personalId.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Personal ID documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Business ID Pending -->
                        <div class="pending-category-content" data-pending-category="businessId" style="display: none;">
                            <% if (pendingByCategory.businessId.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.businessId.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Business ID documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Incorporation Pending -->
                        <div class="pending-category-content" data-pending-category="incorporation" style="display: none;">
                            <% if (pendingByCategory.incorporation.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.incorporation.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Incorporation documents uploaded!</p>
                            <% } %>
                            
                            <!-- Partnership Information Requirements -->
                            <% if (proposal.applicantType === 'Partnership') { %>
                                <%
                                    const incorporationDocs = uploadedFiles.filter(f => f.category === 'incorporation');
                                    let hasExtractedDate = false;
                                    let hasExtractedPartners = false;
                                    
                                    incorporationDocs.forEach(doc => {
                                        if (doc.extractedDetails) {
                                            if (doc.extractedDetails.deedDate) hasExtractedDate = true;
                                            if (doc.extractedDetails.partners && doc.extractedDetails.partners.length > 0) hasExtractedPartners = true;
                                        }
                                    });
                                %>
                                
                                <div style="margin-top: 20px; padding: 15px; background: <%= (!hasExtractedDate || !hasExtractedPartners) ? '#fff3e0' : '#e8f5e9' %>; border-radius: 8px; border-left: 4px solid <%= (!hasExtractedDate || !hasExtractedPartners) ? '#f57c00' : '#4caf50' %>;">
                                    <h4 style="margin: 0 0 15px 0; color: <%= (!hasExtractedDate || !hasExtractedPartners) ? '#e65100' : '#2e7d32' %>;">
                                        üìã Required Partnership Information
                                    </h4>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: white; border-radius: 5px; margin-bottom: 8px;">
                                            <span style="font-size: 1.2em;"><%= hasExtractedDate ? '‚úÖ' : '‚ö†Ô∏è' %></span>
                                            <strong>Date of Execution:</strong>
                                            <span style="color: <%= hasExtractedDate ? '#2e7d32' : '#d32f2f' %>; flex: 1;">
                                                <%= hasExtractedDate ? 'Extracted' : 'Not yet extracted from deed' %>
                                            </span>
                                        </div>
                                        
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: white; border-radius: 5px;">
                                            <span style="font-size: 1.2em;"><%= hasExtractedPartners ? '‚úÖ' : '‚ö†Ô∏è' %></span>
                                            <strong>Profit-Sharing Ratio (Partner names with %):</strong>
                                            <span style="color: <%= hasExtractedPartners ? '#2e7d32' : '#d32f2f' %>; flex: 1;">
                                                <%= hasExtractedPartners ? 'Extracted' : 'Not yet extracted from deed' %>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <% if (!hasExtractedDate || !hasExtractedPartners) { %>
                                        <div style="margin-top: 12px; padding: 10px; background: #fff8e1; border-left: 3px solid #fbc02d; border-radius: 4px;">
                                            <strong>‚ö†Ô∏è Action Required:</strong> Upload partnership deed PDFs and click the "Re-extract Information" button below to automatically extract required information.
                                        </div>
                                    <% } %>
                                </div>
                            <% } %>
                            
                            <!-- Show extracted details from uploaded partnership deeds -->
                            <% 
                            const incorporationDocsForDisplay = uploadedFiles.filter(f => f.category === 'incorporation');
                            if (incorporationDocsForDisplay.length > 0 && proposal.applicantType === 'Partnership') { %>
                                <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h4 style="margin: 0; color: #2e7d32;">üìÑ Extracted Partnership Information</h4>
                                        <button onclick="reprocessIncorporationDocs()" class="btn btn-primary" style="font-size: 0.85em; padding: 6px 12px;">
                                            üîÑ Re-extract Information
                                        </button>
                                    </div>
                                    
                                    <% incorporationDocsForDisplay.forEach(doc => { %>
                                        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);";>
                                            <strong style="color: #1976d2; font-size: 1.05em;">üìã <%= doc.originalName %></strong>
                                            
                                            <% if (doc.extractedDetails) { %>
                                                <div style="margin-top: 12px;">
                                                    <!-- Date -->
                                                    <% if (doc.extractedDetails.deedDate) { %>
                                                        <div style="margin-bottom: 15px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
                                                            <strong>üìÖ Date of Execution:</strong> 
                                                            <span style="color: #2e7d32; font-weight: 500;"><%= doc.extractedDetails.deedDate %></span>
                                                        </div>
                                                    <% } else { %>
                                                        <div style="margin-bottom: 15px; padding: 8px; background: #ffebee; border-radius: 4px;">
                                                            <strong>üìÖ Date of Execution:</strong> 
                                                            <span style="color: #d32f2f;">Not found in document</span>
                                                        </div>
                                                    <% } %>
                                                    
                                                    <!-- Profit & Loss Sharing Table -->
                                                    <% if (doc.extractedDetails.partners && doc.extractedDetails.partners.length > 0) { %>
                                                        <div style="margin-top: 10px;">
                                                            <strong style="display: block; margin-bottom: 8px;">üí∞ Profit & Loss Sharing Ratio:</strong>
                                                            <table style="width: 100%; border-collapse: collapse; background: #fafafa; border-radius: 4px; overflow: hidden;">
                                                                <thead>
                                                                    <tr style="background: #1976d2; color: white;">
                                                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Partner</th>
                                                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 120px;">Profit %</th>
                                                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd; width: 120px;">Loss %</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <% doc.extractedDetails.partners.forEach((partner, idx) => { %>
                                                                        <tr style="<%= idx % 2 === 0 ? 'background: white;' : 'background: #f9f9f9;' %>">
                                                                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: 500;"><%= partner.name %></td>
                                                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #2e7d32; font-weight: 600;">
                                                                                <%= partner.profitPercent %><%= partner.profitPercent !== 'Not specified' ? '%' : '' %>
                                                                            </td>
                                                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #d32f2f; font-weight: 600;">
                                                                                <%= partner.lossPercent %><%= partner.lossPercent !== 'Not specified' ? '%' : '' %>
                                                                            </td>
                                                                        </tr>
                                                                    <% }); %>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    <% } else { %>
                                                        <div style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 4px;">
                                                            <strong>üí∞ Profit & Loss Sharing:</strong> 
                                                            <span style="color: #d32f2f;">Not found in document</span>
                                                        </div>
                                                    <% } %>
                                                </div>
                                            <% } else { %>
                                                <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 4px;">
                                                    <em style="color: #f57c00;">‚ö†Ô∏è No extraction data. Click "Re-extract Information" button above.</em>
                                                </div>
                                            <% } %>
                                        </div>
                                    <% }); %>
                                </div>
                            <% } %>

                            <!-- Private Limited Company Information -->
                            <% if (proposal.applicantType === 'Private Limited' || proposal.applicantType === 'Public Limited') { %>
                                <%
                                    const pvtLtdDocs = uploadedFiles.filter(f => f.category === 'incorporation');
                                    let hasExtractedShareholders = false;
                                    let hasExtractedDirectors = false;
                                    let extractedShareholders = [];
                                    let extractedDirectors = [];
                                    let companyName = proposal.applicantName;

                                    pvtLtdDocs.forEach(doc => {
                                        if (doc.extractedDetails) {
                                            if (doc.extractedDetails.shareholders && doc.extractedDetails.shareholders.length > 0) {
                                                hasExtractedShareholders = true;
                                                extractedShareholders = extractedShareholders.concat(doc.extractedDetails.shareholders);
                                            }
                                            if (doc.extractedDetails.directors && doc.extractedDetails.directors.length > 0) {
                                                hasExtractedDirectors = true;
                                                extractedDirectors = extractedDirectors.concat(doc.extractedDetails.directors);
                                            }
                                            if (doc.extractedDetails.companyName) {
                                                companyName = doc.extractedDetails.companyName;
                                            }
                                        }
                                    });

                                    // Remove duplicates
                                    extractedShareholders = [...new Map(extractedShareholders.map(s => [s.name, s])).values()];
                                    extractedDirectors = [...new Map(extractedDirectors.map(d => [d.name, d])).values()];
                                %>

                                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1976d2;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h4 style="margin: 0; color: #1565c0;">üè¢ <%= companyName %></h4>
                                        <button onclick="reprocessIncorporationDocs()" class="btn btn-primary" style="font-size: 0.85em; padding: 6px 12px;">
                                            üîÑ Re-extract Information
                                        </button>
                                    </div>

                                    <!-- Shareholders Section -->
                                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                            <span style="font-size: 1.2em;"><%= hasExtractedShareholders ? '‚úÖ' : '‚ö†Ô∏è' %></span>
                                            <strong style="color: #1976d2; font-size: 1.05em;">üë• List of Shareholders</strong>
                                        </div>

                                        <% if (hasExtractedShareholders && extractedShareholders.length > 0) { %>
                                            <table style="width: 100%; border-collapse: collapse; background: #fafafa; border-radius: 4px; overflow: hidden;">
                                                <thead>
                                                    <tr style="background: #1976d2; color: white;">
                                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">S.No</th>
                                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Shareholder Name</th>
                                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">No. of Shares</th>
                                                        <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Share %</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% extractedShareholders.forEach((shareholder, idx) => { %>
                                                        <tr style="<%= idx % 2 === 0 ? 'background: white;' : 'background: #f9f9f9;' %>">
                                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;"><%= idx + 1 %></td>
                                                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: 500;"><%= shareholder.name %></td>
                                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;"><%= shareholder.shares || '-' %></td>
                                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #2e7d32; font-weight: 600;">
                                                                <%= shareholder.percentage ? shareholder.percentage + '%' : '-' %>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        <% } else { %>
                                            <div style="padding: 12px; background: #fff3e0; border-radius: 4px; color: #e65100;">
                                                ‚ö†Ô∏è Shareholders not yet extracted. Upload shareholder documents and click "Re-extract Information".
                                            </div>
                                        <% } %>
                                    </div>

                                    <!-- Directors Section -->
                                    <div style="padding: 15px; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                            <span style="font-size: 1.2em;"><%= hasExtractedDirectors ? '‚úÖ' : '‚ö†Ô∏è' %></span>
                                            <strong style="color: #1976d2; font-size: 1.05em;">üëî List of Directors</strong>
                                        </div>

                                        <% if (hasExtractedDirectors && extractedDirectors.length > 0) { %>
                                            <table style="width: 100%; border-collapse: collapse; background: #fafafa; border-radius: 4px; overflow: hidden;">
                                                <thead>
                                                    <tr style="background: #1976d2; color: white;">
                                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">S.No</th>
                                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Director Name</th>
                                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">DIN</th>
                                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Designation</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% extractedDirectors.forEach((director, idx) => { %>
                                                        <tr style="<%= idx % 2 === 0 ? 'background: white;' : 'background: #f9f9f9;' %>">
                                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;"><%= idx + 1 %></td>
                                                            <td style="padding: 10px; border: 1px solid #ddd; font-weight: 500;"><%= director.name %></td>
                                                            <td style="padding: 10px; border: 1px solid #ddd;"><%= director.din || '-' %></td>
                                                            <td style="padding: 10px; border: 1px solid #ddd;"><%= director.designation || '-' %></td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        <% } else { %>
                                            <div style="padding: 12px; background: #fff3e0; border-radius: 4px; color: #e65100;">
                                                ‚ö†Ô∏è Directors not yet extracted. Upload director documents and click "Re-extract Information".
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            <% } %>
                        </div>

                        <!-- Credit Reports Pending -->
                        <div class="pending-category-content" data-pending-category="creditReports" style="display: none;">
                            <% if (pendingByCategory.creditReports.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.creditReports.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Credit Reports uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Financials Pending -->
                        <div class="pending-category-content" data-pending-category="financials" style="display: none;">
                            <%
                            // Get all financial documents
                            const financialDocs = uploadedFiles.filter(f => f.category === 'financials');

                            // Define financial years (current and previous 2 years)
                            const currentYear = new Date().getFullYear();
                            const currentMonth = new Date().getMonth(); // 0-11
                            // If before April, current FY is previous year
                            const currentFYStart = currentMonth < 3 ? currentYear - 1 : currentYear;
                            const financialYears = [
                                `FY ${currentFYStart}-${String(currentFYStart + 1).slice(-2)}`,
                                `FY ${currentFYStart - 1}-${String(currentFYStart).slice(-2)}`,
                                `FY ${currentFYStart - 2}-${String(currentFYStart - 1).slice(-2)}`
                            ];

                            // Get all applicants (main applicant + coapplicants)
                            const allFinancialApplicants = [proposal.applicantName];
                            if (proposal.coApplicants && proposal.coApplicants.length > 0) {
                                proposal.coApplicants.forEach((co, idx) => {
                                    if (co.type === 'Individual') {
                                        allFinancialApplicants.push(co.name || 'Coapplicant ' + (idx + 1));
                                    }
                                });
                            }

                            // Parse each financial document to extract info
                            const parsedFinancialDocs = financialDocs.map(doc => {
                                const classification = (doc.classification || doc.docType || '').toLowerCase();
                                const extractedText = (doc.extractedText || '').toLowerCase();
                                const filename = (doc.originalName || '').toLowerCase();

                                // Extract financial year from classification (e.g., "ITR of FY2023-24 of pragathi")
                                // Also check filename for year patterns like "IT 2024", "IT-2025", "2023-24"
                                let fy = null;
                                const fyMatch = classification.match(/fy\s*(\d{4})-?(\d{2,4})/i) ||
                                                filename.match(/it[- ]?(\d{4})/i) ||
                                                filename.match(/(\d{4})-(\d{2,4})/i) ||
                                                extractedText.match(/assessment\s*year[:\s]*(\d{4})-(\d{2,4})/i) ||
                                                extractedText.match(/accounting\s*year[:\s]*(\d{4})\s*-\s*(\d{4})/i);

                                if (fyMatch) {
                                    let year1, year2;
                                    if (fyMatch[2]) {
                                        year1 = fyMatch[1];
                                        year2 = fyMatch[2].length === 2 ? fyMatch[2] : fyMatch[2].slice(-2);
                                    } else {
                                        // Single year like "IT 2024" means FY 2023-24
                                        const singleYear = parseInt(fyMatch[1]);
                                        year1 = String(singleYear - 1);
                                        year2 = String(singleYear).slice(-2);
                                    }
                                    fy = `FY ${year1}-${year2}`;
                                }

                                // Extract applicant name from classification
                                let applicantName = null;
                                allFinancialApplicants.forEach(app => {
                                    const appLower = app.toLowerCase();
                                    const appFirst = appLower.split(' ')[0];
                                    // Check classification and filename
                                    if (classification.includes(appLower) || classification.includes(appFirst) ||
                                        filename.includes(appLower) || filename.includes(appFirst)) {
                                        applicantName = app;
                                    }
                                });

                                // Use pre-stored components if available (from reprocess), otherwise check extracted text
                                let components;
                                if (doc.financialComponents) {
                                    // Use pre-computed components from reprocessing
                                    components = doc.financialComponents;
                                } else {
                                    // Check for keywords with flexible matching
                                    components = {
                                        itrAck: extractedText.includes('indian income tax return acknowledgement') ||
                                                extractedText.includes('itr acknowledgement') ||
                                                extractedText.includes('acknowledgement number'),
                                        computation: extractedText.includes('computation of total income') ||
                                                    extractedText.includes('computation of income') ||
                                                    (extractedText.includes('computation') && extractedText.includes('total income')),
                                        balanceSheet: extractedText.includes('balance sheet') ||
                                                     extractedText.includes('balancesheet'),
                                        profitLoss: extractedText.includes('profit and loss account') ||
                                                   extractedText.includes('profit & loss account') ||
                                                   extractedText.includes('profit and loss a/c') ||
                                                   extractedText.includes('trading and profit') ||
                                                   (extractedText.includes('profit') && extractedText.includes('loss') && extractedText.includes('account'))
                                    };
                                }

                                // Check if this is an ITR document based on classification or filename
                                const isITRDoc = classification.includes('itr') ||
                                                 filename.includes('it ') || filename.includes('it-') || filename.includes('it_');

                                return {
                                    filename: doc.originalName,
                                    fy: fy,
                                    applicant: applicantName,
                                    components: components,
                                    classification: doc.classification || doc.docType,
                                    isITRDoc: isITRDoc,
                                    hasStoredComponents: !!doc.financialComponents
                                };
                            });

                            // Helper function to check if document component exists
                            function hasFinancialComponent(applicant, year, componentType) {
                                return parsedFinancialDocs.some(doc => {
                                    // Match applicant (check first name match if full name doesn't match)
                                    const appMatch = doc.applicant === applicant ||
                                        (doc.applicant && applicant &&
                                         doc.applicant.toLowerCase().split(' ')[0] === applicant.toLowerCase().split(' ')[0]);

                                    // Match year
                                    const yearMatch = doc.fy === year;

                                    // Match component
                                    let componentMatch = false;
                                    if (componentType === 'ITR Acknowledgement') componentMatch = doc.components.itrAck;
                                    else if (componentType === 'Computation') componentMatch = doc.components.computation;
                                    else if (componentType === 'Balance Sheet') componentMatch = doc.components.balanceSheet;
                                    else if (componentType === 'Profit & Loss') componentMatch = doc.components.profitLoss;

                                    return appMatch && yearMatch && componentMatch;
                                });
                            }

                            const docTypes = ['ITR Acknowledgement', 'Computation', 'Balance Sheet', 'Profit & Loss'];
                            %>

                            <!-- Reprocess Financial Documents Button -->
                            <% if (financialDocs.length > 0) { %>
                                <div style="margin-bottom: 15px; display: flex; justify-content: flex-end;">
                                    <button onclick="reprocessFinancialDocs()" class="btn btn-primary" style="font-size: 0.9em; padding: 8px 16px;">
                                        üîÑ Re-extract Financial Documents
                                    </button>
                                </div>
                            <% } %>

                            <!-- Uploaded Financial Documents List -->
                            <% if (parsedFinancialDocs.length > 0) { %>
                                <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üìÑ Uploaded Financial Documents (<%= parsedFinancialDocs.length %>)</h4>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        <% parsedFinancialDocs.forEach(doc => { %>
                                            <div style="padding: 8px 12px; background: white; border-radius: 4px; font-size: 0.85em; border: 1px solid #c8e6c9;" title="<%= doc.filename %>">
                                                <div style="font-weight: 600; color: #1976d2;"><%= doc.fy || 'FY ?' %></div>
                                                <div style="color: #333;"><%= doc.applicant || 'Unknown Applicant' %></div>
                                                <div style="font-size: 0.8em; margin-top: 4px; display: flex; gap: 4px; flex-wrap: wrap;">
                                                    <% if (doc.components.itrAck) { %><span style="background:#e8f5e9;color:#2e7d32;padding:2px 6px;border-radius:3px;">‚úì ITR Ack</span><% } else { %><span style="background:#ffebee;color:#c62828;padding:2px 6px;border-radius:3px;">‚úó ITR Ack</span><% } %>
                                                    <% if (doc.components.computation) { %><span style="background:#e3f2fd;color:#1565c0;padding:2px 6px;border-radius:3px;">‚úì Comp</span><% } else { %><span style="background:#ffebee;color:#c62828;padding:2px 6px;border-radius:3px;">‚úó Comp</span><% } %>
                                                    <% if (doc.components.balanceSheet) { %><span style="background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:3px;">‚úì BS</span><% } else { %><span style="background:#ffebee;color:#c62828;padding:2px 6px;border-radius:3px;">‚úó BS</span><% } %>
                                                    <% if (doc.components.profitLoss) { %><span style="background:#f3e5f5;color:#7b1fa2;padding:2px 6px;border-radius:3px;">‚úì P&L</span><% } else { %><span style="background:#ffebee;color:#c62828;padding:2px 6px;border-radius:3px;">‚úó P&L</span><% } %>
                                                </div>
                                                <div style="font-size: 0.7em; color: #666; margin-top: 4px;">üìÅ <%= doc.filename %></div>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            <% } else { %>
                                <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <h4 style="margin: 0; color: #e65100;">‚ö†Ô∏è No Financial Documents Uploaded</h4>
                                    <p style="margin: 10px 0 0 0; color: #666;">Please upload ITR documents for the applicant and co-applicants.</p>
                                </div>
                            <% } %>

                            <!-- Financial Documents Summary Table -->
                            <% allFinancialApplicants.forEach((applicant, appIdx) => { %>
                                <div style="margin-bottom: 25px; padding: 15px; background: #fff; border-radius: 10px; border: 2px solid #1976d2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <h4 style="margin: 0 0 15px 0; color: #1976d2; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.2em;">üë§</span>
                                        <%= applicant %>
                                        <% if (appIdx === 0) { %><span style="font-size: 0.8em; color: #666;">(Applicant)</span><% } else { %><span style="font-size: 0.8em; color: #666;">(Co-Applicant)</span><% } %>
                                    </h4>

                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                            <thead>
                                                <tr style="background: #e3f2fd;">
                                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">Financial Year</th>
                                                    <% docTypes.forEach(docType => { %>
                                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600;"><%= docType %></th>
                                                    <% }); %>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% financialYears.forEach((fy, fyIdx) => { %>
                                                    <tr style="<%= fyIdx % 2 === 0 ? 'background: #fafafa;' : 'background: #fff;' %>">
                                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 500;"><%= fy %></td>
                                                        <% docTypes.forEach(docType => {
                                                            const hasDoc = hasFinancialComponent(applicant, fy, docType);
                                                        %>
                                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; <%= hasDoc ? 'background: #e8f5e9;' : 'background: #ffebee;' %>">
                                                                <% if (hasDoc) { %>
                                                                    <span style="color: #4caf50; font-size: 1.3em;" title="Uploaded">‚úì</span>
                                                                <% } else { %>
                                                                    <span style="color: #d32f2f; font-size: 1.3em;" title="Missing">‚úó</span>
                                                                <% } %>
                                                            </td>
                                                        <% }); %>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>

                                    <%
                                    // Count missing documents for this applicant
                                    let missingFinCount = 0;
                                    financialYears.forEach(fy => {
                                        docTypes.forEach(docType => {
                                            if (!hasFinancialComponent(applicant, fy, docType)) {
                                                missingFinCount++;
                                            }
                                        });
                                    });
                                    %>
                                    <div style="margin-top: 10px; padding: 8px; background: <%= missingFinCount === 0 ? '#e8f5e9' : '#fff3e0' %>; border-radius: 4px;">
                                        <% if (missingFinCount === 0) { %>
                                            <span style="color: #2e7d32;">‚úì All financial documents uploaded for <%= applicant %></span>
                                        <% } else { %>
                                            <span style="color: #e65100;">‚ö†Ô∏è <%= missingFinCount %> document(s) missing for <%= applicant %></span>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>

                            <!-- Pending List -->
                            <% if (pendingByCategory.financials.length > 0) { %>
                                <h4 style="margin: 20px 0 10px 0; color: #d32f2f;">üìã Pending Financial Documents:</h4>
                                <ul class="pending-list">
                                    <% pendingByCategory.financials.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Financial documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Banking Pending -->
                        <div class="pending-category-content" data-pending-category="banking" style="display: none;">
                            <% 
                            // Get all banking documents
                            const bankingDocs = uploadedFiles.filter(f => f.category === 'banking');
                            const hasBankingDocs = bankingDocs.length > 0;
                            
                            // Extract bank statement information from uploaded documents
                            const bankStatements = [];
                            bankingDocs.forEach(doc => {
                                if (doc.extractedDetails && doc.extractedDetails.bankName) {
                                    bankStatements.push({
                                        bankName: doc.extractedDetails.bankName,
                                        accountHolder: doc.extractedDetails.accountHolder || 'N/A',
                                        accountNumber: doc.extractedDetails.accountNumber || 'N/A',
                                        period: (doc.extractedDetails.periodFrom && doc.extractedDetails.periodTo) 
                                            ? `${doc.extractedDetails.periodFrom} - ${doc.extractedDetails.periodTo}`
                                            : (doc.extractedDetails.period || 'N/A'),
                                        filename: doc.originalName
                                    });
                                }
                            });
                            %>
                            
                            <% if (hasBankingDocs) { %>
                                <!-- Show reprocess button if there are banking docs but no extracted details yet -->
                                <% if (bankStatements.length === 0) { %>
                                    <div style="margin-bottom: 25px; padding: 20px; background: #fff3e0; border-radius: 10px; border: 2px solid #f57c00; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <h3 style="margin: 0 0 15px 0; color: #e65100; display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 1.3em;">üè¶</span>
                                            Bank Statement Summary (<%= bankingDocs.length %> document<%= bankingDocs.length > 1 ? 's' : '' %> uploaded)
                                        </h3>
                                        <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #ff9800;">
                                            <p style="margin: 0 0 15px 0; color: #666;">
                                                ‚ö†Ô∏è Bank statement details have not been extracted yet. Click the button below to extract bank name, account details, and statement periods from your uploaded documents.
                                            </p>
                                            <button onclick="reprocessBankingDocs()" class="btn btn-primary" style="font-size: 0.95em; padding: 10px 20px;">
                                                üîÑ Extract Bank Statement Details
                                            </button>
                                        </div>
                                    </div>
                                <% } %>
                            <% } %>
                            
                            <% if (hasBankingDocs && bankStatements.length > 0) { %>
                                <!-- Bank Statement Summary -->
                                <div style="margin-bottom: 25px; padding: 20px; background: #ffffff; border-radius: 10px; border: 2px solid #1976d2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <h3 style="margin: 0 0 15px 0; color: #1976d2; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.3em;">üè¶</span>
                                        Bank Statement Summary (<%= bankStatements.length %> statement<%= bankStatements.length > 1 ? 's' : '' %>)
                                    </h3>
                                    
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; background: white;">
                                            <thead>
                                                <tr style="background: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #666;">Bank Name</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #666;">Account Holder</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #666;">Account Number</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #666;">Period</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% bankStatements.forEach((stmt, idx) => { %>
                                                    <tr style="border-bottom: 1px solid #e0e0e0; <%= idx % 2 === 0 ? 'background: #fafafa;' : '' %>">
                                                        <td style="padding: 12px; color: #333;"><%= stmt.bankName %></td>
                                                        <td style="padding: 12px; color: #333;"><%= stmt.accountHolder %></td>
                                                        <td style="padding: 12px; color: #333; font-family: monospace;"><%= stmt.accountNumber %></td>
                                                        <td style="padding: 12px; color: #333;"><%= stmt.period %></td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <%
                                    // Calculate coverage - use same period as pending documents
                                    const coverageToday = new Date();
                                    const coverageOneYearAgo = new Date(coverageToday);
                                    coverageOneYearAgo.setFullYear(coverageToday.getFullYear() - 1);
                                    const formatCoverageDate = (d) => String(d.getDate()).padStart(2, '0') + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + d.getFullYear();
                                    const requiredStart = formatCoverageDate(coverageOneYearAgo);
                                    const requiredEnd = formatCoverageDate(coverageToday);

                                    // Helper to parse date for coverage calculation
                                    const parseCoverageDate = (dateStr) => {
                                        if (!dateStr || dateStr === 'N/A') return null;
                                        const parts = dateStr.split(/[\/\-]/);
                                        if (parts.length === 3) {
                                            const day = parseInt(parts[0]);
                                            const month = parseInt(parts[1]) - 1;
                                            const year = parseInt(parts[2].length === 2 ? '20' + parts[2] : parts[2]);
                                            return new Date(year, month, day);
                                        }
                                        return null;
                                    };

                                    // Count how many statements have valid period information
                                    const validStatements = bankStatements.filter(s => s.period !== 'N/A');

                                    // Calculate actual coverage percentage based on periods
                                    let totalCoveredDays = 0;
                                    const totalRequiredDays = Math.ceil((coverageToday - coverageOneYearAgo) / (1000 * 60 * 60 * 24));
                                    let earliestDate = null;
                                    let latestDate = null;

                                    validStatements.forEach(stmt => {
                                        const periodParts = stmt.period.split(' - ');
                                        if (periodParts.length === 2) {
                                            const fromDate = parseCoverageDate(periodParts[0].trim());
                                            const toDate = parseCoverageDate(periodParts[1].trim());
                                            if (fromDate && toDate) {
                                                if (!earliestDate || fromDate < earliestDate) earliestDate = fromDate;
                                                if (!latestDate || toDate > latestDate) latestDate = toDate;
                                            }
                                        }
                                    });

                                    if (earliestDate && latestDate) {
                                        // Clamp to required period
                                        const effectiveStart = earliestDate < coverageOneYearAgo ? coverageOneYearAgo : earliestDate;
                                        const effectiveEnd = latestDate > coverageToday ? coverageToday : latestDate;
                                        totalCoveredDays = Math.ceil((effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24));
                                        if (totalCoveredDays < 0) totalCoveredDays = 0;
                                    }

                                    const coveragePercentage = totalRequiredDays > 0 ? Math.round((totalCoveredDays / totalRequiredDays) * 100) : 0;

                                    // Calculate missing periods
                                    let missingPeriodStart = null;
                                    let missingPeriodEnd = null;
                                    let missingDays = 0;

                                    if (earliestDate && latestDate) {
                                        if (earliestDate > coverageOneYearAgo) {
                                            missingPeriodStart = coverageOneYearAgo;
                                            missingPeriodEnd = new Date(earliestDate.getTime() - 86400000);
                                            missingDays = Math.ceil((earliestDate - coverageOneYearAgo) / (1000 * 60 * 60 * 24));
                                        } else if (latestDate < coverageToday) {
                                            missingPeriodStart = new Date(latestDate.getTime() + 86400000);
                                            missingPeriodEnd = coverageToday;
                                            missingDays = Math.ceil((coverageToday - latestDate) / (1000 * 60 * 60 * 24));
                                        }
                                    }
                                    %>
                                    
                                    <!-- Bank Statement Coverage -->
                                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1976d2;">
                                        <h4 style="margin: 0 0 12px 0; color: #1565c0; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.1em;">üìÖ</span>
                                            Bank Statement Coverage (Last 1 Year)
                                        </h4>
                                        
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <span style="color: #555; font-weight: 500;">Required Period: <%= requiredStart %> to <%= requiredEnd %></span>
                                            <span style="font-weight: 600; color: <%= coveragePercentage >= 80 ? '#2e7d32' : coveragePercentage >= 50 ? '#f57c00' : '#d32f2f' %>; font-size: 1.1em;">
                                                Overall: <%= coveragePercentage %>% Coverage
                                            </span>
                                        </div>
                                        
                                        <% if (validStatements.length > 0) { %>
                                            <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 6px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                    <strong style="color: #1976d2;">
                                                        <% 
                                                        // Group by bank name and account
                                                        const uniqueBanks = [...new Set(validStatements.map(s => s.bankName))];
                                                        %>
                                                        <%= uniqueBanks[0] || 'Bank' %>
                                                        <% if (validStatements[0] && validStatements[0].accountNumber !== 'N/A') { %>
                                                            (<%= validStatements[0].accountNumber %>)
                                                        <% } %>
                                                    </strong>
                                                    <span style="font-weight: 600; color: <%= coveragePercentage >= 80 ? '#2e7d32' : coveragePercentage >= 50 ? '#f57c00' : '#d32f2f' %>;">
                                                        <%= coveragePercentage %>% Coverage
                                                    </span>
                                                </div>
                                                
                                                <% if (coveragePercentage < 100 && missingPeriodStart && missingPeriodEnd) { %>
                                                    <div style="margin-top: 8px; padding: 10px; background: #fff3e0; border-left: 3px solid #f57c00; border-radius: 4px;">
                                                        <div style="display: flex; align-items: center; gap: 8px; color: #e65100;">
                                                            <span style="font-size: 1.2em;">‚ö†</span>
                                                            <strong>Missing:</strong>
                                                            <span><%= formatCoverageDate(missingPeriodStart) %> to <%= formatCoverageDate(missingPeriodEnd) %> (<%= missingDays %> days)</span>
                                                        </div>
                                                    </div>
                                                <% } %>
                                            </div>
                                        <% } else { %>
                                            <div style="margin-top: 10px; padding: 12px; background: #ffebee; border-left: 3px solid #d32f2f; border-radius: 4px;">
                                                <strong style="color: #c62828;">‚ö†Ô∏è No valid statement periods found</strong>
                                                <p style="margin: 5px 0 0 0; color: #666;">
                                                    Please upload bank statements or click "Reprocess All Documents" to extract period information.
                                                </p>
                                            </div>
                                        <% } %>
                                    </div>
                                    
                                    <div style="margin-top: 15px; text-align: right;">
                                        <button onclick="reprocessBankingDocs()" class="btn btn-primary" style="font-size: 0.9em; padding: 8px 16px;">
                                            üîÑ Re-extract Bank Statement Details
                                        </button>
                                    </div>
                                </div>
                            <% } %>
                            
                            <%
                            // EMI Verification against Bank Statements
                            const missingEmiBankStatements = [];
                            let emiVerificationPossible = false;
                            // emiFoundInAccounts is defined at top level, just reset it here

                            if (debtProfiles && debtProfiles.length > 0 && bankingDocs.length > 0) {
                                // Get all bank statement extracted texts
                                const allBankStatementTexts = bankingDocs
                                    .filter(doc => doc.extractedText)
                                    .map(doc => doc.extractedText.toLowerCase());
                                const combinedBankText = allBankStatementTexts.join(' ');

                                // Perform EMI verification if bank statements have some content (lowered threshold)
                                if (combinedBankText.length > 500) {
                                    emiVerificationPossible = true;

                                    // Check each EMI from debt profiles
                                    debtProfiles.forEach(profile => {
                                        if (profile.emi && profile.emi > 0) {
                                            const emiAmount = Math.round(profile.emi);
                                            // Generate many variations of the EMI amount to match different formats
                                            const emiVariations = [
                                                emiAmount.toString(),
                                                emiAmount.toLocaleString('en-IN'),
                                                (emiAmount - 1).toString(), // Allow ¬±1 variance
                                                (emiAmount + 1).toString(),
                                                (emiAmount - 2).toString(), // Allow ¬±2 variance
                                                (emiAmount + 2).toString(),
                                                String(emiAmount).replace(/,/g, ''),
                                                emiAmount.toFixed(2),
                                                emiAmount.toLocaleString('en-IN', {minimumFractionDigits: 2}),
                                                // Additional formats
                                                emiAmount.toFixed(0),
                                                String(emiAmount).padStart(6, '0'), // With leading zeros
                                                emiAmount.toLocaleString('en-US'), // US format with commas
                                                String(emiAmount).replace(/\B(?=(\d{3})+(?!\d))/g, ','), // Manual comma format
                                                String(emiAmount).replace(/\B(?=(\d{2})+(?!\d))/g, ','), // Indian comma format attempt
                                            ];

                                            // Check each bank statement individually to find which account has the EMI
                                            let foundInAccount = null;
                                            let foundInAnyDoc = false;

                                            for (const doc of bankingDocs) {
                                                if (doc.extractedText) {
                                                    const docText = doc.extractedText.toLowerCase();
                                                    // Check if any EMI variation exists in this document
                                                    const emiFound = emiVariations.some(emi => docText.includes(String(emi).toLowerCase()));
                                                    if (emiFound) {
                                                        foundInAnyDoc = true;
                                                        // Try to get the account number if available
                                                        if (doc.extractedDetails && doc.extractedDetails.accountNumber && doc.extractedDetails.accountNumber !== 'N/A') {
                                                            foundInAccount = doc.extractedDetails.accountNumber;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }

                                            if (foundInAnyDoc) {
                                                // EMI found in a bank statement
                                                emiFoundInAccounts[profile._id] = {
                                                    found: true,
                                                    accountNumber: foundInAccount || ''
                                                };
                                            } else {
                                                // Also check combined text as a fallback
                                                const emiInCombined = emiVariations.some(emi => combinedBankText.includes(String(emi).toLowerCase()));
                                                if (emiInCombined) {
                                                    emiFoundInAccounts[profile._id] = {
                                                        found: true,
                                                        accountNumber: ''
                                                    };
                                                } else {
                                                    emiFoundInAccounts[profile._id] = { found: false, accountNumber: '' };

                                                    // Calculate required period
                                                    let requiredPeriod = 'last 12 months';
                                                    if (profile.emiStartDate) {
                                                        const startParts = profile.emiStartDate.split('/');
                                                        if (startParts.length === 3) {
                                                            const startDate = new Date(startParts[2], startParts[1] - 1, startParts[0]);
                                                            const monthsAgo = Math.floor((new Date() - startDate) / (30 * 24 * 60 * 60 * 1000));
                                                            if (monthsAgo < 12) {
                                                                requiredPeriod = `from ${profile.emiStartDate} (${monthsAgo} months)`;
                                                            }
                                                        }
                                                    }

                                                    missingEmiBankStatements.push({
                                                        bank: profile.bank,
                                                        emi: emiAmount,
                                                        loanType: profile.loanType,
                                                        applicant: profile.loanApplicant,
                                                        requiredPeriod: requiredPeriod
                                                    });
                                                }
                                            }
                                        }
                                    });
                                }
                            }
                            %>
                            <!-- Hidden element to pass EMI verification data to JavaScript -->
                            <input type="hidden" id="emiFoundData" value="<%- JSON.stringify(emiFoundInAccounts) %>">

                            <!-- Debug: EMI Verification Status -->
                            <% if (debtProfiles && debtProfiles.length > 0) { %>
                            <div style="margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:4px;font-size:0.85em;">
                                <strong>EMI Auto-Verification:</strong>
                                Bank docs: <%= bankingDocs ? bankingDocs.length : 0 %> |
                                Text length: <%= (bankingDocs || []).filter(d => d.extractedText).map(d => d.extractedText.length).reduce((a,b) => a+b, 0) %> chars |
                                Verification possible: <%= emiVerificationPossible ? 'Yes' : 'No' %> |
                                Results: <%- JSON.stringify(emiFoundInAccounts) %>
                            </div>
                            <% } %>

                            <% if (debtProfiles && debtProfiles.length > 0 && bankingDocs.length > 0 && !emiVerificationPossible) { %>
                                <!-- EMI Verification Not Possible -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1976d2;">
                                    <h4 style="margin: 0 0 10px 0; color: #1565c0;">
                                        ‚ÑπÔ∏è EMI Verification
                                    </h4>
                                    <p style="margin: 0; color: #666; font-size: 0.9em;">
                                        EMI verification requires bank statements with full transaction data.
                                        The current bank statements have limited extracted text (headers only).
                                        Please click "Re-extract Bank Statement Details" above to extract full transaction data,
                                        or manually verify that EMIs from the Debt Profile are reflecting in the bank statements.
                                    </p>
                                </div>
                            <% } else if (missingEmiBankStatements.length > 0) { %>
                                <!-- Missing EMI Bank Statements -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <h4 style="margin: 0 0 15px 0; color: #e65100;">
                                        ‚ö†Ô∏è EMI Verification - Missing Bank Statements (<%= missingEmiBankStatements.length %>)
                                    </h4>
                                    <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9em;">
                                        The following EMIs from Debt Profile are not reflecting in the uploaded bank statements.
                                        Please provide the bank statements where these EMIs are debited.
                                    </p>
                                    <ul style="margin: 0; padding: 0 0 0 20px;">
                                        <% missingEmiBankStatements.forEach(item => { %>
                                            <li style="margin: 8px 0; padding: 10px; background: white; border-radius: 4px; list-style: none; margin-left: -20px; padding-left: 15px; border-left: 3px solid #f57c00;">
                                                <strong style="color: #d32f2f;">EMI ‚Çπ<%= item.emi.toLocaleString('en-IN') %></strong>
                                                <span style="color: #555;"> - <%= item.bank %> (<%= item.loanType %>)</span>
                                                <br>
                                                <span style="font-size: 0.85em; color: #666;">
                                                    üë§ <%= item.applicant %> |
                                                    üìÖ Bank statement required for <%= item.requiredPeriod %>
                                                </span>
                                            </li>
                                        <% }); %>
                                    </ul>
                                </div>
                            <% } else if (debtProfiles && debtProfiles.length > 0 && emiVerificationPossible) { %>
                                <!-- All EMIs Verified -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <h4 style="margin: 0; color: #2e7d32;">
                                        ‚úì EMI Verification - All EMIs from Debt Profile are reflecting in bank statements
                                    </h4>
                                </div>
                            <% } %>

                            <% if (pendingByCategory.banking.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.banking.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else if (missingEmiBankStatements.length === 0) { %>
                                <p class="success-message">‚úì All Banking documents uploaded!</p>
                            <% } %>
                        </div>

                        <!-- Turnover Pending -->
                        <div class="pending-category-content" data-pending-category="turnover" style="display: none;">
                            <%
                            // Get all GST returns and group by GSTIN
                            // Check both extractedText and filename/originalName for GSTR patterns
                            const allGstReturns = uploadedFiles.filter(f => {
                                if (f.category !== 'turnover') return false;

                                const fileName = (f.originalName || f.filename || '').toUpperCase();
                                const extractedText = f.extractedText || '';
                                const classification = (f.classification || '').toUpperCase();

                                // Check if it's a GST return based on text content, filename, or classification
                                const isGstReturn =
                                    extractedText.includes('GSTR-3B') ||
                                    extractedText.includes('GSTR-1') ||
                                    extractedText.includes('Form GSTR') ||
                                    fileName.includes('GSTR1') ||
                                    fileName.includes('GSTR3B') ||
                                    fileName.includes('GSTR-1') ||
                                    fileName.includes('GSTR-3B') ||
                                    classification.includes('GST 3B') ||
                                    classification.includes('GST 1 RETURNS');

                                return isGstReturn;
                            });

                            // Group by GSTIN and track uploaded months
                            const gstReturnsByGstin = {};
                            const uploadedMonthsByGstin = {};
                            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

                            // Helper function to get financial year for a given month and calendar year
                            // FY runs from April to March: April 2024 - March 2025 = FY 2024-25
                            function getFinancialYear(monthIndex, calendarYear) {
                                // monthIndex: 0=Jan, 1=Feb, 2=Mar, 3=Apr, ... 11=Dec
                                // Jan, Feb, Mar (0,1,2) belong to previous FY
                                // Apr to Dec (3-11) belong to current FY
                                if (monthIndex <= 2) { // Jan, Feb, Mar
                                    return `${calendarYear - 1}-${String(calendarYear).slice(-2)}`;
                                } else { // Apr to Dec
                                    return `${calendarYear}-${String(calendarYear + 1).slice(-2)}`;
                                }
                            }

                            // Store trade name and legal name for each GSTIN
                            const gstinNames = {};

                            allGstReturns.forEach(doc => {
                                const extractedText = doc.extractedText || '';
                                const fileName = (doc.originalName || doc.filename || '').toUpperCase();

                                // Try to extract GSTIN from text first, then from filename
                                // Filename format: GSTR1_36AAECC7358L2Z6_012025.pdf or GSTR3B_37AAWFP4010D1ZA_012025.pdf
                                let gstin = 'Unknown GSTIN';
                                const gstinMatch = extractedText.match(/GSTIN of the supplier\s+([A-Z0-9]+)/);
                                if (gstinMatch) {
                                    gstin = gstinMatch[1];
                                } else {
                                    // Try to extract from filename (GSTR1_GSTIN_MMYYYY.pdf or GSTR3B_GSTIN_MMYYYY.pdf)
                                    const fileGstinMatch = fileName.match(/GSTR[13]B?_([A-Z0-9]{15})_/);
                                    if (fileGstinMatch) {
                                        gstin = fileGstinMatch[1];
                                    }
                                }

                                // Extract trade name and legal name from extracted text
                                const tradeNameMatch = extractedText.match(/Trade name[,\s]*\(if any\)\s*[:\-]?\s*([^\n\r]+)/i);
                                const legalNameMatch = extractedText.match(/Legal name of the registered person\s*[:\-]?\s*([^\n\r]+)/i);

                                if (!gstReturnsByGstin[gstin]) {
                                    gstReturnsByGstin[gstin] = [];
                                    uploadedMonthsByGstin[gstin] = {};
                                    gstinNames[gstin] = {
                                        tradeName: tradeNameMatch ? tradeNameMatch[1].trim() : '',
                                        legalName: legalNameMatch ? legalNameMatch[1].trim() : ''
                                    };
                                } else if (!gstinNames[gstin].tradeName && tradeNameMatch) {
                                    gstinNames[gstin].tradeName = tradeNameMatch[1].trim();
                                } else if (!gstinNames[gstin].legalName && legalNameMatch) {
                                    gstinNames[gstin].legalName = legalNameMatch[1].trim();
                                }
                                gstReturnsByGstin[gstin].push(doc);

                                // Determine form type from text or filename
                                let formType = '';
                                if (extractedText.includes('GSTR-3B') || extractedText.includes('Form GSTR-3B') ||
                                    fileName.includes('GSTR3B') || fileName.includes('GSTR-3B')) {
                                    formType = 'GSTR-3B';
                                } else if (extractedText.includes('GSTR-1') ||
                                           fileName.includes('GSTR1_') || fileName.includes('GSTR-1')) {
                                    formType = 'GSTR-1';
                                }

                                // Track uploaded month-year combinations with form types
                                // Try extracted text first
                                let periodMatch = extractedText.match(/Period\s+([A-Za-z]+)/i);
                                let fyMatch = extractedText.match(/Year\s+(\d{4})-(\d{2})/i);
                                let yearMatch = extractedText.match(/Year\s+(\d{4})/i);

                                // If not found in text, try to parse from filename (MMYYYY format)
                                if (!periodMatch) {
                                    // Filename format: GSTR1_GSTIN_MMYYYY.pdf
                                    const fileMonthMatch = fileName.match(/_(\d{2})(\d{4})\.PDF$/i);
                                    if (fileMonthMatch) {
                                        const monthNum = parseInt(fileMonthMatch[1]) - 1; // 0-indexed
                                        const calYear = parseInt(fileMonthMatch[2]);
                                        if (monthNum >= 0 && monthNum < 12) {
                                            const monthName = monthNames[monthNum];
                                            const fy = getFinancialYear(monthNum, calYear);
                                            const monthKey = `${monthName}-${fy}`;
                                            if (!uploadedMonthsByGstin[gstin][monthKey]) {
                                                uploadedMonthsByGstin[gstin][monthKey] = { gstr1: false, gstr3b: false };
                                            }
                                            if (formType === 'GSTR-1') {
                                                uploadedMonthsByGstin[gstin][monthKey].gstr1 = true;
                                            } else if (formType === 'GSTR-3B') {
                                                uploadedMonthsByGstin[gstin][monthKey].gstr3b = true;
                                            }
                                        }
                                    }
                                } else if (periodMatch) {
                                    const monthName = periodMatch[1];
                                    const monthIndex = monthNames.findIndex(m => m.toLowerCase() === monthName.toLowerCase());

                                    let fy = '';
                                    if (fyMatch) {
                                        // Financial year directly from document (e.g., 2024-25)
                                        fy = `${fyMatch[1]}-${fyMatch[2]}`;
                                    } else if (yearMatch && monthIndex !== -1) {
                                        // Calculate FY from calendar year
                                        fy = getFinancialYear(monthIndex, parseInt(yearMatch[1]));
                                    }

                                    if (fy) {
                                        const monthKey = `${monthName}-${fy}`;
                                        if (!uploadedMonthsByGstin[gstin][monthKey]) {
                                            uploadedMonthsByGstin[gstin][monthKey] = { gstr1: false, gstr3b: false };
                                        }
                                        if (formType === 'GSTR-1') {
                                            uploadedMonthsByGstin[gstin][monthKey].gstr1 = true;
                                        } else if (formType === 'GSTR-3B') {
                                            uploadedMonthsByGstin[gstin][monthKey].gstr3b = true;
                                        }
                                    }
                                }
                            });

                            // Calculate last 12 months (from previous month going back)
                            const today = new Date();
                            const last12Months = [];
                            for (let i = 1; i <= 12; i++) {
                                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                                const monthIndex = d.getMonth();
                                const calYear = d.getFullYear();
                                const fy = getFinancialYear(monthIndex, calYear);
                                last12Months.push({
                                    month: monthNames[monthIndex],
                                    year: calYear,
                                    fy: fy,
                                    key: `${monthNames[monthIndex]}-${fy}`
                                });
                            }

                            // Find missing/partial returns for each GSTIN
                            const missingReturnsByGstin = {};
                            Object.keys(uploadedMonthsByGstin).forEach(gstin => {
                                if (gstin !== 'Unknown GSTIN') {
                                    missingReturnsByGstin[gstin] = [];
                                    last12Months.forEach(m => {
                                        const uploaded = uploadedMonthsByGstin[gstin][m.key];
                                        // Only mark as missing if NEITHER GSTR-1 nor GSTR-3B is uploaded
                                        // If either one is received, it's considered complete
                                        if (!uploaded || (!uploaded.gstr1 && !uploaded.gstr3b)) {
                                            missingReturnsByGstin[gstin].push({
                                                ...m,
                                                status: 'missing',
                                                gstr1: false,
                                                gstr3b: false
                                            });
                                        }
                                    });
                                }
                            });

                            // Check if there are any missing returns
                            let totalMissingReturns = 0;
                            Object.values(missingReturnsByGstin).forEach(arr => {
                                totalMissingReturns += arr.length;
                            });
                            %>

                            <!-- Existing pending items -->
                            <% if (pendingByCategory.turnover.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.turnover.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } %>

                            <!-- Missing GST Returns Warning -->
                            <% if (Object.keys(missingReturnsByGstin).length > 0 && totalMissingReturns > 0) { %>
                                <div style="margin-top: 15px; margin-bottom: 20px;">
                                    <h4 style="color: #d32f2f; margin-bottom: 10px;">‚ö†Ô∏è Missing GST Returns (Last 12 Months)</h4>
                                    <% Object.keys(missingReturnsByGstin).forEach(gstin => { %>
                                        <% if (missingReturnsByGstin[gstin].length > 0) { %>
                                            <div style="margin-bottom: 15px; padding: 10px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 4px;">
                                                <strong style="color: #e65100;">GSTIN: <%= gstin %></strong>
                                                <% if (gstinNames[gstin] && (gstinNames[gstin].tradeName || gstinNames[gstin].legalName)) { %>
                                                    <span style="margin-left: 10px; color: #555;">
                                                        <% if (gstinNames[gstin].tradeName) { %>| Trade Name: <strong><%= gstinNames[gstin].tradeName %></strong><% } %>
                                                        <% if (gstinNames[gstin].legalName) { %>| Legal Name: <strong><%= gstinNames[gstin].legalName %></strong><% } %>
                                                    </span>
                                                <% } %>
                                                <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                    <% missingReturnsByGstin[gstin].forEach(m => { %>
                                                        <li style="margin: 4px 0;">
                                                            <strong><%= m.month %> (FY <%= m.fy %>)</strong>:
                                                            <span style="color: #d32f2f;">GST Return not uploaded</span>
                                                        </li>
                                                    <% }); %>
                                                </ul>
                                            </div>
                                        <% } %>
                                    <% }); %>
                                </div>
                            <% } else if (pendingByCategory.turnover.length === 0 && Object.keys(gstReturnsByGstin).length > 0) { %>
                                <p class="success-message">‚úì All GST Returns for last 12 months uploaded!</p>
                            <% } else if (pendingByCategory.turnover.length === 0) { %>
                                <p class="success-message">‚úì All Turnover documents uploaded!</p>
                            <% } %>

                            <!-- GST Returns Monthly Status Table -->
                            <% if (Object.keys(gstReturnsByGstin).length > 0) { %>
                                <% Object.keys(gstReturnsByGstin).forEach(gstin => { %>
                                    <% if (gstin !== 'Unknown GSTIN') { %>
                                    <div style="margin-top: 20px; margin-bottom: 20px;">
                                        <h4 style="margin-bottom: 10px; color: #1976d2;">
                                            üìä Monthly GST Returns Status - GSTIN: <%= gstin %>
                                            <% if (gstinNames[gstin] && gstinNames[gstin].tradeName) { %>
                                                <span style="font-weight: normal; color: #555; font-size: 0.85em;">(<%= gstinNames[gstin].tradeName %>)</span>
                                            <% } %>
                                        </h4>
                                        <table border="1" style="width:100%; border-collapse:collapse; background:#fff; font-size: 0.9em;">
                                            <thead>
                                                <tr style="background: #e3f2fd;">
                                                    <th style="padding: 10px; text-align: center;">Month</th>
                                                    <th style="padding: 10px; text-align: center;">Financial Year</th>
                                                    <th style="padding: 10px; text-align: center;">GSTR-1</th>
                                                    <th style="padding: 10px; text-align: center;">GSTR-3B</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% last12Months.forEach(m => {
                                                    const uploaded = uploadedMonthsByGstin[gstin] ? uploadedMonthsByGstin[gstin][m.key] : null;
                                                    const gstr1Status = uploaded && uploaded.gstr1;
                                                    const gstr3bStatus = uploaded && uploaded.gstr3b;
                                                %>
                                                <tr>
                                                    <td style="padding: 8px; text-align: center; font-weight: 500;"><%= m.month %></td>
                                                    <td style="padding: 8px; text-align: center;"><%= m.fy %></td>
                                                    <td style="padding: 8px; text-align: center; background: <%= gstr1Status ? '#e8f5e9' : '#ffebee' %>;">
                                                        <% if (gstr1Status) { %>
                                                            <span style="color: #2e7d32; font-weight: bold;">‚úì</span>
                                                        <% } else { %>
                                                            <span style="color: #c62828; font-weight: bold;">‚úó</span>
                                                        <% } %>
                                                    </td>
                                                    <td style="padding: 8px; text-align: center; background: <%= gstr3bStatus ? '#e8f5e9' : '#ffebee' %>;">
                                                        <% if (gstr3bStatus) { %>
                                                            <span style="color: #2e7d32; font-weight: bold;">‚úì</span>
                                                        <% } else { %>
                                                            <span style="color: #c62828; font-weight: bold;">‚úó</span>
                                                        <% } %>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                            </tbody>
                                            <tfoot>
                                                <tr style="background: #f5f5f5; font-weight: bold;">
                                                    <td colspan="2" style="padding: 10px; text-align: right;">Total Uploaded:</td>
                                                    <td style="padding: 10px; text-align: center;">
                                                        <%
                                                        let gstr1Count = 0;
                                                        let gstr3bCount = 0;
                                                        if (uploadedMonthsByGstin[gstin]) {
                                                            Object.values(uploadedMonthsByGstin[gstin]).forEach(v => {
                                                                if (v.gstr1) gstr1Count++;
                                                                if (v.gstr3b) gstr3bCount++;
                                                            });
                                                        }
                                                        %>
                                                        <%= gstr1Count %>/12
                                                    </td>
                                                    <td style="padding: 10px; text-align: center;"><%= gstr3bCount %>/12</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <% } %>
                                <% }); %>
                            <% } %>

                            <!-- Uploaded GST Returns List -->
                            <div style="margin-top: 20px; margin-bottom: 30px;">
                                <h3>Uploaded GST Returns</h3>
                                <% if (allGstReturns.length > 0) { %>
                                    <% Object.keys(gstReturnsByGstin).forEach(gstin => { %>
                                        <div style="margin-bottom: 24px;">
                                            <h4 style="margin-bottom: 8px; color: #1976d2;">
                                                GSTIN: <%= gstin %>
                                                <% if (gstinNames[gstin] && (gstinNames[gstin].tradeName || gstinNames[gstin].legalName)) { %>
                                                    <span style="font-weight: normal; color: #555; font-size: 0.9em;">
                                                        <% if (gstinNames[gstin].tradeName) { %>| Trade Name: <strong><%= gstinNames[gstin].tradeName %></strong><% } %>
                                                        <% if (gstinNames[gstin].legalName) { %>| Legal Name: <strong><%= gstinNames[gstin].legalName %></strong><% } %>
                                                    </span>
                                                <% } %>
                                            </h4>
                                            <table border="1" style="width:100%;border-collapse:collapse;background:#fff;">
                                                <thead>
                                                    <tr style="background:#e8f5e9;">
                                                        <th style="padding:10px;">S.No</th>
                                                        <th style="padding:10px;">Document</th>
                                                        <th style="padding:10px;">Form Type</th>
                                                        <th style="padding:10px;">Month</th>
                                                        <th style="padding:10px;">Financial Year</th>
                                                        <th style="padding:10px;">Uploaded On</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% gstReturnsByGstin[gstin].forEach((doc, index) => {
                                                        const docText = doc.extractedText || '';
                                                        const docFileName = (doc.originalName || doc.filename || '').toUpperCase();

                                                        // Extract form type from text or filename
                                                        let formType = 'GST Return';
                                                        if (docText.includes('GSTR-3B') || docText.includes('Form GSTR-3B') ||
                                                            docFileName.includes('GSTR3B') || docFileName.includes('GSTR-3B')) {
                                                            formType = 'GSTR-3B';
                                                        } else if (docText.includes('GSTR-1') ||
                                                                   docFileName.includes('GSTR1_') || docFileName.includes('GSTR-1')) {
                                                            formType = 'GSTR-1';
                                                        }

                                                        // Extract period/month from text or filename
                                                        let month = '-';
                                                        let year = '-';
                                                        const periodMatch = docText.match(/Period\s+([A-Za-z]+)/i);
                                                        const yearTextMatch = docText.match(/Year\s+([0-9\-]+)/i);

                                                        if (periodMatch) {
                                                            month = periodMatch[1];
                                                        }
                                                        if (yearTextMatch) {
                                                            year = yearTextMatch[1];
                                                        }

                                                        // If not found in text, try filename (MMYYYY format)
                                                        if (month === '-' || year === '-') {
                                                            const fileMonthMatch = docFileName.match(/_(\d{2})(\d{4})\.PDF$/i);
                                                            if (fileMonthMatch) {
                                                                const monthNum = parseInt(fileMonthMatch[1]) - 1;
                                                                const calYear = parseInt(fileMonthMatch[2]);
                                                                if (monthNum >= 0 && monthNum < 12) {
                                                                    month = monthNames[monthNum];
                                                                    // Calculate FY
                                                                    const fy = getFinancialYear(monthNum, calYear);
                                                                    year = fy;
                                                                }
                                                            }
                                                        }

                                                        // Format upload date
                                                        const uploadDate = doc.uploadedAt ? new Date(doc.uploadedAt).toLocaleDateString() : '-';
                                                    %>
                                                    <tr>
                                                        <td style="padding:8px;text-align:center;"><%= index + 1 %></td>
                                                        <td style="padding:8px;"><%= doc.originalName %></td>
                                                        <td style="padding:8px;text-align:center;"><%= formType %></td>
                                                        <td style="padding:8px;text-align:center;"><%= month %></td>
                                                        <td style="padding:8px;text-align:center;"><%= year %></td>
                                                        <td style="padding:8px;text-align:center;"><%= uploadDate %></td>
                                                    </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <p style="color:#666;font-style:italic;">No GST returns uploaded yet.</p>
                                <% } %>
                            </div>
                        </div>

                        <!-- Debt Profile Pending -->
                        <div class="pending-category-content" data-pending-category="debtProfile" style="display: none;">
                            <% if (pendingByCategory.debtProfile.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.debtProfile.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } %>

                            <%
                            // Check if there are Excel files in debtProfile category
                            const debtProfileExcelFiles = uploadedFiles.filter(f =>
                                f.category === 'debtProfile' &&
                                (f.filename.endsWith('.xlsx') || f.filename.endsWith('.xls'))
                            );
                            %>

                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                                <h3 style="margin: 0;">Debt Profile Table</h3>
                                <% if (debtProfileExcelFiles.length > 0) { %>
                                    <button onclick="extractDebtProfile()" class="btn btn-primary" style="font-size: 0.85em; padding: 6px 12px;">
                                        üîÑ Extract from Excel (<%= debtProfileExcelFiles.length %> file<%= debtProfileExcelFiles.length > 1 ? 's' : '' %>)
                                    </button>
                                <% } %>
                            </div>

                            <% if (debtProfiles && debtProfiles.length > 0) { %>
                            <%
                            // EMI Calculation function: EMI = P √ó r √ó (1+r)^n / ((1+r)^n - 1)
                            function calculateEMI(principal, annualRate, tenureMonths) {
                                if (!principal || !annualRate || !tenureMonths || principal <= 0 || tenureMonths <= 0) {
                                    return null;
                                }
                                const monthlyRate = annualRate / 12 / 100;
                                if (monthlyRate === 0) {
                                    return Math.round(principal / tenureMonths);
                                }
                                const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, tenureMonths) / (Math.pow(1 + monthlyRate, tenureMonths) - 1);
                                return Math.round(emi);
                            }

                            // POS (Principal Outstanding) Calculation: POS = P √ó [(1+r)^n - (1+r)^k] / [(1+r)^n - 1]
                            // Where k = months completed
                            function calculatePOS(principal, annualRate, tenureMonths, monthsCompleted) {
                                if (!principal || !tenureMonths || principal <= 0 || tenureMonths <= 0) {
                                    return null;
                                }
                                if (!monthsCompleted || monthsCompleted <= 0) {
                                    return principal; // No EMIs paid yet, full principal outstanding
                                }
                                if (monthsCompleted >= tenureMonths) {
                                    return 0; // Loan fully paid
                                }
                                const monthlyRate = annualRate / 12 / 100;
                                if (monthlyRate === 0) {
                                    // Simple interest case
                                    return Math.round(principal - (principal / tenureMonths) * monthsCompleted);
                                }
                                const n = tenureMonths;
                                const k = monthsCompleted;
                                const pos = principal * (Math.pow(1 + monthlyRate, n) - Math.pow(1 + monthlyRate, k)) / (Math.pow(1 + monthlyRate, n) - 1);
                                return Math.round(pos);
                            }

                            // Check EMI tolerance (allow 2% variance for rounding differences)
                            function isEMIMatching(enteredEMI, calculatedEMI) {
                                if (!enteredEMI || !calculatedEMI) return true; // Can't verify if missing data
                                const tolerance = calculatedEMI * 0.02; // 2% tolerance
                                return Math.abs(enteredEMI - calculatedEMI) <= tolerance;
                            }
                            %>
                            <div style="overflow-x:auto; margin-top: 15px;">
                            <table border="1" style="width:100%;border-collapse:collapse;background:#fff;font-size:0.9em;">
                                <thead>
                                    <tr style="background:#e3f2fd;">
                                        <th style="padding:8px;">S.No</th>
                                        <th style="padding:8px;">Applicant</th>
                                        <th style="padding:8px;">Bank Name</th>
                                        <th style="padding:8px;">Loan Type</th>
                                        <th style="padding:8px;">Loan Amount</th>
                                        <th style="padding:8px;">POS</th>
                                        <th style="padding:8px;">EMI (Entered)</th>
                                        <th style="padding:8px;">EMI (Calculated)</th>
                                        <th style="padding:8px;">ROI %</th>
                                        <th style="padding:8px;">Sanction Date</th>
                                        <th style="padding:8px;">Tenure (Months)</th>
                                        <th style="padding:8px;">EMI Start Date</th>
                                        <th style="padding:8px;">EMI End Date</th>
                                        <th style="padding:8px;">Months Completed</th>
                                        <th style="padding:8px;">% Tenure Completed</th>
                                        <th style="padding:8px;">EMI in Bank Stmt</th>
                                        <th style="padding:8px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <%
                                    let totalLoanAmount = 0;
                                    let totalEmi = 0;
                                    let totalCalculatedEmi = 0;
                                    let totalPOS = 0;
                                    debtProfiles.forEach(function(profile) {
                                        totalLoanAmount += profile.loanAmount || 0;
                                        totalEmi += profile.emi || 0;

                                        // Calculate expected EMI
                                        const calculatedEMI = calculateEMI(profile.loanAmount, profile.roi, profile.tenure);
                                        if (calculatedEMI) totalCalculatedEmi += calculatedEMI;
                                        const emiMatches = isEMIMatching(profile.emi, calculatedEMI);

                                        // Calculate POS (Principal Outstanding)
                                        const pos = calculatePOS(profile.loanAmount, profile.roi, profile.tenure, profile.monthsCompleted);
                                        if (pos !== null) totalPOS += pos;
                                    %>
                                        <tr>
                                            <td style="padding:8px;text-align:center;"><%= profile.sNo %></td>
                                            <td style="padding:8px;"><%= profile.loanApplicant %></td>
                                            <td style="padding:8px;"><%= profile.bank %></td>
                                            <td style="padding:8px;"><%= profile.loanType %></td>
                                            <td style="padding:8px;text-align:right;"><%= profile.loanAmount ? profile.loanAmount.toLocaleString('en-IN') : '' %></td>
                                            <td style="padding:8px;text-align:right;background:#fff8e1;">
                                                <% if (pos !== null) { %>
                                                    <strong>‚Çπ<%= pos.toLocaleString('en-IN') %></strong>
                                                    <% if (profile.loanAmount && pos > 0) { %>
                                                        <div style="font-size:0.7em;color:#666;">
                                                            (<%= Math.round((pos / profile.loanAmount) * 100) %>% remaining)
                                                        </div>
                                                    <% } %>
                                                <% } else { %>
                                                    <span style="color:#999;font-size:0.8em;">N/A</span>
                                                <% } %>
                                            </td>
                                            <td style="padding:8px;text-align:right;<%= !emiMatches ? 'background:#ffebee;' : '' %>">
                                                <div style="display:flex;align-items:center;justify-content:flex-end;gap:5px;">
                                                    <span><%= profile.emi ? profile.emi.toLocaleString('en-IN') : '' %></span>
                                                    <% if (!emiMatches && calculatedEMI) { %>
                                                        <span style="color:#d32f2f;font-weight:bold;" title="EMI mismatch! Expected: ‚Çπ<%= calculatedEMI.toLocaleString('en-IN') %>">‚ùå</span>
                                                    <% } else if (emiMatches && calculatedEMI && profile.emi) { %>
                                                        <span style="color:#4caf50;" title="EMI verified">‚úì</span>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td style="padding:8px;text-align:right;<%= !emiMatches ? 'background:#e8f5e9;font-weight:bold;' : '' %>">
                                                <% if (calculatedEMI) { %>
                                                    <%= calculatedEMI.toLocaleString('en-IN') %>
                                                    <% if (!emiMatches && profile.emi) { %>
                                                        <div style="font-size:0.75em;color:#d32f2f;">
                                                            (Diff: ‚Çπ<%= Math.abs(profile.emi - calculatedEMI).toLocaleString('en-IN') %>)
                                                        </div>
                                                    <% } %>
                                                <% } else { %>
                                                    <span style="color:#999;font-size:0.8em;">N/A</span>
                                                <% } %>
                                            </td>
                                            <td style="padding:8px;text-align:center;"><%= profile.roi %><%= profile.roi ? '%' : '' %></td>
                                            <td style="padding:8px;text-align:center;"><%= profile.sanctionDate %></td>
                                            <td style="padding:8px;text-align:center;"><%= profile.tenure %></td>
                                            <td style="padding:8px;text-align:center;"><%= profile.emiStartDate %></td>
                                            <td style="padding:8px;text-align:center;"><%= profile.emiEndDate %></td>
                                            <td style="padding:8px;text-align:center;"><%= profile.monthsCompleted %></td>
                                            <td style="padding:8px;text-align:center;">
                                                <div style="display:flex;align-items:center;gap:5px;">
                                                    <div style="flex:1;background:#e0e0e0;border-radius:4px;height:8px;">
                                                        <div style="width:<%= profile.percentTenureCompleted %>%;background:<%= profile.percentTenureCompleted >= 80 ? '#4caf50' : profile.percentTenureCompleted >= 50 ? '#ff9800' : '#2196f3' %>;height:100%;border-radius:4px;"></div>
                                                    </div>
                                                    <span><%= profile.percentTenureCompleted %>%</span>
                                                </div>
                                            </td>
                                            <%
                                            // Determine auto-detected values for this profile
                                            const autoDetected = emiFoundInAccounts[profile._id] || { found: false, accountNumber: '' };
                                            const isEmiFound = autoDetected.found || profile.emiBankStatementProvided;
                                            const selectedAccount = autoDetected.accountNumber || profile.emiBankAccountNumber || '';
                                            %>
                                            <td style="padding:8px;text-align:center;<%= isEmiFound ? 'background:#e8f5e9;' : (autoDetected.found === false && emiVerificationPossible ? 'background:#ffebee;' : '') %>">
                                                <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
                                                    <label style="display:flex;align-items:center;gap:4px;font-size:0.8em;<%= autoDetected.found ? '' : 'cursor:pointer;' %>">
                                                        <input type="checkbox"
                                                            id="emiBankStmt_<%= profile._id %>"
                                                            <%= isEmiFound ? 'checked' : '' %>
                                                            <%= autoDetected.found ? 'disabled' : '' %>
                                                            onchange="updateEmiBankStatement('<%= profile._id %>', this.checked, document.getElementById('emiBankAc_<%= profile._id %>').value)"
                                                            style="cursor:<%= autoDetected.found ? 'default' : 'pointer' %>;">
                                                        <span style="color:<%= isEmiFound ? '#4caf50' : '#666' %>;">
                                                            <%= autoDetected.found ? '‚úì Found' : (isEmiFound ? 'Manual' : 'Not Found') %>
                                                        </span>
                                                    </label>
                                                    <select id="emiBankAc_<%= profile._id %>"
                                                        onchange="updateEmiBankStatement('<%= profile._id %>', document.getElementById('emiBankStmt_<%= profile._id %>').checked, this.value)"
                                                        style="padding:2px 4px;font-size:0.75em;border:1px solid <%= isEmiFound ? '#4caf50' : '#ddd' %>;border-radius:3px;max-width:120px;<%= autoDetected.found && autoDetected.accountNumber ? 'background:#e8f5e9;' : '' %>"
                                                        <%= autoDetected.found && autoDetected.accountNumber ? 'disabled' : '' %>>
                                                        <option value="">Select A/C</option>
                                                        <%
                                                        const bankAccounts = [];
                                                        const bankingDocsForDropdown = uploadedFiles.filter(f => f.category === 'banking' && f.extractedDetails);
                                                        bankingDocsForDropdown.forEach(doc => {
                                                            const details = doc.extractedDetails;
                                                            if (details.accountNumber && details.accountNumber !== 'N/A') {
                                                                const bankName = details.bankName || 'Unknown';
                                                                const acKey = bankName + '_' + details.accountNumber;
                                                                if (!bankAccounts.find(a => a.key === acKey)) {
                                                                    bankAccounts.push({ key: acKey, bankName: bankName, accountNumber: details.accountNumber });
                                                                }
                                                            }
                                                        });
                                                        bankAccounts.forEach(account => { %>
                                                            <option value="<%= account.accountNumber %>" <%= selectedAccount === account.accountNumber ? 'selected' : '' %>>
                                                                <%= account.bankName %> - <%= account.accountNumber.slice(-4) %>
                                                            </option>
                                                        <% }); %>
                                                    </select>
                                                </div>
                                            </td>
                                            <td style="padding:8px;text-align:center;">
                                                <button onclick="editDebtProfile('<%= profile._id %>')" style="padding:4px 8px;margin-right:4px;background:#1976d2;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" title="Edit">‚úèÔ∏è</button>
                                                <button onclick="deleteDebtProfile('<%= profile._id %>')" style="padding:4px 8px;background:#d32f2f;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" title="Delete">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                                <tfoot>
                                    <tr style="background:#e8f5e9; font-weight:bold;">
                                        <td style="padding:10px;text-align:center;" colspan="4"><strong>TOTAL</strong></td>
                                        <td style="padding:10px;text-align:right;"><strong>‚Çπ<%= totalLoanAmount.toLocaleString('en-IN') %></strong></td>
                                        <td style="padding:10px;text-align:right;background:#fff8e1;"><strong>‚Çπ<%= totalPOS.toLocaleString('en-IN') %></strong></td>
                                        <td style="padding:10px;text-align:right;"><strong>‚Çπ<%= totalEmi.toLocaleString('en-IN') %></strong></td>
                                        <td style="padding:10px;text-align:right;"><strong>‚Çπ<%= totalCalculatedEmi.toLocaleString('en-IN') %></strong></td>
                                        <td style="padding:10px;" colspan="9"></td>
                                    </tr>
                                </tfoot>
                            </table>
                            </div>
                            <% } else { %>
                                <p style="color: #666; font-style: italic; margin-top: 15px;">
                                    <% if (debtProfileExcelFiles.length > 0) { %>
                                        Excel file(s) found. Click "Extract from Excel" to populate the debt profile table.
                                    <% } else { %>
                                        No debt profile data available yet. Upload Excel file with loan details and categorize as "Debt Profile".
                                    <% } %>
                                </p>
                            <% } %>
                        </div>

                        <!-- Collateral Pending -->
                        <div class="pending-category-content" data-pending-category="collateral" style="display: none;">
                            <% if (pendingByCategory.collateral.length > 0) { %>
                                <ul class="pending-list">
                                    <% pendingByCategory.collateral.forEach(doc => { %>
                                        <li class="pending-item">
                                            <span class="warning-icon">‚ö†Ô∏è</span>
                                            <%= doc %>
                                        </li>
                                    <% }); %>
                                </ul>
                            <% } else { %>
                                <p class="success-message">‚úì All Collateral documents uploaded!</p>
                            <% } %>
                        </div>

                        <p class="pending-note">Please upload all pending documents before proceeding to Stage 3.</p>
                    <% } %>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <a href="/proposals" class="btn btn-secondary">‚Üê Back to Proposals</a>
                <button type="button" class="btn btn-primary" onclick="proceedToStage3()" id="proceedBtn">
                    Complete Stage 2 & Proceed to Profiling ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Document Preview Popup (placed at body level for proper fixed positioning) -->
    <div id="documentPreview" class="document-preview-popup" style="display: none;" 
         onmouseenter="cancelHidePreview()" 
         onmouseleave="hidePreview()">
        <div class="preview-content">
            <button class="preview-close" onclick="hidePreview()">‚úï</button>
            <div id="previewLoader" class="preview-loader">Loading preview...</div>
            <iframe id="previewFrame" style="display: none;"></iframe>
            <img id="previewImage" style="display: none;" alt="Document preview">
            <div id="previewText" style="display: none;"></div>
        </div>
    </div>

    <script>
        const proposalId = '<%= proposal.id %>';
        const bulkFileInput = document.getElementById('bulkDocuments');
        const bulkFilePreview = document.getElementById('bulkFilePreview');
        const bulkUploadForm = document.getElementById('bulkUploadForm');
        const uploadProgress = document.getElementById('uploadProgress');
        
        // Track selected files separately (since FileList is read-only)
        let selectedFiles = [];

        // Function to render file preview with remove buttons
        function renderFilePreview() {
            bulkFilePreview.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.innerHTML = `
                    <span class="file-icon">${file.type.includes('pdf') ? 'üìÑ' : file.type.includes('image') ? 'üñºÔ∏è' : file.name.endsWith('.zip') ? 'üì¶' : 'üìù'}</span>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${(file.size / 1024).toFixed(2)} KB</span>
                    <button type="button" class="file-remove-btn" onclick="removeFile(${index})" title="Remove file">‚úï</button>
                `;
                bulkFilePreview.appendChild(fileItem);
            });
            
            // Update file count display
            updateFileCount();
        }
        
        // Function to remove a file from the selection
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFilePreview();
        }
        
        // Function to update file count
        function updateFileCount() {
            let countDisplay = document.getElementById('selectedFileCount');
            if (!countDisplay) {
                countDisplay = document.createElement('div');
                countDisplay.id = 'selectedFileCount';
                countDisplay.className = 'selected-file-count';
                bulkFilePreview.parentNode.insertBefore(countDisplay, bulkFilePreview);
            }
            
            const clearAllBtn = document.getElementById('clearAllFilesBtn');
            
            if (selectedFiles.length > 0) {
                countDisplay.innerHTML = `<strong>${selectedFiles.length}</strong> file(s) selected`;
                countDisplay.style.display = 'block';
                if (clearAllBtn) clearAllBtn.style.display = 'inline-flex';
            } else {
                countDisplay.style.display = 'none';
                if (clearAllBtn) clearAllBtn.style.display = 'none';
            }
        }
        
        // Function to clear all selected files
        function clearAllFiles() {
            selectedFiles = [];
            bulkFileInput.value = ''; // Clear the file input
            renderFilePreview();
        }

        // File input preview
        bulkFileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            // Add new files to existing selection (avoid duplicates)
            files.forEach(file => {
                const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            });
            renderFilePreview();
        });

        // Drag and drop
        const fileInputWrapper = document.querySelector('.file-input-wrapper');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, () => {
                fileInputWrapper.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileInputWrapper.addEventListener(eventName, () => {
                fileInputWrapper.classList.remove('drag-over');
            });
        });

        fileInputWrapper.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = Array.from(dt.files);
            // Add dropped files to selection (avoid duplicates)
            files.forEach(file => {
                const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            });
            renderFilePreview();
        });

        // Form submission
        bulkUploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            
            if (selectedFiles.length === 0) {
                alert('Please select at least one file');
                return;
            }
            
            for (let file of selectedFiles) {
                formData.append('documents', file);
            }
            formData.append('proposalId', proposalId);
            
            // Show progress with better messaging
            uploadProgress.style.display = 'block';
            const progressText = uploadProgress.querySelector('.progress-text');
            progressText.textContent = `Uploading ${selectedFiles.length} file(s)... This may take a few minutes for PDF processing.`;
            
            // Disable submit button to prevent double submission
            const submitBtn = bulkUploadForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            
            try {
                console.log('Starting upload...');
                const response = await fetch(`/stage2/${proposalId}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response received:', response.status);
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.success) {
                    uploadProgress.style.display = 'none';
                    alert('Documents uploaded and processed successfully!');
                    window.location.reload();
                } else {
                    uploadProgress.style.display = 'none';
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                uploadProgress.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                alert('Upload error: ' + error.message + '. Please try again or check your network connection.');
            }
        });

        // Tab functionality
        function showTab(category) {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            const tabBtns = document.querySelectorAll('.tab-btn');
            
            // Update active tab button
            tabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter rows by category and uncheck hidden rows
            if (category === 'all') {
                allRows.forEach(row => row.style.display = '');
            } else if (category === 'unclassified') {
                // Show only rows where classification is empty
                allRows.forEach(row => {
                    const rowClassification = row.getAttribute('data-classification');
                    if (!rowClassification || rowClassification.trim() === '') {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                        // Uncheck checkboxes in hidden rows
                        const checkbox = row.querySelector('.doc-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }
                });
            } else {
                allRows.forEach(row => {
                    const rowCategory = row.getAttribute('data-category');
                    if (rowCategory === category) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                        // Uncheck checkboxes in hidden rows
                        const checkbox = row.querySelector('.doc-checkbox');
                        if (checkbox) {
                            checkbox.checked = false;
                        }
                    }
                });
            }
            
            // Reset select all checkbox and update bulk actions when tab changes
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            updateBulkActions();
        }

        // Update document category
        async function updateCategory(fileId, category) {
            if (!category) return;
            
            try {
                const response = await fetch(`/stage2/${proposalId}/categorize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileId, category })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Category updated successfully!');
                    window.location.reload();
                } else {
                    alert('Update failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Helper function to check if a row is actually visible
        function isRowVisible(row) {
            return row.style.display !== 'none' && row.offsetParent !== null;
        }

        // Toggle select all checkboxes - only for visible rows
        function toggleSelectAll(selectAllCheckbox) {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            allRows.forEach(row => {
                // Only select checkboxes in visible rows
                if (isRowVisible(row)) {
                    const checkbox = row.querySelector('.doc-checkbox');
                    if (checkbox) {
                        checkbox.checked = selectAllCheckbox.checked;
                    }
                }
            });
            updateBulkActions();
        }

        // Update bulk actions bar visibility and count - only count visible checked boxes
        function updateBulkActions() {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            let visibleCheckedCount = 0;
            let visibleTotalCount = 0;
            
            allRows.forEach(row => {
                if (isRowVisible(row)) {
                    visibleTotalCount++;
                    const checkbox = row.querySelector('.doc-checkbox');
                    if (checkbox && checkbox.checked) {
                        visibleCheckedCount++;
                    }
                }
            });
            
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (visibleCheckedCount > 0) {
                bulkActionsBar.style.display = 'flex';
                selectedCount.textContent = visibleCheckedCount;
            } else {
                bulkActionsBar.style.display = 'none';
            }
            
            // Update select all checkbox state - only based on visible rows
            selectAllCheckbox.checked = visibleTotalCount > 0 && visibleCheckedCount === visibleTotalCount;
            selectAllCheckbox.indeterminate = visibleCheckedCount > 0 && visibleCheckedCount < visibleTotalCount;
        }

        // Delete selected documents - only delete visible checked documents
        async function deleteSelectedDocuments() {
            const allRows = document.querySelectorAll('#filesTableBody tr');
            const fileIds = [];
            
            // Only get file IDs from visible checked rows
            allRows.forEach(row => {
                if (isRowVisible(row)) {
                    const checkbox = row.querySelector('.doc-checkbox');
                    if (checkbox && checkbox.checked) {
                        fileIds.push(checkbox.value);
                    }
                }
            });
            
            if (fileIds.length === 0) {
                alert('No documents selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${fileIds.length} document(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/stage2/${proposalId}/delete-multiple-documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully deleted ${result.deletedCount} document(s)!`);
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Toggle select all checkboxes
        function toggleSelectAll(selectAllCheckbox) {
            const checkboxes = document.querySelectorAll('.doc-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateBulkActions();
        }

        // Update bulk actions bar visibility and count
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (checkboxes.length > 0) {
                bulkActionsBar.style.display = 'flex';
                selectedCount.textContent = checkboxes.length;
            } else {
                bulkActionsBar.style.display = 'none';
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.doc-checkbox');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }

        // Delete selected documents
        async function deleteSelectedDocuments() {
            const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
            const fileIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (fileIds.length === 0) {
                alert('No documents selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${fileIds.length} document(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/stage2/${proposalId}/delete-multiple-documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully deleted ${result.deletedCount} document(s)!`);
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Delete document function
        async function deleteDocument(fileId, fileName) {
            if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/stage2/${proposalId}/delete-document`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Document deleted successfully!');
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Pending documents tab functionality
        function showPendingTab(category) {
            const allPendingContent = document.querySelectorAll('.pending-category-content');
            const pendingTabBtns = document.querySelectorAll('.tab-btn-pending');
            
            // Update active tab button
            pendingTabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content by category
            allPendingContent.forEach(content => {
                const contentCategory = content.getAttribute('data-pending-category');
                content.style.display = contentCategory === category ? 'block' : 'none';
            });
        }

        // Main tab functionality (Uploaded vs Pending)
        function showMainTab(tabName) {
            const mainTabBtns = document.querySelectorAll('.main-tab-btn');
            const uploadedSection = document.getElementById('uploadedSection');
            const pendingSection = document.getElementById('pendingSection');
            
            // Update active button
            mainTabBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide sections
            if (tabName === 'uploaded') {
                uploadedSection.style.display = 'block';
                pendingSection.style.display = 'none';
            } else {
                uploadedSection.style.display = 'none';
                pendingSection.style.display = 'block';
            }
        }

        // Reprocess ALL documents to extract page counts and metadata
        async function reprocessAllDocuments() {
            if (!confirm('This will re-extract metadata (page counts, text) from all uploaded PDF documents. Continue?')) {
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Processing...';
            
            try {
                const response = await fetch(`/stage2/${proposalId}/reprocess-all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úì Successfully reprocessed ${result.processedCount} document(s)! Page counts and metadata have been updated.`);
                    window.location.reload();
                } else {
                    alert('Reprocess failed: ' + result.error);
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Reprocess All Documents';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Reprocess All Documents';
            }
        }

        // Reprocess incorporation documents to extract partnership deed details
        async function reprocessIncorporationDocs() {
            if (!confirm('This will re-extract information from all partnership deed PDFs. Continue?')) {
                return;
            }

            try {
                const response = await fetch(`/stage2/${proposalId}/reprocess-incorporation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('Reprocess result:', result);

                if (result.success) {
                    alert(`Successfully extracted data from ${result.processedCount} document(s)! Page will reload to show the results.`);

                    // Log extraction details to console
                    if (result.extractionResults && result.extractionResults.length > 0) {
                        console.log('Extraction Results:', result.extractionResults);
                    }

                    // Reload page immediately to show updated data
                    window.location.reload();
                } else {
                    alert('Reprocess failed: ' + result.error);
                }
            } catch (error) {
                console.error('Reprocess error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Extract debt profile from uploaded Excel files
        async function extractDebtProfile() {
            if (!confirm('This will extract loan details from Excel files in Debt Profile category. Continue?')) {
                return;
            }

            try {
                const response = await fetch(`/stage2/${proposalId}/extract-debt-profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('Debt profile extraction result:', result);

                if (result.success) {
                    alert(`Successfully extracted ${result.count} loan record(s)! Page will reload to show the results.`);
                    window.location.reload();
                } else {
                    alert('Extraction failed: ' + result.message);
                }
            } catch (error) {
                console.error('Debt profile extraction error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Edit debt profile entry
        async function editDebtProfile(id) {
            if (!id) {
                alert('Invalid profile ID');
                return;
            }

            // Fetch current data
            try {
                const response = await fetch(`/api/debt-profile/${id}`);
                if (!response.ok) {
                    alert('Error fetching profile: ' + response.status);
                    return;
                }

                const profile = await response.json();

                if (!profile.success) {
                    alert('Error fetching profile data: ' + (profile.message || 'Unknown error'));
                    return;
                }

                const data = profile.data;

                // Helper function to escape HTML
                const escapeHtml = (str) => {
                    if (str === null || str === undefined) return '';
                    return String(str).replace(/[&<>"']/g, (m) => ({
                        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                    })[m]);
                };

                // Create edit modal
                const modal = document.createElement('div');
                modal.id = 'editDebtModal';
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

                modal.innerHTML = `
                    <div style="background:white;padding:25px;border-radius:10px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;">
                        <h3 style="margin:0 0 20px 0;color:#1976d2;">Edit Loan Details</h3>
                        <form id="editDebtForm">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">Applicant</label>
                                    <input type="text" name="loanApplicant" id="edit_loanApplicant" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">Bank Name</label>
                                    <input type="text" name="bank" id="edit_bank" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">Loan Type</label>
                                    <input type="text" name="loanType" id="edit_loanType" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">Loan Amount</label>
                                    <input type="number" name="loanAmount" id="edit_loanAmount" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">EMI</label>
                                    <input type="number" name="emi" id="edit_emi" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">ROI %</label>
                                    <input type="number" step="0.01" name="roi" id="edit_roi" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">Sanction Date</label>
                                    <input type="text" name="sanctionDate" id="edit_sanctionDate" placeholder="DD/MM/YYYY" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">Tenure (Months)</label>
                                    <input type="number" name="tenure" id="edit_tenure" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">EMI Start Date</label>
                                    <input type="text" name="emiStartDate" id="edit_emiStartDate" placeholder="DD/MM/YYYY" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:500;">EMI End Date</label>
                                    <input type="text" name="emiEndDate" id="edit_emiEndDate" placeholder="DD/MM/YYYY" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;">
                                </div>
                            </div>
                            <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
                                <button type="button" onclick="closeEditModal()" style="padding:10px 20px;background:#9e9e9e;color:white;border:none;border-radius:4px;cursor:pointer;">Cancel</button>
                                <button type="submit" style="padding:10px 20px;background:#1976d2;color:white;border:none;border-radius:4px;cursor:pointer;">Save Changes</button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // Set values after DOM is created (avoids escaping issues)
                document.getElementById('edit_loanApplicant').value = data.loanApplicant || '';
                document.getElementById('edit_bank').value = data.bank || '';
                document.getElementById('edit_loanType').value = data.loanType || '';
                document.getElementById('edit_loanAmount').value = data.loanAmount || '';
                document.getElementById('edit_emi').value = data.emi || '';
                document.getElementById('edit_roi').value = data.roi || '';
                document.getElementById('edit_sanctionDate').value = data.sanctionDate || '';
                document.getElementById('edit_tenure').value = data.tenure || '';
                document.getElementById('edit_emiStartDate').value = data.emiStartDate || '';
                document.getElementById('edit_emiEndDate').value = data.emiEndDate || '';

                document.getElementById('editDebtForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const updateData = Object.fromEntries(formData.entries());

                    // Convert numeric fields
                    updateData.loanAmount = Number(updateData.loanAmount) || 0;
                    updateData.emi = Number(updateData.emi) || 0;
                    updateData.roi = Number(updateData.roi) || 0;
                    updateData.tenure = Number(updateData.tenure) || 0;

                    try {
                        const updateResponse = await fetch(`/api/debt-profile/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });

                        const result = await updateResponse.json();
                        if (result.success) {
                            alert('Loan details updated successfully!');
                            closeEditModal();
                            window.location.reload();
                        } else {
                            alert('Update failed: ' + (result.message || 'Unknown error'));
                        }
                    } catch (err) {
                        alert('Error updating: ' + err.message);
                    }
                };
            } catch (error) {
                console.error('Edit debt profile error:', error);
                alert('Error: ' + error.message);
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('editDebtModal');
            if (modal) modal.remove();
        }

        // Delete debt profile entry
        async function deleteDebtProfile(id) {
            if (!confirm('Are you sure you want to delete this loan entry?')) {
                return;
            }

            try {
                const response = await fetch(`/api/debt-profile/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    alert('Loan entry deleted successfully!');
                    window.location.reload();
                } else {
                    alert('Delete failed: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Update EMI bank statement verification
        async function updateEmiBankStatement(profileId, isProvided, accountNumber) {
            try {
                const response = await fetch(`/api/debt-profile/${profileId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        emiBankStatementProvided: isProvided,
                        emiBankAccountNumber: accountNumber
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    alert('Failed to update: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Show extraction details in a modal
        function showExtractionDetails(extractionResults) {
            console.log('showExtractionDetails called with:', extractionResults);
            
            let content = '<div style="max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 20px; border-radius: 8px;">';
            
            extractionResults.forEach((result, index) => {
                content += `<div style="margin-bottom: 30px; background: white; padding: 15px; border-radius: 5px; border-left: 4px solid ${result.error ? '#f44336' : '#4CAF50'};">`;
                content += `<h3 style="margin-top: 0; color: #333;">üìÑ ${result.fileName}</h3>`;
                
                if (result.error) {
                    content += `<p style="color: #f44336;"><strong>‚ùå Error:</strong> ${result.error}</p>`;
                } else {
                    content += `<p><strong>üîß Extraction Method:</strong> <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 3px;">${result.method}</span></p>`;
                    content += `<p><strong>üìù Text Length:</strong> ${result.textLength} characters</p>`;
                    content += `<p><strong>üìä Tables Found:</strong> ${result.tablesFound}</p>`;
                    
                    content += '<div style="margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 4px;">';
                    content += '<p style="margin-top: 0;"><strong>üéØ Extracted Data:</strong></p>';
                    content += '<pre style="background: #263238; color: #aed581; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;">';
                    content += JSON.stringify(result.extractedData, null, 2);
                    content += '</pre>';
                    content += '</div>';
                    
                    if (result.rawResponse) {
                        content += '<div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 4px;">';
                        content += '<p style="margin-top: 0;"><strong>ü§ñ Raw AI Response:</strong></p>';
                        content += '<pre style="background: #263238; color: #ffcc80; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;">';
                        content += JSON.stringify(result.rawResponse, null, 2);
                        content += '</pre>';
                        content += '</div>';
                    }
                }
                
                content += '</div>';
            });
            
            content += '</div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.setAttribute('role', 'dialog');
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            
            modalContent.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h2 style="margin: 0;">üîç Document Extraction Results</h2>
                    <button onclick="this.closest('[role=dialog]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
                </div>
                <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 80px);">
                    ${content}
                </div>
            `;
            
            modal.appendChild(modalContent);
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
            console.log('Modal appended to body');
        }

        // Reprocess ONLY banking documents to extract bank statement details
        async function reprocessBankingDocs() {
            const btn = event.target;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Processing...';

            try {
                const response = await fetch(`/stage2/${proposalId}/reprocess-banking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úì ${result.message}`);
                    window.location.reload();
                } else {
                    alert('Extraction failed: ' + result.error);
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // Reprocess financial documents to extract full text and detect components
        async function reprocessFinancialDocs() {
            const btn = event.target;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Processing Financial Documents...';

            try {
                const response = await fetch(`/stage2/${proposalId}/reprocess-financials`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    let message = `‚úì ${result.message}\n\n`;
                    if (result.extractionResults && result.extractionResults.length > 0) {
                        message += 'Components found:\n';
                        result.extractionResults.forEach(r => {
                            if (r.components) {
                                message += `\n${r.fileName}:\n`;
                                message += `  - ITR Acknowledgement: ${r.components.itrAck ? '‚úì' : '‚úó'}\n`;
                                message += `  - Computation: ${r.components.computation ? '‚úì' : '‚úó'}\n`;
                                message += `  - Balance Sheet: ${r.components.balanceSheet ? '‚úì' : '‚úó'}\n`;
                                message += `  - Profit & Loss: ${r.components.profitLoss ? '‚úì' : '‚úó'}\n`;
                            }
                        });
                    }
                    alert(message);
                    window.location.reload();
                } else {
                    alert('Extraction failed: ' + result.error);
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        async function proceedToStage3() {
            if (confirm('Complete Stage 2 and proceed to Customer Profiling?')) {
                try {
                    const response = await fetch(`/stage2/${proposalId}/complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = `/stage3/${proposalId}`;
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // Document preview functions
        let hideTimeout = null;
        
        function showPreview(filename, originalName, proposalId, buttonElement) {
            // Cancel any pending hide
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
            
            const preview = document.getElementById('documentPreview');
            const loader = document.getElementById('previewLoader');
            const iframe = document.getElementById('previewFrame');
            const image = document.getElementById('previewImage');
            const text = document.getElementById('previewText');
            
            // Reset all preview elements
            loader.style.display = 'block';
            iframe.style.display = 'none';
            image.style.display = 'none';
            text.style.display = 'none';
            
            // Get button position using getBoundingClientRect (gives viewport-relative coords)
            if (buttonElement) {
                const rect = buttonElement.getBoundingClientRect();
                const previewWidth = 600;
                const previewHeight = 500;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // Calculate position - place to the left of button if space, else center
                let leftPos = rect.left - previewWidth - 30;
                // Align top of preview with button position
                let topPos = rect.top;
                
                // If doesn't fit on left, center horizontally
                if (leftPos < 20) {
                    leftPos = (viewportWidth - previewWidth) / 2;
                    if (leftPos < 20) leftPos = 20;
                }
                
                // Ensure preview stays within viewport vertically
                if (topPos + previewHeight > viewportHeight - 20) {
                    topPos = viewportHeight - previewHeight - 20;
                }
                if (topPos < 20) {
                    topPos = 20;
                }
                
                // Apply position with fixed positioning
                preview.style.position = 'fixed';
                preview.style.left = leftPos + 'px';
                preview.style.top = topPos + 'px';
                preview.style.display = 'block';
            } else {
                // Fallback: center in viewport
                preview.style.position = 'fixed';
                preview.style.left = '50%';
                preview.style.top = '50%';
                preview.style.transform = 'translate(-50%, -50%)';
                preview.style.display = 'block';
            }
            
            // Determine file type from original name
            const ext = originalName.toLowerCase().split('.').pop();
            const fileUrl = `/uploads/${proposalId}/${filename}`;
            
            // Load appropriate preview based on file type
            if (ext === 'pdf') {
                // Add PDF viewer parameters to show single page without sidebar
                iframe.src = fileUrl + '#view=FitH&toolbar=0&navpanes=0&scrollbar=0';
                iframe.onload = function() {
                    loader.style.display = 'none';
                    iframe.style.display = 'block';
                };
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                image.src = fileUrl;
                image.onload = function() {
                    loader.style.display = 'none';
                    image.style.display = 'block';
                };
            } else {
                // For other file types, show file info
                text.innerHTML = `<strong>File:</strong> ${originalName}<br><strong>Type:</strong> ${ext.toUpperCase()}<br><br>Preview not available for this file type.<br><a href="${fileUrl}" target="_blank">Download to view</a>`;
                loader.style.display = 'none';
                text.style.display = 'block';
            }
        }

        function scheduleHidePreview() {
            hideTimeout = setTimeout(function() {
                hidePreview();
            }, 200);
        }
        
        function cancelHidePreview() {
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
        }
        
        function hidePreview() {
            const preview = document.getElementById('documentPreview');
            const iframe = document.getElementById('previewFrame');
            const image = document.getElementById('previewImage');
            
            preview.style.display = 'none';
            preview.style.transform = 'none';
            iframe.src = '';
            image.src = '';
        }

        // Classification dropdown functions
        const allDocTypesByCategory = <%- JSON.stringify(allDocTypesByCategory) %>;
        const pendingDocsByCategory = <%- JSON.stringify(pendingByCategory) %>;
        const existingClassifications = {};
        <% uploadedFiles.forEach(file => { %>
            existingClassifications['<%= file.id %>'] = '<%= file.classification || '' %>';
        <% }); %>
        
        // Populate classification dropdowns on page load
        function populateClassificationDropdowns() {
            const dropdowns = document.querySelectorAll('.classification-select');
            dropdowns.forEach(select => {
                const category = select.getAttribute('data-category');
                const fileId = select.getAttribute('data-file-id');
                const currentValue = existingClassifications[fileId] || '';
                
                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Get ALL document types for this category (not just pending)
                const docs = allDocTypesByCategory[category] || [];
                
                // Also include the current classification even if not in the list
                if (currentValue && !docs.includes(currentValue)) {
                    const option = document.createElement('option');
                    option.value = currentValue;
                    option.textContent = currentValue;
                    option.selected = true;
                    select.appendChild(option);
                }
                
                docs.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc;
                    option.textContent = doc;
                    // Mark if this is pending (not yet classified by any document)
                    if (pendingDocsByCategory[category] && pendingDocsByCategory[category].includes(doc)) {
                        option.textContent = '‚ö†Ô∏è ' + doc; // Indicate it's still pending
                    } else {
                        option.textContent = '‚úì ' + doc; // Indicate it's already assigned
                    }
                    if (doc === currentValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Add has-value class if there's a current value
                if (currentValue) {
                    select.classList.add('has-value');
                }
            });
        }
        
        async function updateClassification(fileId, classification) {
            try {
                const response = await fetch(`/stage2/${proposalId}/classify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileId, classification })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the local tracking
                    existingClassifications[fileId] = classification;
                    // Update the data-classification attribute on the row
                    const row = document.querySelector(`tr[data-file-id="${fileId}"]`);
                    if (row) {
                        row.setAttribute('data-classification', classification);
                    }
                    // Save scroll position before reload
                    const tableWrapper = document.getElementById('filesTableWrapper');
                    if (tableWrapper) {
                        sessionStorage.setItem('tableScrollLeft', tableWrapper.scrollLeft);
                    }
                    // Reload the page to update pending documents list
                    location.reload();
                } else {
                    alert('Error updating classification: ' + result.error);
                }
            } catch (error) {
                alert('Error updating classification: ' + error.message);
            }
        }
        
        // Initialize dropdowns when page loads
        document.addEventListener('DOMContentLoaded', function() {
            populateClassificationDropdowns();
            initTableAutoScroll();
            restoreTableScrollPosition();
            autoSaveEmiVerification();
        });

        // Auto-save EMI verification results to database
        async function autoSaveEmiVerification() {
            // Get data from hidden element
            const dataEl = document.getElementById('emiFoundData');
            if (!dataEl) return;

            try {
                const emiFoundData = JSON.parse(dataEl.value || '{}');

                for (const [profileId, data] of Object.entries(emiFoundData)) {
                    if (data.found) {
                        try {
                            await fetch(`/api/debt-profile/${profileId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    emiBankStatementProvided: true,
                                    emiBankAccountNumber: data.accountNumber || ''
                                })
                            });
                        } catch (error) {
                            console.error('Failed to auto-save EMI verification for profile:', profileId, error);
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to parse EMI found data:', e);
            }
        }
        
        // Restore table scroll position after page reload
        function restoreTableScrollPosition() {
            const savedScrollLeft = sessionStorage.getItem('tableScrollLeft');
            if (savedScrollLeft) {
                const tableWrapper = document.getElementById('filesTableWrapper');
                if (tableWrapper) {
                    // Use setTimeout to ensure the table is fully rendered
                    setTimeout(() => {
                        tableWrapper.scrollLeft = parseInt(savedScrollLeft);
                    }, 100);
                }
                // Clear the saved position
                sessionStorage.removeItem('tableScrollLeft');
            }
        }
        
        // Auto-scroll table when mouse is near edges
        function initTableAutoScroll() {
            const tableWrapper = document.getElementById('filesTableWrapper');
            if (!tableWrapper) return;
            
            let scrollInterval = null;
            const scrollSpeed = 8; // pixels per frame
            const edgeThreshold = 80; // pixels from edge to trigger scroll
            
            tableWrapper.addEventListener('mousemove', function(e) {
                const rect = tableWrapper.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const wrapperWidth = rect.width;
                const maxScrollLeft = tableWrapper.scrollWidth - tableWrapper.clientWidth;
                
                // Clear any existing scroll interval
                if (scrollInterval) {
                    clearInterval(scrollInterval);
                    scrollInterval = null;
                }
                
                // Check if mouse is near right edge
                if (mouseX > wrapperWidth - edgeThreshold && tableWrapper.scrollLeft < maxScrollLeft) {
                    const intensity = 1 - ((wrapperWidth - mouseX) / edgeThreshold);
                    scrollInterval = setInterval(() => {
                        tableWrapper.scrollLeft += scrollSpeed * intensity;
                        if (tableWrapper.scrollLeft >= maxScrollLeft) {
                            clearInterval(scrollInterval);
                            scrollInterval = null;
                        }
                    }, 16);
                }
                // Check if mouse is near left edge
                else if (mouseX < edgeThreshold && tableWrapper.scrollLeft > 0) {
                    const intensity = 1 - (mouseX / edgeThreshold);
                    scrollInterval = setInterval(() => {
                        tableWrapper.scrollLeft -= scrollSpeed * intensity;
                        if (tableWrapper.scrollLeft <= 0) {
                            clearInterval(scrollInterval);
                            scrollInterval = null;
                        }
                    }, 16);
                }
            });
            
            // When mouse leaves the wrapper, scroll to extreme right if leaving from right side
            tableWrapper.addEventListener('mouseleave', function(e) {
                if (scrollInterval) {
                    clearInterval(scrollInterval);
                    scrollInterval = null;
                }
                
                const rect = tableWrapper.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const wrapperWidth = rect.width;
                const maxScrollLeft = tableWrapper.scrollWidth - tableWrapper.clientWidth;
                
                // If mouse left from the right side, scroll to extreme right
                if (mouseX >= wrapperWidth - 20) {
                    tableWrapper.scrollTo({
                        left: maxScrollLeft,
                        behavior: 'smooth'
                    });
                }
                // If mouse left from the left side, scroll to extreme left
                else if (mouseX <= 20) {
                    tableWrapper.scrollTo({
                        left: 0,
                        behavior: 'smooth'
                    });
                }
            });
        }
    </script>
</body>
</html>
